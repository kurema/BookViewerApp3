/*!
 *                                                                                                                          (℠)
 *  # Bibi | EPUB Reader on your website.
 *
 *  * © Satoru Matsushima - https://bibi.epub.link or https://github.com/satorumurmur/bibi
 *  * Open source under the MIT License - https://github.com/satorumurmur/bibi/blob/master/LICENSE
 *
 *  * Including:
 *      - sML.js : © Satoru Matsushima - https://github.com/satorumurmur/sML / Licensed under the MIT License - https://github.com/satorumurmur/sML/blob/master/LICENSE
 *
 */!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=29)}({0:function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":n(window))&&(i=window)}e.exports=i},1:function(e,t,n){(function(t){var n=this;function i(e){throw new Error('"'+e+'" is read-only')}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(i){e.exports?e.exports=i:(void 0!==t?t:void 0!==n?n:self).sML=i}(function(){"use strict";var e,t,n,o,a,s,c,l,u,d,p,f,g={version:"1.0.28"},b=navigator.userAgent,h=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"$1";return e?(t=new RegExp("^.*"+e+"[ :\\/]?(\\d+([\\._]\\d+)*).*$")).test(b)?b.replace(t,n).replace(/_/g,".").split(".").map((function(e){return parseInt(e)||0})):[]:[]};return g.OperatingSystem=(e={},/Mac OS X/.test(b)?/\(iP(hone|ad|od touch);/.test(b)?e.iOS=h("CPU (iPhone )?OS","$2"):void 0!==document.ontouchend?e.iOS=e.iPadOS=h():/Mac OS X 10[\._]\d/.test(b)&&(e.macOS=h("Mac OS X ")):/Windows( NT)? \d/.test(b)?e.Windows=6!=(t=h("Windows( NT)?","$2"))[0]?t:t[1]>=3?[8,1]:t[1]>=2?[8]:t[1]>=1?[7]:t:/Android \d/.test(b)?e.Android=h("Android"):/CrOS/.test(b)?e.Chrome=h():/X11;/.test(b)?e.Linux=h():/Firefox/.test(b)&&(e.Firefox=h()),e),g.UserAgent=(n={},/ Gecko\/\d/.test(b)?(n.Gecko=h("rv"),/ Waterfox\/\d/.test(b)?n.Waterfox=h("Waterfox"):/ Firefox\/\d/.test(b)&&(n.Firefox=h("Firefox"))):/ Edge\/\d/.test(b)?n.EdgeHTML=n.Edge=h("Edge"):/ Chrom(ium|e)\/\d/.test(b)?(n.Blink=n.Chromium=function(e){return e[0]?e:h("Chrome")}(h("Chromium")),/ EdgA?\/\d/.test(b)?n.Edge=function(e){return e[0]?e:h("Edg")}(h("EdgA")):/ OPR\/\d/.test(b)?n.Opera=h("OPR"):/ Silk\/\d/.test(b)?n.Silk=h("Silk"):/ Vivaldi\/\d/.test(b)?n.Vivaldi=h("Vivaldi"):/ Phoebe\/\d/.test(b)?n.Phoebe=h("Phoebe"):n.Chrome=function(e){return e[0]?e:n.Chromium}(h("Chrome"))):/ AppleWebKit\/\d/.test(b)?(n.WebKit=h("AppleWebKit"),/ CriOS \d/.test(b)?n.Chrome=h("CriOS"):/ FxiOS \d/.test(b)?n.Firefox=h("FxiOS"):/ EdgiOS\/\d/.test(b)?n.Edge=h("EdgiOS"):/ Version\/\d/.test(b)&&(n.Safari=h("Version"))):/ Trident\/\d/.test(b)&&(n.Trident=h("Trident"),n.InternetExplorer=function(e){return e[0]?e:h("MSIE")}(h("rv"))),/[\[; ]FB(AN|_IAB)\//.test(b)&&(n.Facebook=h("FBAV")),/ Line\/\d/.test(b)&&(n.LINE=h("Line")),n),g.Environments=[g.OperatingSystem,g.UserAgent].reduce((function(e,t){for(var n in t)t[n]&&e.push(n);return e}),[]),Object.defineProperties(g,{OS:{get:function(){return g.OperatingSystem}},UA:{get:function(){return g.UserAgent}}}),g.forEach=function(e){return function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window||self,i=e.length,r=0;r<i&&"break"!=t.call(n,e[r],r,e);r++);}},g.replace=function(e,t){if(!(t[0]instanceof Array))return e.replace(t[0],t[1]);for(var n=t.length,i=0;i<n;i++)e=e.replace(t[i][0],t[i][1]);return e},g.capitalise=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},g.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},g.limitMin=function(e,t){return e<t?t:e},g.limitMax=function(e,t){return t<e?t:e},g.limitMinMax=function(e,t,n){return n<t?NaN:e<t?t:n<e?n:e},g.random=function(e,t){isNaN(e)&&isNaN(t)?(e=0,t=1):isNaN(e)?e=0:isNaN(t)&&(t=0);var n=Math.min(e,t),i=Math.max(e,t);return Math.floor(Math.random()*(i-n+1))+n},g.edit=function(e){var t=arguments.length<=1?0:arguments.length-1;if(e.tagName)for(var n=0;n<t;n++){var i=n+1<1||arguments.length<=n+1?void 0:arguments[n+1];for(var r in i)"data"!=r&&"on"!=r&&"style"!=r&&(e[r]=i[r]);if(i.data)for(var o in i.data)e.setAttribute("data-"+o,i.data[o]);if(i.on)for(var a in i.on)e.addEventListener(a,i.on[a]);i.style&&g.CSS.setStyle(e,i.style)}else for(var s=0;s<t;s++){var c=s+1<1||arguments.length<=s+1?void 0:arguments[s+1];for(var l in c)e[l]=c[l]}return e},g.create=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return g.edit.apply(g,[document.createElement(e)].concat(n))},g.hatch=function(e){var t=g.create("div",{innerHTML:e}),n=document.createDocumentFragment();return Array.prototype.forEach.call(t.childNodes,(function(){return n.appendChild(t.firstChild)})),n},g.clone=function(e){var t=new Function;return t.prototype=e,new t},g.apply=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;if(e.From&&e.To)if(t)for(var n in e.From)"function"!=typeof e.To[n]&&"function"!=typeof e.From[n]&&(e.To[n]=e.From[n]);else for(var i in e.From)e.To[i]=e.From[i];return e.To},g.applyLtR=function(e,t,n){return g.apply({From:e,To:t},n)},g.applyRtL=function(e,t,n){return g.apply({From:t,To:e},n)},g.replaceClass=function(e,t,n){return e.classList.contains(t)&&e.classList.remove(t),e.classList.add(n)},g.CSS={_get_sMLStyle_sheet:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document;return e.sMLStyle||(e.sMLStyle=e.createElement("style"),e.sMLStyle.appendChild(e.createTextNode("")),e.head.appendChild(e.sMLStyle)),e.sMLStyle.sheet},appendRule:function(e,t){var n=document;"string"!=typeof arguments[0]&&(n=arguments[0],e=arguments[1],t=arguments[2]);var i=this._get_sMLStyle_sheet(n);return i.insertRule((e instanceof Array?e.join(", "):e)+" { "+(t instanceof Array?t.join(" "):t)+" }",i.cssRules.length)},deleteRule:function(e){var t=document;"number"!=typeof arguments[0]&&(t=arguments[0],e=arguments[1]);var n=this._get_sMLStyle_sheet(t);if(n)return n.deleteRule(e)},setStyle:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(e instanceof Array)for(var r=e.length,o=0;o<r;o++){var a;(a=g.CSS).setStyle.apply(a,[e[o]].concat(n))}else for(var s=n.length,c=0;c<s;c++)for(var l in n[c])e.style[l]=n[c][l];return Promise.resolve()},_add_sMLTransitionEndListener:function(e,t){var n=this;e._sMLTransitionEndListener&&this._remove_sMLTransitionEndListener(e),e._sMLTransitionEndListener=function(i){return t.call(e,i)&&n._remove_sMLTransitionEndListener(e)},e.addEventListener("transitionend",e._sMLTransitionEndListener)},_remove_sMLTransitionEndListener:function(e){e._sMLTransitionEndListener&&(e.removeEventListener("transitionend",e._sMLTransitionEndListener),delete e._sMLTransitionEndListener)},setTransition:function(e){for(var t=this,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];if(e instanceof Array){for(var o=[],a=e.length,s=0;s<a;s++){var c;o.push((c=g.CSS).setTransition.apply(c,[e[s]].concat(i)))}return Promise.all(o)}return new Promise((function(n){for(var r=e.getAttribute("style"),o=[r?r.trim():""],a=i.length,s=0;s<a;s++)for(var c in i[s]){var l=i[s][c];""!==l?o.push(c+": "+l+";"):o[0]&&(o[0]=o[0].replace(new RegExp(c+"[ :\\-].+?(; *|$)","g"),"").trim())}t._add_sMLTransitionEndListener(e,(function(e){return n(e)})),e.style=o.join(" ")}))}},g.appendCSSRule=function(){return g.CSS.appendRule.apply(g.CSS,arguments)},g.deleteCSSRule=function(){return g.CSS.deleteRule.apply(g.CSS,arguments)},g.style=function(){return g.CSS.setStyle.apply(g.CSS,arguments)},g.transition=function(){return g.CSS.setTransition.apply(g.CSS,arguments)},g.Coords={getXY:function(e,t){return{X:e,Y:t}},getWidthHeight:function(e,t){return{Width:e,Height:t}},getScreenSize:function(){return this.getWidthHeight(screen.availWidth,screen.availHeight)},getScrollSize:function(e){return e&&e!=window&&e!=document||(e=document.documentElement),this.getWidthHeight(e.scrollWidth,e.scrollHeight)},getOffsetSize:function(e){return e&&e!=window||(e=document.documentElement),e==document?this.getScrollSize(document.documentElement):this.getWidthHeight(e.offsetWidth,e.offsetHeight)},getClientSize:function(e){return e&&e!=window||(e=document.documentElement),e==document?this.getScrollSize(document.documentElement):this.getWidthHeight(e.clientWidth,e.clientHeight)},getDocumentSize:function(){return this.getScrollSize(document.documentElement)},getWindowSize:function(){return this.getOffsetSize(document.documentElement)},getElementSize:function(e){return this.getOffsetSize(e)},getWindowCoord:function(e){return this.getXY(window.screenLeft||window.screenX,window.screenTop||window.screenY)},getElementCoord:function(e){for(var t=e.offsetLeft,n=e.offsetTop;e.offsetParent;)t+=(e=e.offsetParent).offsetLeft,n+=e.offsetTop;return this.getXY(t,n)},getScrollCoord:function(e){return e&&e!=window?this.getXY(e.scrollLeft,e.scrollTop):this.getXY(window.scrollX||window.pageXOffset||document.documentElement.scrollLeft,window.scrollY||window.pageYOffset||document.documentElement.scrollTop)},getScrollLimitCoord:function(e){e&&e!=window||(e=document.documentElement);var t=this.getScrollSize(e),n=this.getClientSize(e);return this.getXY(t.Width-n.Width,t.Height-n.Height)},getEventCoord:function(e){return e?this.getXY(e.pageX,e.pageY):this.getXY(0,0)},getCoord:function(e){var t,n;return e.tagName?(t=this.getElementCoord(e),n=this.getOffsetSize(e)):e==window?(t=this.getScrollCoord(),n=this.getOffsetSize(document.documentElement)):e==document?(t={X:0,Y:0},n=this.getScrollSize(document.documentElement)):e==screen&&(t={X:0,Y:0},n=this.getScreenSize()),{X:t.X,Y:t.Y,Top:t.Y,Right:t.X+n.Width,Bottom:t.Y+n.Height,Left:t.X,Width:n.Width,Height:n.Height}}},g.getCoord=function(){return g.Coords.getCoord.apply(g.Coords,arguments)},g.preventDefault=function(e){return e.preventDefault()},g.stopPropagation=function(e){return e.stopPropagation()},g.CustomEvents=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"sml",t=e+"EventListener",n=e+"BindedEventListeners",i=new RegExp("^"+e+":[\\w\\d\\-:]+$");return this.add=function(e,n){var o=this,a=document;return arguments.length>2&&(a=arguments[0],e=arguments[1],n=arguments[2]),a instanceof Array?a.forEach((function(t){return o.add(t,e,n)}))||n:e instanceof Array?e.forEach((function(e){return o.add(a,e,n)}))||n:n instanceof Array?n.forEach((function(t){return o.add(a,e,t)}))||n:!("object"!=r(a)||!i.test(e)||"function"!=typeof n)&&(n[t]||(n[t]=function(e){return n.call(a,e.detail)}),a.addEventListener(e,n[t],!1),n)},this.remove=function(e,n){var o=this,a=document;return arguments.length>2&&(a=arguments[0],e=arguments[1],n=arguments[2]),a instanceof Array?a.forEach((function(t){return o.remove(t,e,n)}))||n:e instanceof Array?e.forEach((function(e){return o.remove(a,e,n)}))||n:n instanceof Array?n.forEach((function(t){return o.remove(a,e,t)}))||n:!("object"!=r(a)||!i.test(e)||"function"!=typeof n)&&(a.removeEventListener(e,n[t]),n)},this.bind=function(e,t){var o=this,a=document;return arguments.length>2&&(a=arguments[0],e=arguments[1],t=arguments[2]),a instanceof Array?a.forEach((function(n){return o.bind(n,e,t)}))||t:e instanceof Array?e.forEach((function(e){return o.bind(a,e,t)}))||t:t instanceof Array?t.forEach((function(t){return o.bind(a,e,t)}))||t:!("object"!=r(a)||!i.test(e)||"function"!=typeof t)&&(a[n]||(a[n]={}),a[n][e]instanceof Array||(a[n][e]=[]),a[n][e]=a[n][e].filter((function(e){return e!=t})),a[n][e].push(t),t)},this.unbind=function(e,t){var o=this,a=document;return arguments.length>2&&(a=arguments[0],e=arguments[1],t=arguments[2]),a instanceof Array?a.forEach((function(n){return o.unbind(n,e,t)}))||t:e instanceof Array?e.forEach((function(e){return o.unbind(a,e,t)}))||t:t instanceof Array?t.forEach((function(t){return o.unbind(a,e,t)}))||t:!("object"!=r(a)||!i.test(e)||"function"!=typeof t)&&(!!(a[n]&&a[n][e]instanceof Array)&&(a[n][e]=a[n][e].filter((function(e){return e!=t})),t))},this.dispatch=function(e,t){var o=this,a=document;return arguments.length>2&&(a=arguments[0],e=arguments[1],t=arguments[2]),a instanceof Array?a.forEach((function(n){return o.dispatch(n,e,t)}))||t:e instanceof Array?e.forEach((function(e){return o.dispatch(a,e,t)}))||t:!("object"!=r(a)||!i.test(e))&&(a[n]&&a[n][e]instanceof Array&&a[n][e].forEach((function(e){return"function"==typeof e&&e.call(a,t)})),a.dispatchEvent(new CustomEvent(e,{detail:t})),t)},this},g.Scroller={scrollTo:function(e){var t,n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=e.Frame&&e.Frame instanceof HTMLElement?e.Frame:window,a={};if(o.sMLScrollerSetting?(a=o.sMLScrollerSetting).cancel():((a=o.sMLScrollerSetting={Frame:o}).scrollTo=a.Frame===window?function(e,t){return window.scrollTo(e,t)}:function(e,t){a.Frame.scrollLeft=e,a.Frame.scrollTop=t},a.cancel=function(){a.removeScrollCancelation(),a.oncanceled&&a.oncanceled()},a.addScrollCancelation=function(){return["keydown","mousedown","touchstart","wheel"].forEach((function(e){return a.Frame.addEventListener(e,a.cancel)}))},a.removeScrollCancelation=function(){return["keydown","mousedown","touchstart","wheel"].forEach((function(e){return a.Frame.removeEventListener(e,a.cancel)}))},a.preventUserScrolling=function(){return["keydown","mousedown","touchstart","wheel"].forEach((function(e){return a.Frame.addEventListener(e,g.preventDefault)}))},a.allowUserScrolling=function(){return["keydown","mousedown","touchstart","wheel"].forEach((function(e){return a.Frame.removeEventListener(e,g.preventDefault)}))}),e instanceof HTMLElement?a.Target=g.Coord.getElementCoord(e):a.Target="number"==typeof e?{Y:e}:e?{X:e.X,Y:e.Y}:{},a.Start=g.Coords.getScrollCoord(a.Frame),a.StartedOn=(new Date).getTime(),"number"!=typeof a.Target.X&&(a.Target.X=a.Start.X),"number"!=typeof a.Target.Y&&(a.Target.Y=a.Start.Y),a.Duration="number"==typeof i.Duration&&i.Duration>=0?i.Duration:100,!a.Duration)return a.scrollTo(a.Target.X,a.Target.Y),Promise.resolve();switch(r(i.ease)){case"function":a.ease=i.ease;break;case"string":a.ease=g.Easing[i.ease]?g.Easing[i.ease]:g.Easing.linear;break;default:a.ease=g.Easing.linear}return a.ForceScroll=i.ForceScroll,a.ForceScroll?(a.preventUserScrolling(),t=function(){return a.allowUserScrolling()}):(a.addScrollCancelation(),t=function(){return a.removeScrollCancelation()}),a.after=function(){clearTimeout(a.Timer),delete a.oncanceled,delete n.Scrolling,t()},new Promise((function(e,t){a.oncanceled=function(){a.after(),t()},a.resolve=function(){return e()},n.Scrolling=a,n.scrollInProgress()})).then((function(){a.scrollTo(a.Target.X,a.Target.Y),a.after()}))},scrollInProgress:function(){var e=this,t=this.Scrolling,n=(new Date).getTime()-t.StartedOn;if(t.Duration<=n)return t.resolve();var i=t.ease(n/t.Duration);t.scrollTo(Math.round(t.Start.X+(t.Target.X-t.Start.X)*i),Math.round(t.Start.Y+(t.Target.Y-t.Start.Y)*i)),t.Timer=setTimeout((function(){return e.scrollInProgress()}),g.limitMax(10,t.Duration-n))}},g.scrollTo=function(){return g.Scroller.scrollTo.apply(g.Scroller,arguments)},g.Easing=(o=Math.pow,a=Math.sqrt,s=Math.sin,c=Math.cos,l=Math.PI,d=(u=2*l/3)/1.5,f=function(e){return(e*=2.75)<1?o(e,2):e<2?o(e-1.5,2)+.75:e<2.5?o(e-2.25,2)+.9375:o(e-2.625,2)+.984375},{linear:function(e){return e},easeInSine:function(e){return 1-c(e*l/2)},easeOutSine:function(e){return s(e*l/2)},easeInOutSine:function(e){return(1-c(e*l))/2},easeInQuad:(p=function(e,t){switch(e){case"i":return function(e){return o(e,t)};case"o":return function(e){return 1-o(1-e,t)};case"io":return function(e){return((e*=2)<1?o(e,t):1-o(1-e,t))/2}}})("i",2),easeOutQuad:p("o",2),easeInOutQuad:p("io",2),easeInCubic:p("i",3),easeOutCubic:p("o",3),easeInOutCubic:p("io",3),easeInQuart:p("i",4),easeOutQuart:p("o",4),easeInOutQuart:p("io",4),easeInQuint:p("i",5),easeOutQuint:p("o",5),easeInOutQuint:p("io",5),easeInExpo:function(e){return e?o(2,10*--e):0},easeOutExpo:function(e){return 1==e?1:1-o(2,-10*e)},easeInOutExpo:function(e){return e?1==e?1:((e*=2)<1?o(2,10*--e):2-o(2,-10*--e))/2:0},easeInCirc:function(e){return 1-a(1-o(e,2))},easeOutCirc:function(e){return a(1-o(e-1,2))},easeInOutCirc:function(e){return((e*=2)<1?1-a(1-o(e,2)):1+a(1-o(e-2,2)))/2},easeInBack:function(e){return 2.70158*o(e,3)-1.70158*o(e,2)},easeOutBack:function(e){return 1+2.70158*o(e-1,3)+1.70158*o(e-1,2)},easeInOutBack:function(e){return((e*=2)<1?3.5949095*o(e,3)-2.5949095*o(e,2):2+3.5949095*o(e-2,3)+2.5949095*o(e-2,2))/2},easeInElastic:function(e){return e?1==e?1:-1*o(2,10*--e)*s((10*e-.75)*u):0},easeOutElastic:function(e){return e?1==e?1:1+o(2,-10*e)*s((10*e-.75)*u):0},easeInOutElastic:function(e){return e?1==e?1:((e*=2)<1?-1*o(2,10*--e)*s((10*e-1.125)*d):2+o(2,-10*--e)*s((10*e-1.125)*d))/2:0},easeInBounce:function(e){return 1-f(1-e)},easeOutBounce:function(e){return f(e)},easeInOutBounce:function(e){return((e*=2)<1?1-f(1-e):1+f(e-1))/2}}),g.Cookies={read:function(e){if("string"!=typeof e||!e)return"";e=encodeURIComponent(e);for(var t=document.cookie.split("; "),n="",i=t.length,r=0;r<i;r++)if(t[r].substr(0,e.length+1)==e+"="){n=t[r].substr(e.length+1,t[r].length);break}return decodeURIComponent(n)},write:function(e,t,n){var i=new Date;return!(!e||"string"!=typeof e||"string"!=typeof t)&&("object"!=r(n)&&(n={}),e=encodeURIComponent(e),t=encodeURIComponent(t),n.Path="string"==typeof n.Path?n.Path:location.pathname.replace(/[^\/]+$/,""),n.Expires="number"==typeof n.Expires?n.Expires:864e5,document.cookie=[e+"="+t,"path="+n.Path,"expires="+i.toGMTString(i.setTime(i.getTime()+n.Expires))].join("; "),document.cookie)}},g.Ranges={selectRange:function(e){if(!e)return null;var t=window.getSelection();return t.removeAllRanges(),t.addRange(e),e},getRange:function(){var e="object"==r(arguments[0])?arguments[0]:this._searchSidesOfText.apply(this,arguments);if(!e)return null;var t=e.Start.Node.ownerDocument.createRange();return t.setStart(e.Start.Node,"number"==typeof e.Start.Index?e.Start.Index:e.Start.Node.textContent.indexOf(e.Start.Text)),t.setEnd(e.End.Node,"number"==typeof e.End.Index?e.End.Index:e.End.Node.textContent.indexOf(e.End.Text)+e.End.Text.length),t},_searchSidesOfText:function(e,t){if(t||(t=document.body),"string"!=typeof e||!e||this._flat(t.textContent).indexOf(e)<0)return null;if(3==t.nodeType)return{Start:{Node:t,Text:e},End:{Node:t,Text:e}};for(var n=[],r={},o=0,a=t.childNodes.length-1,s="",c=0;c<=a;c++){if(this._flat(t.childNodes[c].textContent).indexOf(e)>=0)return this._searchSidesOfText(e,t.childNodes[c]);n.push(t.childNodes[c].textContent)}for(s=this._distill(n,o+1,a);s&&this._flat(s).indexOf(e)>=0;)o++,s=this._distill(n,o+1,a);var l=t.childNodes[o],u=0,d="",p=l.textContent.length-1;for(s=this._distill(l.textContent,u,p);this._flat(s)&&!new RegExp("^"+this._escape(this._flat(s))).test(e);)u++,s=this._distill(l.textContent,u,p);for(d=this._flat(s);3!=l.nodeType;)i("F"),l=(r=this._find(d,l)).Start.Node,d=r.Start.Text;for(s=this._distill(n,o,a-1);s&&this._flat(s).indexOf(e)>=0;)a--,s=this._distill(n,o,a-1);var f=t.childNodes[a],g="",b=f.textContent.length-1;for(s=this._distill(f.textContent,0,b);this._flat(s)&&!new RegExp(this._escape(this._flat(s))+"$").test(e);)b--,s=this._distill(f.textContent,0,b);for(g=this._flat(s);3!=f.nodeType;)i("F"),f=(r=this._searchSidesOfText(g,f)).End.Node,g=r.End.Text;return{Start:{Node:l,Text:d},End:{Node:f,Text:g}}},_flat:function(e){return e.replace(/[\r\n]/g,"")},_escape:function(e){return e.replace(/([\(\)\{\}\[\]\,\.\-\+\*\?\!\:\^\$\/\\])/g,"\\$1")},_distill:function(e,t,n){for(var i="",r=t;r<=n;r++)i+=e[r];return i}},g.Fullscreen={polyfill:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window||self,t=e.document,n=e.Element.prototype;if(void 0===t.fullscreenEnabled){if("function"!=typeof Promise)throw new Error("sML.Fullscreen.polyfill requires Promise.");var i=t.webkitFullscreenEnabled?"webkit":t.msFullscreenEnabled?"ms":"";switch(i){case"webkit":t.addEventListener("webkitfullscreenchange",(function(){return t.dispatchEvent(new Event("fullscreenchange",{bubbles:!0,cancelable:!1}))}));break;case"ms":t.onmsfullscreenchange=function(){return t.dispatchEvent((e=t.createEvent("Event")).initEvent("fullscreenchange",!0,!1)||e);var e};break;default:return t.fullscreenEnabled=!1,t.fullscreenElement=null,void(t.exitFullscreen=n.requestFullscreen=function(){return Promise.reject()})}Object.defineProperties(t,{fullscreenEnabled:{get:function(){return t[i+"FullscreenEnabled"]}},fullscreenElement:{get:function(){return t[i+"FullscreenElement"]}}}),t.exitFullscreen=function(){var e=arguments,n=this;return new Promise((function(r,o){if(!t.fullscreenElement)return o();t.addEventListener("fullscreenchange",(function e(n){r(n),t.removeEventListener("fullscreenchange",e)})),n[i+"ExitFullscreen"].apply(n,e)}))},n.requestFullscreen=function(){var e=arguments,n=this;return new Promise((function(r,o){if(t.fullscreenElement)return o();t.addEventListener("fullscreenchange",(function e(n){r(n),t.removeEventListener("fullscreenchange",e)})),n[i+"RequestFullscreen"].apply(n,e)}))}}}},g}())}).call(this,n(0))},29:function(e,t,n){"use strict";n.r(t);var i=n(1),r=n.n(i),o=n(9);for(var a in self.sML=r.a,o)self[a]=o[a];n(30),document.addEventListener("DOMContentLoaded",(function(){Bibi.Script=document.getElementById("bibi-script"),function(e){if(!window.Promise)return document.head.insertBefore(r.a.create("script",{className:"bibi-polyfill",src:Bibi.Script.src.replace(/\/bibi\.js$/,"/polyfills/bundle.js"),onload:e}),Bibi.Script);var t=[],n=new URL("./polyfills",Bibi.Script.src).href;if(window.TextDecoder||t.push(n+"/encoding.js"),window.IntersectionObserver||t.push(n+"/intersection-observer.js"),!t.length)return e();var i=[];t.forEach((function(e){return i.push(new Promise((function(t){return document.head.insertBefore(r.a.create("script",{className:"bibi-polyfill",src:e,onload:t}),Bibi.Script)})))})),Promise.all(i).then(e)}((function(){for(var e="",t=Bibi.Script.nextElementSibling;t;){if(/^style$/i.test(t.tagName)&&/^\/\*! Bibi Book Style \*\//.test(t.textContent)){e=t.textContent.replace(/\/*.*?\*\//g,"").trim(),t.innerHTML="",document.head.removeChild(t);break}t=t.nextElementSibling}if(Bibi.BookStyleURL=URL.createObjectURL(new Blob([e],{type:"text/css"})),r.a.UA.Trident){var n=document.head.querySelectorAll("#bibi-style, #bibi-dress");document.documentElement.style.display="none",r.a.forEach(n)((function(e){e.OriginalHref=e.getAttribute("href"),e.href=""})),setTimeout((function(){r.a.forEach(n)((function(e){e.href=e.OriginalHref,delete e.OriginalHref})),document.documentElement.style.display="",Bibi.hello()}),0)}else Bibi.hello()}))}))},3:function(e,t,n){"use strict";var i,r=function(){return void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i},o=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}(),a=[];function s(e){for(var t=-1,n=0;n<a.length;n++)if(a[n].identifier===e){t=n;break}return t}function c(e,t){for(var n={},i=[],r=0;r<e.length;r++){var o=e[r],c=t.base?o[0]+t.base:o[0],l=n[c]||0,u="".concat(c," ").concat(l);n[c]=l+1;var d=s(u),p={css:o[1],media:o[2],sourceMap:o[3]};-1!==d?(a[d].references++,a[d].updater(p)):a.push({identifier:u,updater:h(p,t),references:1}),i.push(u)}return i}function l(e){var t=document.createElement("style"),i=e.attributes||{};if(void 0===i.nonce){var r=n.nc;r&&(i.nonce=r)}if(Object.keys(i).forEach((function(e){t.setAttribute(e,i[e])})),"function"==typeof e.insert)e.insert(t);else{var a=o(e.insert||"head");if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(t)}return t}var u,d=(u=[],function(e,t){return u[e]=t,u.filter(Boolean).join("\n")});function p(e,t,n,i){var r=n?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(e.styleSheet)e.styleSheet.cssText=d(t,r);else{var o=document.createTextNode(r),a=e.childNodes;a[t]&&e.removeChild(a[t]),a.length?e.insertBefore(o,a[t]):e.appendChild(o)}}function f(e,t,n){var i=n.css,r=n.media,o=n.sourceMap;if(r?e.setAttribute("media",r):e.removeAttribute("media"),o&&btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),e.styleSheet)e.styleSheet.cssText=i;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(i))}}var g=null,b=0;function h(e,t){var n,i,r;if(t.singleton){var o=b++;n=g||(g=l(t)),i=p.bind(null,n,o,!1),r=p.bind(null,n,o,!0)}else n=l(t),i=f.bind(null,n,t),r=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else r()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=r());var n=c(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var i=0;i<n.length;i++){var r=s(n[i]);a[r].references--}for(var o=c(e,t),l=0;l<n.length;l++){var u=s(n[l]);0===a[u].references&&(a[u].updater(),a.splice(u,1))}n=o}}}},30:function(e,t,n){var i=n(3),r=n(31);"string"==typeof(r=r.__esModule?r.default:r)&&(r=[[e.i,r,""]]);var o={insert:"head",singleton:!1};i(r,o);e.exports=r.locals||{}},31:function(e,t,n){(t=n(4)(!1)).push([e.i,"/*! Bibi Book Style */body,html{margin:0;padding:0;border:0}html img.bibi-spine-item-image{display:block;margin:0;border:0;padding:0;width:auto;height:auto}html.bibi-columned iframe,html.bibi-columned image,html.bibi-columned img,html.bibi-columned picture,html.bibi-columned svg,html.bibi-columned video{-webkit-column-break-inside:avoid;page-break-inside:avoid;break-inside:avoid}html.bibi-flick-active.bibi-flick-hot{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}html.bibi-flick-active img{pointer-events:none}html.bibi-with-gutters>head{display:block}html.bibi-with-gutters>head>:not(bibi-neck){display:none}html.bibi-with-gutters>head>bibi-neck{display:block;position:relative;z-index:-99999999999;margin:0;border:0;padding:0}html.bibi-with-gutters>head>bibi-neck>bibi-throat{display:block;float:left;margin:0;border:0;padding:0}",""]),e.exports=t},4:function(e,t,n){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=function(e,t){var n=e[1]||"",i=e[3];if(!i)return n;if(t&&"function"==typeof btoa){var r=(a=i,s=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),"/*# ".concat(c," */")),o=i.sources.map((function(e){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(e," */")}));return[n].concat(o).concat([r]).join("\n")}var a,s,c;return[n].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},t.i=function(e,n,i){"string"==typeof e&&(e=[[null,e,""]]);var r={};if(i)for(var o=0;o<this.length;o++){var a=this[o][0];null!=a&&(r[a]=!0)}for(var s=0;s<e.length;s++){var c=[].concat(e[s]);i&&r[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),t.push(c))}},t}},9:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Bibi",(function(){return Bibi})),__webpack_require__.d(__webpack_exports__,"B",(function(){return B})),__webpack_require__.d(__webpack_exports__,"L",(function(){return L})),__webpack_require__.d(__webpack_exports__,"R",(function(){return R})),__webpack_require__.d(__webpack_exports__,"I",(function(){return I})),__webpack_require__.d(__webpack_exports__,"P",(function(){return P})),__webpack_require__.d(__webpack_exports__,"U",(function(){return U})),__webpack_require__.d(__webpack_exports__,"S",(function(){return S})),__webpack_require__.d(__webpack_exports__,"C",(function(){return C})),__webpack_require__.d(__webpack_exports__,"O",(function(){return O})),__webpack_require__.d(__webpack_exports__,"E",(function(){return E})),__webpack_require__.d(__webpack_exports__,"M",(function(){return M})),__webpack_require__.d(__webpack_exports__,"X",(function(){return X}));var _arguments=arguments;function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var n,i=_getPrototypeOf(e);if(t){var r=_getPrototypeOf(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return _possibleConstructorReturn(this,n)}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _wrapNativeSuper(e){var t="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(n,e)})(e)}function _construct(e,t,n){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&_setPrototypeOf(r,n.prototype),r}).apply(null,arguments)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Bibi={version:"1.1.1",href:"https://bibi.epub.link",Status:"",TimeOrigin:Date.now(),SettingTypes:{boolean:["allow-placeholders","prioritise-fallbacks"],"yes-no":["autostart","autostart-embedded","fix-nav-ttb","fix-reader-view-mode","flip-pages-during-sliding","full-breadth-layout-in-scroll","start-embedded-in-new-window","use-arrows","use-bookmarks","use-font-size-changer","use-full-height","use-history","use-keys","use-loupe","use-menubar","use-nombre","use-slider","zoom-out-for-utilities"],string:["book","default-page-progression-direction","pagination-method","reader-view-mode"],integer:["item-padding-bottom","item-padding-left","item-padding-right","item-padding-top","spread-gap","spread-margin"],number:["base-font-size","flipper-width","font-size-scale-per-step","loupe-max-scale","loupe-scale-per-step","orientation-border-ratio"],array:["content-draggable","orthogonal-edges","orthogonal-arrow-keys","orthogonal-touch-moves","orthogonal-wheelings"]},SettingTypes_PresetOnly:{boolean:["accept-base64-encoded-data","accept-blob-converted-data","allow-scripts-in-content","remove-bibi-website-link"],"yes-no":["accept-local-file","keep-settings","resume-from-last-position"],string:["bookshelf"],integer:["max-bookmarks","max-history"],number:[],array:["extensions","extract-if-necessary","trustworthy-origins"]},SettingTypes_UserOnly:{boolean:["debug","wait","zine"],"yes-no":[],string:["epubcfi","bibidi"],integer:["log","nav","parent-bibi-index"],number:["iipp","sipp"],array:[]},verifySettingValue:function(e,t,n,i){return Bibi.verifySettingValue[e](t,n,i)}};(function(e){for(var t in e)Bibi.verifySettingValue[t]=e[t]})({boolean:function(e,t,n){return"boolean"==typeof t?t:"true"===t||"1"===t||1===t||"false"!==t&&"0"!==t&&0!==t&&(!n&&void 0)},"yes-no":function(e,t,n){return/^(yes|no|mobile|desktop)$/.test(t)?t:"true"===t||"1"===t||1===t?"yes":"false"===t||"0"===t||0===t||n?"no":void 0},string:function(e,t,n){if("string"==typeof t){switch(e){case"bibidi":return R.getBibiToDestination(t)||void 0;case"book":return decodeURIComponent(t).trim()||void 0;case"default-page-progression-direction":return/^(ltr|rtl)$/.test(t)?t:"ltr";case"pagination-method":return"x"==t?t:"auto";case"reader-view-mode":return/^(paged|horizontal|vertical)$/.test(t)?t:"paged"}return t}if(n)return""},integer:function(e,t,n){if("number"==typeof(t*=1)&&isFinite(t)){switch(t=Math.max(Math.round(t),0),e){case"log":case"max-bookmarks":return Math.min(t,9);case"max-history":return Math.min(t,19)}return t}if(n)return 0},number:function(e,t,n){return"number"==typeof(t*=1)&&isFinite(t)&&t>=0?t:n?0:void 0},array:function(e,t,n){if(Array.isArray(t)){switch(e){case"content-draggable":t.length=2;for(var i=0;i<2;i++)t[i]=!1!==t[i]&&"false"!==t[i]&&"0"!==t[i]&&0!==t[i];return t;case"extensions":return t.filter((function(e){return"string"==typeof e.src&&(e.src=e.src.trim())}));case"extract-if-necessary":return(t=t.map((function(e){return"string"==typeof e?e.trim().toLowerCase():""}))).includes("*")?["*"]:t.filter((function(e){return/^(\.[\w\d]+)*$/.test(e)}));case"orthogonal-arrow-keys":case"orthogonal-edges":case"orthogonal-touch-moves":case"orthogonal-wheelings":t.length=2;for(var r=0;r<2;r++)t[r]="string"==typeof t[r]?t[r]:"";return t;case"trustworthy-origins":return t.reduce((function(e,t){return!("string"!=typeof t||!/^https?:\/\/[^\/]+$/.test(t=t.trim().replace(/\/$/,""))||e.includes(t))&&(e.push(t)&&e)}),[])}return t.filter((function(e){return"function"!=typeof e}))}if(n)return[]}}),Bibi.applyFilteredSettingsTo=function(e,t,n,i){return n.forEach((function(n){var r=function(r){n[r].forEach((function(n){var o=Bibi.verifySettingValue[r](n,t[n]);i?(e[n]=Bibi.verifySettingValue[r](n,e[n]),void 0===o&&void 0!==e[n]||(e[n]=Bibi.verifySettingValue[r](n,t[n],!0))):t.hasOwnProperty(n)&&void 0!==o&&(e[n]=o)}))};for(var o in n)r(o)})),e},Bibi.at1st=function(){return Bibi.at1st.List.forEach((function(e){return"function"!=typeof e||e()}))},Bibi.at1st.List=[],Bibi.hello=function(){return new Promise((function(e){Bibi.at1st(),O.log.initialize(),O.log("Hello!","<b:>"),O.log("[ja] ".concat(Bibi.href)),O.log("[en] https://github.com/satorumurmur/bibi"),e()})).then(Bibi.initialize).then(Bibi.loadExtensions).then(Bibi.ready).then(Bibi.getBookData).then(Bibi.loadBook).then(Bibi.bindBook).then(Bibi.openBook).catch((function(e){throw I.note(e,99999999999,"ErrorOccured"),e}))},Bibi.initialize=function(){var e,t;O.Origin=location.origin||location.protocol+"//"+(location.host||location.hostname+(location.port?":"+location.port:"")),O.RequestedURL=location.href,O.BookURL=O.Origin+location.pathname+location.search,O.contentWindow=window,O.contentDocument=document,O.HTML=document.documentElement,O.Head=document.head,O.Body=document.body,O.Info=document.getElementById("bibi-info"),O.Title=document.getElementsByTagName("title")[0],(e=O.HTML.classList).add.apply(e,_toConsumableArray(sML.Environments).concat(["Bibi","welcome"])),(O.TouchOS=!(!sML.OS.iOS&&!sML.OS.Android))&&(O.HTML.classList.add("touch"),sML.OS.iOS&&(O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-capable",content:"yes"})),O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-status-bar-style",content:"white"})))),Bibi.Dev&&O.HTML.classList.add("dev"),Bibi.Debug&&O.HTML.classList.add("debug"),O.HTML.classList.add("default-lang-"+(O.Language=function(e){Array.isArray(navigator.languages)&&(e=e.concat(navigator.languages)),navigator.language&&navigator.language!=e[0]&&e.unshift(navigator.language);for(var t=e.length,n=0;n<t;n++){var i=e[n].split?e[n].split("-")[0]:"";if("ja"==i)return"ja";if("en"==i)break}return"en"}([]))),E.initialize(),O.Biscuits.initialize(),R.initialize(),I.initialize(),B.initialize(),P.initialize(),U.initialize(),S.initialize(),O.Embedded=function(){if(window.parent==window)return O.HTML.classList.add("window-direct"),0;O.HTML.classList.add("window-embedded");try{if(location.host==parent.location.host||parent.location.href)return 1}catch(e){}return-1}(),O.ParentBibi=1==O.Embedded&&"number"==typeof S["parent-bibi-index"]&&window.parent["bibi:jo"].Bibis[S["parent-bibi-index"]]||null,O.ParentOrigin=O.ParentBibi?window.parent.location.origin:"",O.FullscreenTarget=(t=(O.Embedded?O.ParentBibi?(sML.Fullscreen.polyfill(window.parent),O.ParentBibi.Frame):void 0:(sML.Fullscreen.polyfill(window),O.HTML))||null)&&t.ownerDocument.fullscreenEnabled?(O.HTML.classList.add("fullscreen-enabled"),t):(O.HTML.classList.add("fullscreen-disabled"),null),O.ParentBibi&&(O.ParentBibi.Window=window,O.ParentBibi.Document=document,O.ParentBibi.HTML=O.HTML,O.ParentBibi.Body=O.Body,["bibi:initialized","bibi:readied","bibi:prepared","bibi:opened"].forEach((function(e){return E.add(e,(function(t){return O.ParentBibi.dispatch(e,t)}))}))),!sML.UA.Trident||sML.UA.Trident[0]>=7?I.note('<span class="non-visual">Welcome!</span>'):(I.note("Your Browser Is Not Compatible",99999999999,"ErrorOccured"),O.error(I.Veil.byebye({en:"<span>Sorry....</span> <span>Your Browser Is</span> <span>Not Compatible.</span>",ja:"<span>大変申し訳ありません。</span> <span>お使いのブラウザでは、</span><span>動作しません。</span>"}))),O.WritingModeProperty=(n=getComputedStyle(O.HTML),/^(vertical|horizontal)-/.test(n["writing-mode"])||sML.UA.Trident?"writing-mode":/^(vertical|horizontal)-/.test(n["-webkit-writing-mode"])?"-webkit-writing-mode":/^(vertical|horizontal)-/.test(n["-epub-writing-mode"])?"-epub-writing-mode":void 0);var n,i=O.Body.appendChild(sML.create("div",{id:"bibi-style-checker",innerHTML:" aAａＡあ亜　",style:{width:"auto",height:"auto",left:"-1em",top:"-1em"}}));O.VerticalTextEnabled=i.offsetWidth<i.offsetHeight,O.DefaultFontSize=Math.min(i.offsetWidth,i.offsetHeight),i.style.fontSize="0.01px",O.MinimumFontSize=Math.min(i.offsetWidth,i.offsetHeight),i.setAttribute("style",""),i.innerHTML="",I.Slider.Size=S["use-slider"]?i.offsetWidth:0,I.Menu.Height=S["use-menubar"]?i.offsetHeight:0,document.body.removeChild(i),O.Body.style.width="101vw",O.Body.style.height="101vh",O.Scrollbars={Width:window.innerWidth-O.HTML.offsetWidth,Height:window.innerHeight-O.HTML.offsetHeight},O.HTML.style.width=O.Body.style.width="100%",O.Body.style.height="",O.HTML.classList.toggle("book-full-height",S["use-full-height"]),O.HTML.classList.remove("welcome"),E.dispatch("bibi:initialized",Bibi.Status=Bibi.Initialized="Initialized")},Bibi.loadExtensions=function(){return new Promise((function(e,t){var n=[];S["allow-scripts-in-content"]||n.push("sanitizer.js");var i=!1,r=!1;S.book?(O.isToBeExtractedIfNecessary(S.book)&&(i=!0),"Zine"==B.Type&&(r=!0)):(S["accept-local-file"]||S["accept-blob-converted-data"])&&(i=r=!0),r&&n.unshift("zine.js"),(i?(S.book?O.tryRangeRequest().then((function(){return"on-the-fly"})):Promise.reject()).catch((function(){return"at-once"})).then((function(e){return n.unshift("extractor/"+e+".js")})):Promise.resolve()).then((function(){if(n.length&&n.forEach((function(e){return S.extensions.unshift({src:new URL("../../extensions/"+e,Bibi.Script.src).href})})),0==S.extensions.length)return t();O.log("Loading Extension".concat(S.extensions.length>1?"s":"","..."),"<g:>");!function t(n){X.load(S.extensions[n]).then((function(e){})).catch((function(e){O.log(e)})).then((function(){S.extensions[n+1]?t(n+1):e()}))}(0)}))})).then((function(){O.log("Extensions: %O",X.Extensions),O.log(X.Extensions.length?"Loaded. (".concat(X.Extensions.length," Extension").concat(X.Extensions.length>1?"s":"",")"):"No Extension.","</g>")})).catch((function(){return!1}))},Bibi.ready=function(){return new Promise((function(e){O.HTML.classList.add("ready"),O.ReadiedURL=location.href,E.add("bibi:readied",e),setTimeout((function(){return E.dispatch("bibi:readied",Bibi.Status=Bibi.Readied="Readied")}),O.TouchOS&&!O.Embedded?1234:0)})).then((function(){O.HTML.classList.remove("ready")}))},Bibi.getBookData=function(){return B.Data?Promise.resolve({BookData:B.Data,BookDataType:B.DataType}):S.book?Promise.resolve({BookData:S.book}):S["accept-local-file"]?new Promise((function(e){Bibi.getBookData.resolve=function(t){e(t),O.HTML.classList.remove("waiting-file")},O.HTML.classList.add("waiting-file")})):Promise.reject("Tell me EPUB name via ".concat(O.Embedded?"embedding tag":"URI","."))},Bibi.busyHerself=function(){return new Promise((function(e){O.Busy=!0,O.HTML.classList.add("busy"),O.HTML.classList.add("loading"),window.addEventListener(E.resize,R.resetBibiHeight),Bibi.busyHerself.resolve=function(){e(),delete Bibi.busyHerself}})).then((function(){window.removeEventListener(E.resize,R.resetBibiHeight),O.Busy=!1,O.HTML.classList.remove("busy"),O.HTML.classList.remove("loading")}))},Bibi.loadBook=function(e){return Promise.resolve().then((function(){return Bibi.busyHerself(),I.note("Loading..."),O.log("Initializing Book...","<g:>"),L.initializeBook(e).then((function(e){O.log("".concat(e,": %O"),B),O.log("Initialized.","</g>")}))})).then((function(){S.update(),R.updateOrientation(),R.resetStage()})).then((function(){return O.log("Creating Cover...","<g:>"),B.CoverImageItem?(O.log("Cover Image: %O",B.CoverImageItem),O.log("Will Be Created.","</g>")):O.log("Will Be Created. (w/o Image)","</g>"),L.createCover()})).then((function(){return B.NavItem?(O.log("Loading Navigation...","<g:>"),L.loadNavigation().then((function(e){O.log("".concat(B.NavItem.NavType,": %O"),B.NavItem),O.log("Loaded.","</g>"),E.dispatch("bibi:loaded-navigation",B.NavItem)}))):O.log("No Navigation.")})).then((function(){if(E.dispatch("bibi:prepared",Bibi.Status=Bibi.Prepared="Prepared"),!S.autostart&&!L.Played)return L.wait()})).then((function(){return L.preprocessResources()})).then((function(){O.log("Loading Items in Spreads...","<g:>");var e=[],t={TargetSpreadIndex:0,Destination:{Edge:"head"},resetter:function(){t.Reset=!0,t.removeResetter()},addResetter:function(){window.addEventListener("resize",t.resetter)},removeResetter:function(){window.removeEventListener("resize",t.resetter)}};if("object"==_typeof(R.StartOn)){var n="object"==_typeof(R.StartOn.Item)?R.StartOn.Item:function(){if("number"==typeof R.StartOn.IIPP){var e=Math.floor(R.StartOn.IIPP);if(e>=R.Items.length){var t=R.StartOn.IIPP-e;e=R.Items.length-1,R.StartOn.IIPP=e+t}return R.Items[e]}if("number"==typeof R.StartOn.ItemIndex)return R.StartOn.ItemIndex>=R.Items.length&&(R.StartOn.ItemIndex=R.Items.length-1),R.Items[R.StartOn.ItemIndex];if("number"==typeof R.StartOn.ItemIndexInSpine){R.StartOn.ItemIndexInSpine>=B.Package.Spine.Items.length&&(R.StartOn.ItemIndexInSpine=B.Package.Spine.Items.length-1);var n=B.Package.Spine.Items[R.StartOn.ItemIndexInSpine];if(n.Spread)return n;R.StartOn={ItemIndex:0}}}();t.TargetSpreadIndex=n&&n.Spread?n.Spread.Index:0,t.Destination=R.StartOn}t.addResetter();var i=0;return R.Spreads.forEach((function(n){return e.push(new Promise((function(e){return L.loadSpread(n,{AllowPlaceholderItems:S["allow-placeholders"]&&n.Index!=t.TargetSpreadIndex}).then((function(){i+=n.Items.length,I.note("Loading... (".concat(i,"/").concat(R.Items.length," Items Loaded.)")),t.Reset?e():R.layOutSpread(n).then(e)}))})))})),Promise.all(e).then((function(){return O.log("Loaded. (".concat(R.Items.length," in ").concat(R.Spreads.length,")"),"</g>"),t}))}))},Bibi.bindBook=function(e){return e.Reset||(R.organizePages(),R.layOutStage()),R.layOut(e).then((function(){return e.removeResetter(),E.dispatch("bibi:laid-out-for-the-first-time",e),e}))},Bibi.openBook=function(e){return new Promise((function(e){Bibi.busyHerself.resolve(),I.Veil.close(),L.Opened=!0,document.body.click(),I.note(""),O.log("Enjoy Readings!","</b>"),E.dispatch("bibi:opened",Bibi.Status=Bibi.Opened="Opened"),E.dispatch("bibi:scrolled"),e()})).then((function(){var t=R.hatchPage(e.Destination)||R.Pages[0];I.History.List.length||(I.History.List=[{UI:Bibi,Item:t.Item,PageProgressInItem:t.IndexInItem/t.Item.Pages.length}],I.History.update()),S["allow-placeholders"]&&(R.turnSpreads({Origin:t.Spread}),setTimeout((function(){return R.turnSpreads()}),123),E.add(["bibi:scrolled","bibi:changed-intersection"],(function(){return R.turnSpreads()}))),S["resume-from-last-position"]&&E.add("bibi:changed-intersection",(function(){try{var e=I.PageObserver.Current.List[0].Page;O.Biscuits.memorize("Book",{Position:{IIPP:e.Item.Index+e.IndexInItem/e.Item.Pages.length}})}catch(e){}})),E.add("bibi:commands:move-by",R.moveBy),E.add("bibi:commands:scroll-by",R.scrollBy),E.add("bibi:commands:focus-on",R.focusOn),E.add("bibi:commands:change-view",R.changeView),Bibi.Dev&&!/:61671/.test(location.href)?Bibi.createDevNote():delete Bibi.createDevNote}))},Bibi.createDevNote=function(){var e=Bibi.IsDevMode=O.Body.appendChild(sML.create("div",{id:"bibi-is-dev-mode"}));Bibi.createDevNote.logBorderLine(),Bibi.createDevNote.appendParagraph("<strong>This Bibi seems to be a</strong> <strong>Development Version</strong>"),Bibi.createDevNote.appendParagraph("<span>Please don't forget</span> <span>to create a production version</span> <span>before publishing on the Internet.</span>"),Bibi.createDevNote.appendParagraph('<span class="non-visual">(To create a production version, run it on terminal: `</span><code>npm run build</code><span class="non-visual">`)</span>'),Bibi.createDevNote.appendParagraph("<em>Close</em>","NoLog").addEventListener("click",(function(){return e.className="hide"})),Bibi.createDevNote.logBorderLine(),[E.pointerdown,E.pointerup,E.pointermove,E.pointerover,E.pointerout,"click"].forEach((function(t){return e.addEventListener(t,(function(e){return e.preventDefault(),e.stopPropagation(),!1}))})),setTimeout((function(){return e.className="show"}),0),delete Bibi.createDevNote},Bibi.createDevNote.logBorderLine=function(e,t){O.log("========================","<*/>")},Bibi.createDevNote.appendParagraph=function(e,t){var n=Bibi.IsDevMode.appendChild(sML.create("p",{innerHTML:e}));return t||O.log(e.replace(/<[^<>]*>/g,""),"<*/>"),n},Bibi.createElement=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=n[0];if(Bibi.Elements||(Bibi.Elements={}),window.customElements)Bibi.Elements[r]||(Bibi.Elements[r]=function(e){_inherits(n,e);var t=_createSuper(n);function n(){return _classCallCheck(this,n),t.call(this)}return n}(_wrapNativeSuper(HTMLElement)),window.customElements.define(r,Bibi.Elements[r]));else if(document.registerElement)return Bibi.Elements[r]||(Bibi.Elements[r]=document.registerElement(r)),sML.edit(new(Bibi.Elements[n.shift()]),n);return(e=sML).create.apply(e,n)};var B={Path:"",PathDelimiter:" > ",Container:{Path:"META-INF/container.xml"},Package:{Metadata:{},Manifest:{Items:{}},Spine:{Items:[]}},FileDigit:0,initialize:function(){var e=document.getElementById("bibi-book-data");if(e){var t=e.innerText.trim();if(t){var n=e.getAttribute("data-bibi-book-mimetype");/^application\/(epub\+zip|zip|x-zip(-compressed)?)$/i.test(n)&&(B.Data=t,B.DataType=n)}B.Data||(e.innerHTML="",e.parentNode.removeChild(e))}B.Type=U.book?U.zine?"Zine":"EPUB":"","EPUB"!=B.Type&&(B.ZineData={Path:"zine.yaml"})}},L={Opened:!1,wait:function(){return L.Waiting=!0,O.Busy=!1,O.HTML.classList.remove("busy"),O.HTML.classList.add("waiting"),E.dispatch("bibi:waits"),O.log("(Waiting...)","<i/>"),I.note(""),new Promise((function(e){return L.wait.resolve=e})).then((function(){return L.Waiting=!1,O.Busy=!0,O.HTML.classList.add("busy"),O.HTML.classList.remove("waiting"),I.note("Loading..."),new Promise((function(e){return setTimeout(e,99)}))}))},openNewWindow:function(e){var t=window.open(e);return t||(location.href=e)},play:function(){if(S["start-in-new-window"])return L.openNewWindow(location.href);L.Played=!0,R.resetStage(),L.wait.resolve(),E.dispatch("bibi:played")},initializeBook:function(e){return new Promise((function(t,n){if(!e||!e.BookData)return n("Book Data Is Undefined.");var i=e.BookData,r="string"==typeof i?/^data:/.test(i)?"Base64":"URI":"object"==_typeof(i)?i instanceof File?"File":i instanceof Blob?"BLOB":"":"";if(!r)return n("Book Data Is Unknown.");if("URI"==r){var o;switch(B.Path=i,B.Type){case"EPUB":o=B.Container;break;case"Zine":o=B.ZineData}var a=function(e){return{Promised:("Folder"==e?O.download(o).then((function(){return(B.PathDelimiter="/")&&""})):O.RangeLoader?O.extract(o).then((function(){return"on-the-fly"})):O.loadZippedBookData(B.Path).then((function(){return"at-once"}))).then((function(n){B.ExtractionPolicy=n,t("".concat(B.Type," ").concat(e))})).catch((function(t){return t.BookTypeError?n(t.BookTypeError):(O.log("Failed to Open as ".concat(B.Type," ").concat(e,": ").concat(t)),Promise.reject())})),or:function(e){return this.Promised.catch((function(t){return e(t)}))},or_reject:function(e){return this.or((function(){return n(e)}))}}};O.isToBeExtractedIfNecessary(B.Path)?a("File").or((function(){return a("Folder").or_reject("(Both as ".concat(B.Type," File/Folder)"))})):a("Folder").or_reject('Changing "extract-if-necessary" May Be Required to Open This Book as '.concat(B.Type," File."))}else{var s,c={EPUB:/^application\/epub\+zip$/,Zine:/^application\/(zip|x-zip(-compressed)?)$/};if("File"==r){if(!S["accept-local-file"])return n('To Open Local Files, Changing "accept-local-file" in default.js Is Required.');if(!i.name)return n("Book File Is Invalid.");if(!/\.[\w\d]+$/.test(i.name))return n("Can Not Open Local Files without Extension.");if(!O.isToBeExtractedIfNecessary(i.name))return n('To Open This File, Changing "extract-if-necessary" in default.js Is Required.');if(i.type&&(/\.epub$/i.test(i.name)?!c.EPUB.test(i.type):!/\.zip$/i.test(i.name)||!c.Zine.test(i.type)))return n("Can Not Open This Type of File.");s="File",B.Path="[Local File] "+i.name}else{if("Base64"==r){if(!S["accept-base64-encoded-data"])return n('To Open Base64 Encoded Data, Changing "accept-base64-encoded-data" in default.js Is Required.');try{for(var l=atob(i.replace(/^.*,/,"")),u=new Uint8Array(l.length),d=l.length,p=0;p<d;p++)u[p]=l.charCodeAt(p);if(!((i=new Blob([u.buffer],{type:e.BookDataType}))&&i instanceof Blob))throw""}catch(e){return n("Book Data Is Invalid.")}B.Path="[Base64 Encoded Data]"}else{if(!S["accept-blob-converted-data"])return n('To Open BLOB Converted Data, Changing "accept-blob-converted-data" in default.js Is Required.');B.Path="[BLOB Converted Data]"}if(!c.EPUB.test(i.type)&&!c.Zine.test(i.type))return n("Can Not Open This Type of File.");s="Data"}if(!i.size)return n("Book ".concat(s," Is Empty."));O.loadZippedBookData(i).then((function(){switch(B.Type){case"EPUB":case"Zine":return B.ExtractionPolicy="at-once",t("".concat(B.Type," ").concat(s));default:return n("Book ".concat(s," Is Invalid."))}})).catch(n)}})).then((function(e){return new Promise((function(e){switch(B.Type){case"EPUB":return L.loadContainer().then(L.loadPackage).then(e);case"Zine":return X.Zine.loadZineData().then(e)}})).then((function(){return E.dispatch("bibi:initialized-book"),e}))})).catch((function(e){O.error("Failed to Open the Book:\n"+e)}))},loadContainer:function(){return O.openDocument(B.Container).then(L.loadContainer.process).then((function(){return E.dispatch("bibi:loaded-container")}))}};L.loadContainer.process=function(e){return B.Package.Path=e.getElementsByTagName("rootfile")[0].getAttribute("full-path")},L.loadPackage=function(){return O.openDocument(B.Package).then(L.loadPackage.process).then((function(){return E.dispatch("bibi:loaded-package-document")}))},L.loadPackage.process=function(e){var t=e.getElementsByTagName("package")[0],n=e.getElementsByTagName("metadata")[0],i=B.Package.Metadata,r=e.getElementsByTagName("manifest")[0],o=B.Package.Manifest,a=e.getElementsByTagName("spine")[0],s=B.Package.Spine,c={},l=t.getAttribute("xmlns:dc")||n.getAttribute("xmlns:dc");["identifier","language","title","creator","publisher"].forEach((function(t){return sML.forEach(e.getElementsByTagNameNS(l,t))((function(e){return(i[t]?i[t]:i[t]=[]).push(e.textContent.trim())}))})),sML.forEach(n.getElementsByTagName("meta"))((function(e){if(!e.getAttribute("refines")){var t=e.getAttribute("property");if(t)/^dcterms:/.test(t)?(i[t]||(i[t]=[]),i[t].push(e.textContent.trim())):i[t]=e.textContent.trim();else{var n=e.getAttribute("name");n&&(i[n]=e.getAttribute("content").trim())}}})),i.identifier||(i.identifier=i["dcterms:identifier"]||[O.BookURL]),i.language||(i.language=i["dcterms:language"]||["en"]),i.title||(i.title=i["dcterms:title"]||i.identifier),i["rendition:layout"]||(i["rendition:layout"]="reflowable"),i["omf:version"]&&(i["rendition:layout"]="pre-paginated"),i["rendition:orientation"]&&"auto"!=i["rendition:orientation"]||(i["rendition:orientation"]="portrait"),i["rendition:spread"]&&"auto"!=i["rendition:spread"]||(i["rendition:spread"]="landscape"),i["original-resolution"]&&(i["original-resolution"]=O.getViewportByOriginalResolution(i["original-resolution"])),i["rendition:viewport"]&&(i["rendition:viewport"]=O.getViewportByMetaContent(i["rendition:viewport"])),i["fixed-layout-jp:viewport"]&&(i["fixed-layout-jp:viewport"]=O.getViewportByMetaContent(i["fixed-layout-jp:viewport"])),i["omf:viewport"]&&(i["omf:viewport"]=O.getViewportByMetaContent(i["omf:viewport"])),B.ICBViewport=i["original-resolution"]||i["rendition:viewport"]||i["fixed-layout-jp:viewport"]||i["omf:viewport"]||null;var u=B.Package.Path.replace(/\/?[^\/]+$/,"");if(sML.forEach(r.getElementsByTagName("item"))((function(e){var t={id:e.getAttribute("id"),href:e.getAttribute("href"),"media-type":e.getAttribute("media-type")};if(!t.id||!t.href||!t["media-type"]&&"EPUB"==B.Type)return!1;t.Path=O.getPath(u,t.href),o.Items[t.Path]&&(t=sML.edit(o.Items[t.Path],t)),t.Content||(t.Content="");var n=e.getAttribute("properties");n&&((n=n.trim().replace(/\s+/g," ").split(" ")).includes("cover-image")?B.CoverImageItem=t:n.includes("nav")&&(B.NavItem=t,t.NavType="Navigation Document"));var i=e.getAttribute("fallback");i&&(t.fallback=i),o.Items[t.Path]=t,c[t.id]=t.Path})),[B.Container,B.Package].forEach((function(e){if(e){var t=e.Path;!function(e){["Path","Content","DataType"].forEach((function(t){e[t]=void 0,delete e[t]}))}(o.Items[t]),delete o.Items[t]}})),!B.NavItem){var d=o.Items[c[a.getAttribute("toc")]];d&&(B.NavItem=d,d.NavType="TOC-NCX")}s["page-progression-direction"]=a.getAttribute("page-progression-direction"),s["page-progression-direction"]&&/^(ltr|rtl)$/.test(s["page-progression-direction"])||(s["page-progression-direction"]=S["default-page-progression-direction"]),B.PPD=s["page-progression-direction"];var p,f,g=/^((rendition:)?(layout|orientation|spread|page-spread))-(.+)$/;"rtl"==B.PPD?(p="right",f="left"):(p="left",f="right");var b=document.createDocumentFragment();sML.forEach(a.getElementsByTagName("itemref"))((function(e){var t={idref:e.getAttribute("idref")};if(!t.idref)return!1;var n=o.Items[c[t.idref]];if(!n)return!1;var r=[];if(S["prioritise-fallbacks"])for(;n.fallback;){var a=o.Items[c[n.fallback]];a?(r.push(n.Path),n=a):delete n.fallback}n.RefChain=r.concat(n.Path),t.linear=e.getAttribute("linear"),"no"!=t.linear&&(t.linear="yes");var l=e.getAttribute("properties");l&&(l=l.trim().replace(/\s+/g," ").split(" ")).forEach((function(t){g.test(t)&&(e[t.replace(g,"$1")]=t.replace(g,"$4"))})),t["rendition:layout"]=e["rendition:layout"]||i["rendition:layout"],t["rendition:orientation"]=e["rendition:orientation"]||i["rendition:orientation"],t["rendition:spread"]=e["rendition:spread"]||i["rendition:spread"];var u=e["rendition:page-spread"]||e["page-spread"]||void 0;if(u&&(t["rendition:page-spread"]=u),(n=sML.create("iframe",n,{className:"item",scrolling:"no",allowtransparency:"true",TimeCard:{},stamp:function(e){O.stamp(e,this.TimeCard)},IndexInSpine:s.Items.length,Ref:t,Pages:[]})).Box=sML.create("div",{className:"item-box "+t["rendition:layout"],Content:n,Item:n}),n.RefChain.forEach((function(e){return o.Items[e]=n})),s.Items.push(n),"yes"!=t.linear)n.IndexInNonLinearItems=R.NonLinearItems.length,R.NonLinearItems.push(n);else{n.Index=R.Items.length,R.Items.push(n);var d=null;if("pre-paginated"==t["rendition:layout"]&&t["rendition:page-spread"]==f&&n.Index>0){var h=R.Items[n.Index-1];"pre-paginated"==t["rendition:layout"]&&h.Ref["rendition:page-spread"]==p&&(h.SpreadPair=n,n.SpreadPair=h,(d=n.Spread=h.Spread).Box.classList.remove("single-item-spread-before","single-item-spread-"+p),d.Box.classList.add(t["rendition:layout"]))}if(!d){if((d=n.Spread=sML.create("div",{className:"spread",Items:[],Pages:[],Index:R.Spreads.length})).Box=sML.create("div",{className:"spread-box "+t["rendition:layout"],Content:d,Spread:d}),t["rendition:page-spread"])switch(d.Box.classList.add("single-item-spread-"+t["rendition:page-spread"]),t["rendition:page-spread"]){case p:d.Box.classList.add("single-item-spread-before");break;case f:d.Box.classList.add("single-item-spread-after")}R.Spreads.push(b.appendChild(d.Box).appendChild(d))}if(n.IndexInSpread=d.Items.length,d.Items.push(n),d.appendChild(n.Box),"pre-paginated"==t["rendition:layout"]){n.PrePaginated=!0,0==n.IndexInSpread&&(d.PrePaginated=!0);var m=sML.create("span",{className:"page",Spread:d,Item:n,IndexInItem:0});n.Pages.push(n.Box.appendChild(m)),I.PageObserver.observePageIntersection(m)}else n.PrePaginated=d.PrePaginated=!1}})),R.Main.Book.appendChild(b),B.FileDigit=(s.Items.length+"").length,B.ID=i.identifier[0],B.Language=i.language[0].split("-")[0],B.Title=i.title.join(", "),B.Creator=i.creator?i.creator.join(", "):"",B.Publisher=i.publisher?i.publisher.join(", "):"";var h=[B.Title];B.Creator&&h.push(B.Creator),B.Publisher&&h.push(B.Publisher),B.FullTitle=h.join(" - ").replace(/&amp;?/gi,"&").replace(/&lt;?/gi,"<").replace(/&gt;?/gi,">"),O.Title.innerHTML="",O.Title.appendChild(document.createTextNode(B.FullTitle+" | "+(S["website-name-in-title"]?S["website-name-in-title"]:"Published with Bibi")));try{O.Info.querySelector("h1").innerHTML=document.title}catch(e){}B.WritingMode=/^(zho?|chi|kor?|ja|jpn)$/.test(B.Language)?"rtl"==B.PPD?"tb-rl":"lr-tb":/^(aze?|ara?|ui?g|urd?|kk|kaz|ka?s|ky|kir|kur?|sn?d|ta?t|pu?s|bal|pan?|fas?|per|ber|msa?|may|yid?|heb?|arc|syr|di?v)$/.test(B.Language)?"rl-tb":/^(mo?n)$/.test(B.Language)?"tb-lr":"lr-tb",B.AllowPlaceholderItems="at-once"!=B.ExtractionPolicy&&"pre-paginated"==i["rendition:layout"],E.dispatch("bibi:processed-package")},L.createCover=function(){var e,t=I.Veil.Cover,n=I.Panel.BookInfo.Cover;return t.Info.innerHTML=n.Info.innerHTML=(e=[],B.Title&&e.push("<strong>".concat(L.createCover.optimizeString(B.Title),"</strong>")),B.Creator&&e.push("<em>".concat(L.createCover.optimizeString(B.Creator),"</em>")),B.Publisher&&e.push("<span>".concat(L.createCover.optimizeString(B.Publisher),"</span>")),e.join(" ")),Promise.resolve(new Promise((function(e,t){if(!B.CoverImageItem||!B.CoverImageItem.Path)return t();var n=!1,i=setTimeout((function(){n=!0,t()}),5e3);O.file(B.CoverImageItem,{URI:!0}).then((function(t){n||e(t.URI)})).catch((function(){n||t()})).then((function(){return clearTimeout(i)}))})).then((function(e){t.className=n.className="with-cover-image",sML.style(t,{"background-image":"url("+e+")"}),n.insertBefore(sML.create("img",{src:e}),n.Info)})).catch((function(){t.className=n.className="without-cover-image",t.insertBefore(I.getBookIcon(),t.Info),n.insertBefore(I.getBookIcon(),n.Info)})))},L.createCover.optimizeString=function(e){return"<span>"+e.replace(/([ 　・／]+)/g,"</span><span>$1")+"</span>"},L.loadNavigation=function(){return O.openDocument(B.NavItem).then((function(e){var t=I.Panel.BookInfo.Navigation=I.Panel.BookInfo.insertBefore(sML.create("div",{id:"bibi-panel-bookinfo-navigation"}),I.Panel.BookInfo.firstElementChild);t.innerHTML="";var n=document.createDocumentFragment();if("Navigation Document"==B.NavItem.NavType)sML.forEach(e.querySelectorAll("nav"))((function(e){switch(e.getAttribute("epub:type")){case"toc":e.classList.add("bibi-nav-toc");break;case"landmarks":e.classList.add("bibi-nav-landmarks");break;case"page-list":e.classList.add("bibi-nav-page-list")}sML.forEach(e.getElementsByTagName("*"))((function(e){return e.removeAttribute("style")})),n.appendChild(e)}));else{var i=function e(t){for(var n=t.childNodes,i=void 0,r=n.length,o=0;o<r;o++)if(1==n[o].nodeType&&/^navPoint$/i.test(n[o].tagName)){var a=n[o],s=(a.getElementsByTagName("navLabel")[0],a.getElementsByTagName("content")[0]),c=a.getElementsByTagName("text")[0];i||(i=document.createElement("ul"));var l=sML.create("li",{id:a.getAttribute("id")});l.setAttribute("playorder",a.getAttribute("playorder"));var u=sML.create("a",{href:s.getAttribute("src"),innerHTML:c.innerHTML.trim()});i.appendChild(l).appendChild(u);var d=e(a);d&&l.appendChild(d)}return i}(e.getElementsByTagName("navMap")[0]);i&&n.appendChild(document.createElement("nav")).appendChild(i)}return t.appendChild(n),L.coordinateLinkages(B.NavItem.Path,t,"InNav"),B.NavItem.Content="",t}))},L.coordinateLinkages=function(e,t,n){var i=t.getElementsByTagName("a");if(i)for(var r=function(t,r){var o=i[r];n&&(o.NavANumber=r+1,o.addEventListener(E.pointerdown,(function(e){return e.stopPropagation()})),o.addEventListener(E.pointerup,(function(e){return e.stopPropagation()})));var a=o.getAttribute("href"),s="href";if(!a){if(!(a=o.getAttribute("xlink:href")))return n&&(o.addEventListener("click",(function(e){return e.preventDefault(),e.stopPropagation(),!1})),o.classList.add("bibi-bookinfo-inactive-link")),"continue";s="xlink:href"}if(/^[a-zA-Z]+:/.test(a)){if(a.split("#")[0]!=location.href.split("#")[0])return o.addEventListener("click",(function(e){return e.preventDefault(),e.stopPropagation(),window.open(o.href),!1})),"continue";var c=a.split("#")[1];a=c?"#"+c:R.Items[0].RefChain[0]}var l=O.getPath(e.replace(/\/?([^\/]+)$/,""),(/^\.*\/+/.test(a)?"":"./")+(/^#/.test(a)?e.replace(/^.+?([^\/]+)$/,"$1"):"")+a),u=l.split("#"),d=u[0]?u[0]:e,p=u[1]?u[1]:"";sML.forEach(R.Items)((function(e){if(d==e.RefChain[0])return o.setAttribute("data-bibi-original-href",a),o.setAttribute(s,B.Path+"/"+l),o.InNav=n,o.Destination={ItemIndex:e.Index},"pre-paginated"==e.Ref["rendition:layout"]?o.Destination.PageIndexInItem=0:p&&(o.Destination.ElementSelector="#"+p),L.coordinateLinkages.setJump(o),"break"})),p&&/^epubcfi\(.+\)$/.test(p)&&(o.setAttribute("data-bibi-original-href",a),o.setAttribute(s,B.Path+"/#"+p),X.EPUBCFI?(o.InNav=n,o.Destination=X.EPUBCFI.getDestination(p),L.coordinateLinkages.setJump(o)):o.addEventListener("click",(function(e){return e.preventDefault(),e.stopPropagation(),I.note("ja"==O.Language?"<small>このリンクの利用には EPUBCFI エクステンションが必要です</small>":'"EPUBCFI" extension is required to use this link.'),!1}))),n&&R.StartOn&&R.StartOn.Nav==r+1&&o.Destination&&(R.StartOn=o.Destination)},o=i.length,a=0;a<o;a++)r(0,a)},L.coordinateLinkages.setJump=function(e){return e.addEventListener("click",(function(t){return t.preventDefault(),t.stopPropagation(),e.Destination&&new Promise((function(t){return e.InNav?I.Panel.toggle().then(t):t()})).then((function(){return L.Opened?(I.History.add(),R.focusOn({Destination:e.Destination,Duration:0}).then((function(e){return I.History.add({UI:B,SumUp:!1,Destination:e})}))):!!L.Waiting&&(S["start-in-new-window"]?L.openNewWindow(location.href+(location.hash?",":"#")+"jo(nav:"+e.NavANumber+")"):(R.StartOn=e.Destination,void L.play()))})),!1}))},L.preprocessResources=function(){return new Promise((function(e,t){E.dispatch("bibi:is-going-to:preprocess-resources");var n=[],i=[],r=function(e,t){return n.push(O.file(e,{Preprocess:!0,URI:t}).then((function(){return i.push(e)})))};if(B.ExtractionPolicy)for(var o in B.Package.Manifest.Items){var a=B.Package.Manifest.Items[o];/\/(css|javascript)$/.test(a["media-type"])&&(n.length||O.log("Preprocessing Resources...","<g:>"),r(a,!0))}Promise.all(n).then((function(){i.length&&(O.log("Preprocessed: %O",i),O.log("Preprocessed. (".concat(i.length," Resource").concat(i.length>1?"s":"",")"),"</g>")),E.dispatch("bibi:preprocessed-resources"),e()}))}))},L.loadSpread=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(n,i){e.AllowPlaceholderItems=S["allow-placeholders"]&&t.AllowPlaceholderItems;var r=0,o=0;e.Items.forEach((function(i){L.loadItem(i,{AllowPlaceholder:t.AllowPlaceholderItems}).then((function(){return r++})).catch((function(){return o++})).then((function(){r+o==e.Items.length&&n(e)}))}))}))},L.loadItem=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=S["allow-placeholders"]&&"pre-paginated"==e.Ref["rendition:layout"]&&t.AllowPlaceholder;if(void 0!==e.IsPlaceholder&&e.IsPlaceholder==n)return Promise.reject(e);e.IsPlaceholder=n;var i=e.Box;return i.classList.toggle("placeholder",e.IsPlaceholder),e.IsPlaceholder?(e.parentElement&&e.parentElement.removeChild(e),e.onload=e.onLoaded=void 0,e.src="",e.HTML=e.Head=e.Body=e.Pages[0],Promise.resolve(e)):(i.classList.remove("loaded"),new Promise((function(t,n){e.BlobURL?t():/\.(html?|xht(ml)?|xml)$/i.test(e.Path)?O.file(e,{Preprocess:B.ExtractionPolicy||sML.UA.Gecko,initialize:function(){S["allow-scripts-in-content"]||O.sanitizeItemContent(e,{As:"HTML"})}}).then((function(e){return t(e.Content)})):/\.(gif|jpe?g|png)$/i.test(e.Path)?O.file(e,{URI:!0}).then((function(e){return t(["pre-paginated"==e.Ref["rendition:layout"]&&B.ICBViewport?'<meta name="viewport" content="width='.concat(B.ICBViewport.Width,", height=").concat(B.ICBViewport.Height,'" />'):"",'<img class="bibi-spine-item-image" alt="" src="'.concat(e.URI,'" />')])})):/\.(svg)$/i.test(e.Path)?O.file(e,{Preprocess:!!B.ExtractionPolicy,initialize:function(){var t=/<\?xml-stylesheet\s*(.+?)\s*\?>/g,n=e.Content.match(t);S["allow-scripts-in-content"]||O.sanitizeItemContent(e,{As:"SVG"}),e.Content=(n?n.map((function(e){return e.replace(t,'<link rel="stylesheet" $1 />')})).join(""):"")+"<bibi:boundary/>"+e.Content}}).then((function(e){return t(e.Content.split("<bibi:boundary/>"))})):n()})).catch((function(){return e.Skipped=!0,[]})).then((function(t){return new Promise((function(n){if(e.setAttribute("sandbox","allow-same-origin allow-scripts"),!e.BlobURL){var r="string"==typeof t?t:'<!DOCTYPE html>\n<html><head><meta charset="utf-8" /><title>'.concat(B.FullTitle," - #").concat(e.Index+1,"/").concat(R.Items.length,"</title>").concat(t[0]||"","</head><body>").concat(t[1]||"","</body></html>");if(r=r.replace(/^<\?.+?\?>/,"").replace(/(<head(\s[^>]+)?>)/i,'$1<link rel="stylesheet" id="'.concat("bibi-default-style",'" href="').concat(Bibi.BookStyleURL,'" />')+(e.Preprocessed?"":'<base href="'.concat(O.fullPath(e.Path),'" />'))),sML.UA.LINE||sML.UA.Trident||sML.UA.EdgeHTML)return r=r.replace("</head>","<script id=\"bibi-onload\">window.addEventListener('load', function() { parent.R.Items[".concat(e.Index,"].onLoaded(); return false; });<\/script></head>")),e.onLoaded=function(){n(),e.contentDocument.head.removeChild(e.contentDocument.getElementById("bibi-onload")),delete e.onLoaded},e.src="",i.insertBefore(e,i.firstChild),e.contentDocument.open(),e.contentDocument.write(r),void e.contentDocument.close();e.BlobURL=URL.createObjectURL(new Blob([r],{type:"text/html"})),e.Content=""}e.onload=n,e.src=e.BlobURL,i.insertBefore(e,i.firstChild)}))})).then((function(){return L.postprocessItem(e)})).then((function(){return e.Loaded=!0,i.classList.add("loaded"),E.dispatch("bibi:loaded-item",e),e.stamp("Loaded"),e.Skipped?Promise.reject(e):Promise.resolve(e)})))},L.postprocessItem=function(e){var t;e.stamp("Postprocess"),e.HTML=e.contentDocument.getElementsByTagName("html")[0],(t=e.HTML.classList).add.apply(t,_toConsumableArray(sML.Environments)),e.Head=e.contentDocument.getElementsByTagName("head")[0],e.Body=e.contentDocument.getElementsByTagName("body")[0],e.HTML.Item=e.Head.Item=e.Body.Item=e;var n=e.HTML.getAttribute("xml:lang"),i=e.HTML.getAttribute("lang");n||i?n?i||e.HTML.setAttribute("lang",n):e.HTML.setAttribute("xml:lang",i):(e.HTML.setAttribute("xml:lang",B.Language),e.HTML.setAttribute("lang",B.Language)),sML.forEach(e.Body.getElementsByTagName("link"))((function(t){return e.Head.appendChild(t)})),sML.appendCSSRule(e.contentDocument,"html","-webkit-text-size-adjust: 100%;"),sML.UA.Trident&&sML.forEach(e.Body.getElementsByTagName("svg"))((function(e){var t=e.getElementsByTagName("image");if(1==t.length){var n=t[0];n.getAttribute("width")&&n.getAttribute("height")&&(e.setAttribute("width",n.getAttribute("width")),e.setAttribute("height",n.getAttribute("height")))}})),L.coordinateLinkages(e.Path,e.Body);var r=e.contentDocument.querySelectorAll("body>*:not(script):not(style)");if(r&&1==r.length){var o=e.contentDocument.querySelector("body>*:not(script):not(style)");/^svg$/i.test(o.tagName)?e.Outsourcing=e.OnlySingleSVG=!0:/^img$/i.test(o.tagName)?e.Outsourcing=e.OnlySingleIMG=!0:/^iframe$/i.test(o.tagName)?e.Outsourcing=!0:O.getElementInnerText(e.Body)||(e.Outsourcing=!0)}return("pre-paginated"==e.Ref["rendition:layout"]?Promise.resolve():L.patchItemStyles(e)).then((function(){return E.dispatch("bibi:postprocessed-item",e),e.stamp("Postprocessed"),e}))},L.patchItemStyles=function(e){return new Promise((function(t){e.StyleSheets=[],sML.forEach(e.HTML.querySelectorAll("link, style"))((function(t){if(/^link$/i.test(t.tagName)){if(!t.href)return;if(!/^(alternate )?stylesheet$/.test(t.rel))return;if((sML.UA.Safari||sML.OS.iOS)&&"alternate stylesheet"==t.rel)return}e.StyleSheets.push(t)}));var n=function(){return!(e.contentDocument.styleSheets.length<e.StyleSheets.length)&&(clearInterval(e.CSSLoadingTimerID),delete e.CSSLoadingTimerID,t(),!0)};n()||(e.CSSLoadingTimerID=setInterval(n,33))})).then((function(){if(!e.Preprocessed){if(B.Package.Metadata["ebpaj:guide-version"]){var t=B.Package.Metadata["ebpaj:guide-version"].split(".");1*t[0]==1&&1*t[1]==1&&1*t[2]<=3&&(e.Body.style.textUnderlinePosition="under left")}if(sML.UA.Trident){var n=/^(zho?|chi|kor?|ja|jpn)$/.test(B.Language);O.editCSSRules(e.contentDocument,(function(e){/(-(epub|webkit)-)?column-count: 1; /.test(e.cssText)&&(e.style.columnCount=e.style.msColumnCount="auto"),/(-(epub|webkit)-)?writing-mode: vertical-rl; /.test(e.cssText)&&(e.style.writingMode="tb-rl"),/(-(epub|webkit)-)?writing-mode: vertical-lr; /.test(e.cssText)&&(e.style.writingMode="tb-lr"),/(-(epub|webkit)-)?writing-mode: horizontal-tb; /.test(e.cssText)&&(e.style.writingMode="lr-tb"),/(-(epub|webkit)-)?(text-combine-upright|text-combine-horizontal): all; /.test(e.cssText)&&(e.style.msTextCombineHorizontal="all"),n&&/ text-align: justify; /.test(e.cssText)&&(e.style.textJustify="inter-ideograph")}))}else O.editCSSRules(e.contentDocument,(function(e){/(-(epub|webkit)-)?column-count: 1; /.test(e.cssText)&&(e.style.columnCount=e.style.webkitColumnCount="auto")}))}var i=getComputedStyle(e.HTML),r=getComputedStyle(e.Body);i[O.WritingModeProperty]!=r[O.WritingModeProperty]&&(e.HTML.style.writingMode=r[O.WritingModeProperty]),e.WritingMode=O.getWritingMode(e.HTML),/-rl$/.test(e.WritingMode)?e.HTML.classList.add("bibi-vertical-text"):/-lr$/.test(e.WritingMode)&&e.HTML.classList.add("bibi-horizontal-text"),[[e.Box,i,e.HTML],[e,r,e.Body]].forEach((function(e){["backgroundColor","backgroundImage","backgroundRepeat","backgroundPosition","backgroundSize"].forEach((function(t){return e[0].style[t]=e[1][t]})),e[2].style.background="transparent"})),sML.forEach(e.Body.querySelectorAll("svg, img"))((function(e){e.BibiDefaultStyle={width:e.style.width?e.style.width:"",height:e.style.height?e.style.height:"",maxWidth:e.style.maxWidth?e.style.maxWidth:"",maxHeight:e.style.maxHeight?e.style.maxHeight:""}}))}))};var R={Spreads:[],Items:[],Pages:[],NonLinearItems:[],IntersectingPages:[],Current:{},initialize:function(){R.Main=O.Body.insertBefore(sML.create("main",{id:"bibi-main"}),O.Body.firstElementChild),R.Main.Book=R.Main.appendChild(sML.create("div",{id:"bibi-main-book"}))},resetBibiHeight:function(){var e=window.innerHeight;return O.TouchOS&&(O.HTML.style.height=O.Body.style.height=e+"px"),e},resetStage:function(){var e,t=R.resetBibiHeight();R.Stage={},R.Columned=!1,R.Main.style.padding=R.Main.style.width=R.Main.style.height="",R.Main.Book.style.padding=R.Main.Book.style.width=R.Main.Book.style.height="";var n=(S["use-slider"]&&"paged"==S.RVM&&O.Scrollbars[C.A_SIZE_B]?O.Scrollbars[C.A_SIZE_B]:0)+2*S["spread-margin"];sML.style(R.Main.Book,(_defineProperty(e={},C.A_SIZE_b,n>0?"calc(100% - "+n+"px)":""),_defineProperty(e,C.A_SIZE_l,""),e)),R.Stage.Width=O.Body.clientWidth,R.Stage.Height=t,R.Stage[C.A_SIZE_B]-=(S["use-slider"]||"paged"!=S.RVM?O.Scrollbars[C.A_SIZE_B]:0)+2*S["spread-margin"],window.scrollTo(0,0),S["use-full-height"]||(R.Stage.Height-=I.Menu.Height),S["spread-margin"]>0&&(R.Main.Book.style["padding"+C.L_BASE_S]=R.Main.Book.style["padding"+C.L_BASE_E]=S["spread-margin"]+"px")},layOutSpread:function(e){return new Promise((function(t){E.dispatch("bibi:is-going-to:reset-spread",e),e.Pages=[],R.layOutItem(e.Items[0]).then((function(n){if(n.Pages.forEach((function(t){return t.IndexInSpread=e.Pages.push(t)-1})),1==e.Items.length)return t();R.layOutItem(e.Items[1]).then((function(n){n.Pages.forEach((function(t){return t.IndexInSpread=e.Pages.push(t)-1})),t()}))}))})).then((function(){var t={Width:0,Height:0},n=e.Box;if(1==e.Items.length){var i=e.Items[0];e.Spreaded=!!i.Spreaded,t.Width=e.Spreaded&&"pre-paginated"==i.Ref["rendition:layout"]&&i.Ref["rendition:page-spread"]?B.ICBViewport?i.Box.offsetHeight*B.ICBViewport.Width*2/B.ICBViewport.Height:R.Stage.Width:i.Box.offsetWidth,t.Height=i.Box.offsetHeight}else{var r=e.Items[0],o=e.Items[1];e.Spreaded=!(!r.Spreaded&&!o.Spreaded),"pre-paginated"==r.Ref["rendition:layout"]&&"pre-paginated"==o.Ref["rendition:layout"]?e.Spreaded||"vertical"!=S.RVM?(t.Width=r.Box.offsetWidth+o.Box.offsetWidth,t.Height=Math.max(r.Box.offsetHeight,o.Box.offsetHeight)):(t.Width=Math.max(r.Box.offsetWidth,o.Box.offsetWidth),t.Height=r.Box.offsetHeight+o.Box.offsetHeight):"horizontal"==S.SLA?(t.Width=r.Box.offsetWidth+o.Box.offsetWidth,t.Height=Math.max(r.Box.offsetHeight,o.Box.offsetHeight),Bibi.Dev&&(O.log("Paired Items incl/Reflowable (Horizontal)","<g:>"),O.log("[0] w".concat(r.Box.offsetWidth,"/h").concat(r.Box.offsetHeight," %O"),r),O.log("[1] w".concat(o.Box.offsetWidth,"/h").concat(o.Box.offsetHeight," %O"),o),O.log("-=> w".concat(t.Width,"/h").concat(t.Height," %O"),e,"</g>"))):(t.Width=Math.max(r.Box.offsetWidth,o.Box.offsetWidth),t.Height=r.Box.offsetHeight+o.Box.offsetHeight,Bibi.Dev&&(O.log("Paired Items incl/Reflowable (Vertical)","<g:>"),O.log("[0] w".concat(r.Box.offsetWidth,"/h").concat(r.Box.offsetHeight," %O"),r),O.log("[1] w".concat(o.Box.offsetWidth,"/h").concat(o.Box.offsetHeight," %O"),o),O.log("-=> w".concat(t.Width,"/h").concat(t.Height," %O"),e,"</g>")))}var a="paged"==S.RVM||0!=e.Index&&e.Index!=R.Spreads.length-1?0:Math.floor((R.Stage[C.L_SIZE_L]-t[C.L_SIZE_L])/2);return a>0?(0==e.Index&&(e.style["padding"+C.L_BASE_B]=a+"px",t[C.L_SIZE_L]+=a),e.Index==R.Spreads.length-1&&(e.style["padding"+C.L_BASE_A]=a+"px",t[C.L_SIZE_L]+=a)):e.style.padding="",O.Scrollbars.Height&&"vertical"==S.SLA&&"vertical"!=S.ARA?(n.style.minHeight="paged"==S.RVM?"calc(100vh - "+O.Scrollbars.Height+"px)":"",n.style.marginBottom=e.Index==R.Spreads.length-1?O.Scrollbars.Height+"px":""):n.style.minHeight=n.style.marginBottom="",n.classList.toggle("spreaded",e.Spreaded),n.style[C.L_SIZE_b]="",e.style[C.L_SIZE_b]=Math.ceil(t[C.L_SIZE_B])+"px",n.style[C.L_SIZE_l]=e.style[C.L_SIZE_l]=Math.ceil(t[C.L_SIZE_L])+"px",E.dispatch("bibi:reset-spread",e),e}))},layOutItem:function(e){return new Promise((function(t){O.stamp("Reset...",e.TimeCard),E.dispatch("bibi:is-going-to:reset-item",e),e.Scale=1,"pre-paginated"!=e.Ref["rendition:layout"]?R.renderReflowableItem(e):R.renderPrePaginatedItem(e),E.dispatch("bibi:reset-item",e),O.stamp("Reset.",e.TimeCard),t(e)}))},renderReflowableItem:function(e){var t,n,i,r=S["item-padding-"+C.L_BASE_s]+S["item-padding-"+C.L_BASE_e],o=S["item-padding-"+C.L_BASE_b]+S["item-padding-"+C.L_BASE_a],a=R.Stage[C.L_SIZE_B]-r,s=R.Stage[C.L_SIZE_L]-o,c=o;["b","a","s","e"].forEach((function(t){var n=C["L_BASE_"+t];e.style["padding-"+n]=S["item-padding-"+n]+"px"})),sML.style(e.HTML,{width:"",height:""}),e.WithGutters&&(e.HTML.classList.remove("bibi-with-gutters"),e.Neck.parentNode&&e.Neck.parentNode.removeChild(e.Neck),e.Neck.innerHTML="",delete e.Neck);var l=!sML.UA.Trident&&!sML.UA.EdgeHTML;if(e.Columned&&(sML.style(e.HTML,{"column-fill":"","column-width":"","column-gap":"","column-rule":""}),e.HTML.classList.remove("bibi-columned"),l&&e.ReversedColumned&&(e.HTML.style.direction="",sML.forEach(e.contentDocument.querySelectorAll("body > *"))((function(e){return e.style.direction=""})))),e.WithGutters=!1,e.Columned=!1,e.ColumnBreadth=0,e.ColumnLength=0,e.ReversedColumned=!1,e.Half=!1,e.Spreaded="horizontal"==S.SLA&&("x"==S["pagination-method"]||/-tb$/.test(e.WritingMode))&&("both"==e.Ref["rendition:spread"]||R.Orientation==e.Ref["rendition:spread"]||"landscape"==R.Orientation),e.Spreaded){var u=Math.floor((s-c)/2);u>=Math.floor(a*S["orientation-border-ratio"]/2)?s=u:e.Spreaded=!1}sML.style(e,(_defineProperty(t={},C.L_SIZE_b,a+"px"),_defineProperty(t,C.L_SIZE_l,s+"px"),t));var d=sML.appendCSSRule(e.contentDocument,"*","word-wrap: break-word;");sML.forEach(e.Body.querySelectorAll("img, svg"))((function(t){var n;if(t.BibiDefaultStyle&&(["width","height","maxWidth","maxHeight"].forEach((function(e){return t.style[e]=t.BibiDefaultStyle[e]})),!("horizontal"==S.RVM&&/-(rl|lr)$/.test(e.WritingMode)||"vertical"==S.RVM&&/-tb$/.test(e.WritingMode)))){var i=parseFloat(getComputedStyle(t)[C.L_SIZE_b]),r=Math.floor(Math.min(parseFloat(getComputedStyle(e.Body)[C.L_SIZE_b]),a)),o=parseFloat(getComputedStyle(t)[C.L_SIZE_l]),c=Math.floor(Math.min(parseFloat(getComputedStyle(e.Body)[C.L_SIZE_l]),s));(i>r||o>c)&&sML.style(t,(_defineProperty(n={},C.L_SIZE_b,Math.floor(parseFloat(getComputedStyle(t)[C.L_SIZE_b])*Math.min(r/i,c/o))+"px"),_defineProperty(n,C.L_SIZE_l,"auto"),_defineProperty(n,"maxWidth","100vw"),_defineProperty(n,"maxHeight","100vh"),n))}}));var p="";switch(e.Outsourcing||("x"==S["pagination-method"]?"paged"==S.RVM&&e.HTML["offset"+C.L_SIZE_L]>s?p="S":e.HTML["offset"+C.L_SIZE_B]>a&&(p="C"):("paged"==S.RVM||e.HTML["offset"+C.L_SIZE_B]>a)&&(p="C")),p){case"S":e.HTML.classList.add("bibi-columned"),sML.style(e.HTML,(_defineProperty(n={},C.L_SIZE_b,"auto"),_defineProperty(n,C.L_SIZE_l,s+"px"),_defineProperty(n,"column-fill","auto"),_defineProperty(n,"column-width",a+"px"),_defineProperty(n,"column-gap",0),_defineProperty(n,"column-rule",""),n));var f=Math.ceil((sML.UA.Trident?e.Body.clientHeight:e.HTML.scrollHeight)/a);sML.style(e.HTML,{width:"",height:"","column-fill":"","column-width":"","column-gap":"","column-rule":""}),e.HTML.classList.remove("bibi-columned"),e.HTML.classList.add("bibi-with-gutters");var g=(s+c)*f-c;e.HTML.style[C.L_SIZE_L]=g+"px";for(var b=[],h=1;h<f;h++){var m=a,v=(s+c)*h,y=v-c;b.push(0),b.push(y),b.push(m),b.push(y),b.push(m),b.push(v),b.push(0),b.push(v)}/^tb-/.test(e.WritingMode)&&b.reverse();for(var L=[],E="",O=b.length,B=0;B<O;B++){var P=b[B]+(b[B]?"px":"");B%2==0?E=P:L.push(E+" "+P)}var T=Bibi.createElement("bibi-neck"),w=T.appendChild(Bibi.createElement("bibi-throat")),M=w.attachShadow?w.attachShadow({mode:"open"}):w.createShadowRoot?w.createShadowRoot():w;M.appendChild(document.createElement("style")).textContent=(M!=w?":host":"bibi-throat")+" { ".concat(C.L_SIZE_b,": ").concat(a,"px; ").concat(C.L_SIZE_l,": ").concat(g,"px; shape-outside: polygon(").concat(L.join(", "),"); }"),e.Neck=e.Head.appendChild(T),e.WithGutters=!0;break;case"C":if(e.HTML.classList.add("bibi-columned"),sML.style(e.HTML,(_defineProperty(i={},C.L_SIZE_b,a+"px"),_defineProperty(i,"column-fill","auto"),_defineProperty(i,"column-width",s+"px"),_defineProperty(i,"column-gap",c+"px"),_defineProperty(i,"column-rule",""),i)),R.Columned=!0,e.Columned=!0,e.ColumnBreadth=a,e.ColumnLength=s,l){var _=!1;switch(e.WritingMode){case"lr-tb":case"tb-lr":"ltr"!=S["page-progression-direction"]&&(_=!0);break;case"rl-tb":case"tb-rl":"rtl"!=S["page-progression-direction"]&&(_=!0)}_&&(e.ReversedColumned=!0,sML.forEach(e.contentDocument.querySelectorAll("body > *"))((function(e){return e.style.direction=getComputedStyle(e).direction})),e.HTML.style.direction=S["page-progression-direction"])}}sML.deleteCSSRule(e.contentDocument,d);var x=sML.UA.Trident?e.Body["client"+C.L_SIZE_L]:e.HTML["scroll"+C.L_SIZE_L],k=Math.ceil((x+c)/(s+c));x=(s+c)*k-c,e.style[C.L_SIZE_l]=e.HTML.style[C.L_SIZE_l]=x+"px",sML.UA.Trident&&(e.HTML.style[C.L_SIZE_l]="100%");var A=a+r,H=x+o;e.Box.style[C.L_SIZE_b]=A+"px",e.Box.style[C.L_SIZE_l]=H+"px",e.Pages.forEach((function(t){I.PageObserver.unobservePageIntersection(t),e.Box.removeChild(t)})),e.Pages=[];for(var D=0;D<k;D++){var N=e.Box.appendChild(sML.create("span",{className:"page"}));N.Item=e,N.Spread=e.Spread,N.IndexInItem=e.Pages.length,e.Pages.push(N),I.PageObserver.observePageIntersection(N)}return e},renderPrePaginatedItem:function(e){sML.style(e,{width:"",height:"",transform:""});var t=R.Stage[C.L_SIZE_B],n=R.Stage[C.L_SIZE_L];e.Spreaded=!("paged"!=S.RVM&&S["full-breadth-layout-in-scroll"]||"both"!=e.Ref["rendition:spread"]&&R.Orientation!=e.Ref["rendition:spread"]&&"landscape"!=R.Orientation),e.Viewport||(e.Viewport=R.getItemViewport(e));var i=null;if(e.Spreaded)if(i=R.getItemLayoutViewport(e),e.SpreadPair){var r=e.SpreadPair;r.Spreaded=!0,r.Viewport||(r.Viewport=R.getItemViewport(r));var o=R.getItemLayoutViewport(r),a=null,s=null,c=null,l=null;r.Index>e.Index?(a=e,s=i,c=r,l=o):(a=r,s=o,c=e,l=i),c.Scale=s.Height/l.Height;var u={Width:s.Width+l.Width*c.Scale,Height:s.Height};a.Scale=Math.min(t/u[C.L_SIZE_B],n/u[C.L_SIZE_L]),c.Scale*=a.Scale}else{var d={Width:i.Width*(/^(left|right)$/.test(e.Ref["rendition:page-spread"])?2:1),Height:i.Height};e.Scale=Math.min(t/d[C.L_SIZE_B],n/d[C.L_SIZE_L])}else i=R.getItemLayoutViewport(e),"paged"!=S.RVM&&S["full-breadth-layout-in-scroll"]?e.Scale=t/i[C.L_SIZE_B]:e.Scale=Math.min(t/i[C.L_SIZE_B],n/i[C.L_SIZE_L]);var p=Math.floor(i[C.L_SIZE_L]*e.Scale),f=Math.floor(i[C.L_SIZE_B]*(p/i[C.L_SIZE_L]));return e.Box.style[C.L_SIZE_l]=p+"px",e.Box.style[C.L_SIZE_b]=f+"px",sML.style(e,{width:i.Width+"px",height:i.Height+"px",transform:"scale("+e.Scale+")"}),e},getItemViewport:function(e){return e.IsPlaceholder?null:(t=e.Head.querySelector('meta[name="viewport"]'))?O.getViewportByMetaContent(t.getAttribute("content")):e.OnlySingleSVG?O.getViewportByViewBox(e.Body.firstElementChild.getAttribute("viewBox")):e.OnlySingleIMG?O.getViewportByImage(e.Body.firstElementChild):null;var t},getItemLayoutViewport:function(e){return e.Viewport?e.Viewport:B.ICBViewport?B.ICBViewport:{Width:R.Stage.Height*S["orientation-border-ratio"]/(/^(left|right)$/.test(e.Ref["rendition:page-spread"])?2:1),Height:R.Stage.Height}},turnSpreads:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise((function(t){if(R.DoNotTurn||!S["allow-placeholders"])return t();var n=[-1,2],i=I.ScrollObserver.History.length>1&&I.ScrollObserver.History[1]*C.L_AXIS_D>I.ScrollObserver.History[0]*C.L_AXIS_D?-1:1,r=e.Origin||(I.PageObserver.Current.List.length?(i>0?I.PageObserver.Current.List.slice(-1):I.PageObserver.Current.List)[0].Page.Spread:I.PageObserver.IntersectingPages.length?(i>0?I.PageObserver.IntersectingPages.slice(-1):I.PageObserver.IntersectingPages)[0].Spread:null);if(!r)return t();for(var o=[],a=[],s=n[0];s<=n[1];s++){var c=R.Spreads[r.Index+s*i];c&&("Up"!=c.Turned&&"Up"!=c.Turning&&(clearTimeout(c.Timer_TurningFaceUp),a.push(c)))}for(;a.length<2;){var l=++n[1];if(l>9)break;var u=R.Spreads[r.Index+l*i];if(!u)break;"Up"!=u.Turned&&"Up"!=u.Turning&&(clearTimeout(u.Timer_TurningFaceUp),a.push(u))}var d=[];R.turnSpreads.SpreadsTurnedFaceUp&&R.turnSpreads.SpreadsTurnedFaceUp.forEach((function(e){"Up"==e.Turned||"Up"==e.Turning||a.includes(e)||(clearTimeout(e.Timer_TurningFaceUp),setTimeout((function(){return R.turnSpread(e,!1)}),0),d.push(e))})),R.turnSpreads.SpreadsTurnedFaceUp=[],[a,d].forEach((function(e,t){return e.forEach((function(e,n){e.Items.length;e==r||t+n==0?o.push(R.turnSpread(e,!0)):e.Timer_TurningFaceUp=setTimeout((function(){return R.turnSpread(e,!0)}),88*(t+.1*n)),R.turnSpreads.SpreadsTurnedFaceUp.push(e)}))})),(o.length?Promise.all(o):Promise.resolve()).then(t)}))},turnSpread:function(e,t){return new Promise((function(n){e.Turning=t?"Up":"Down",e.Turned=!1;var i=!t;if(!S["allow-placeholders"]||e.AllowPlaceholderItems==i)return n();Bibi.Debug&&t&&sML.style(e.Box,{transition:""},{background:"rgba(255,0,0,0.5)"});var r=e.Box["offset"+C.L_SIZE_L],o=e.Pages.reduce((function(e,t){return e.push(t),e}),[]);t||R.cancelSpreadRetlieving(e),L.loadSpread(e,{AllowPlaceholderItems:i}).then((function(e){n(),R.layOutSpread(e).then((function(){e.PrePaginated||R.replacePages(o,e.Pages);var t=e.Box["offset"+C.L_SIZE_L]-r;0!=t&&(R.Main.Book.style[C.L_SIZE_l]=parseFloat(getComputedStyle(R.Main.Book)[C.L_SIZE_l])+t+"px")}))})).catch((function(e){return n()}))})).then((function(){Bibi.Debug&&t&&sML.style(e.Box,{transition:"background linear .5s"},{background:""}),e.Turning=!1,e.Turned=t?"Up":"Down"}))},cancelSpreadRetlieving:function(e){return!!O.RangeLoader&&e.Items.forEach((function(e){e.ResItems&&e.ResItems.forEach((function(e){return O.cancelExtraction(e)})),O.cancelExtraction(e)}))},organizePages:function(){var e=[];return R.Spreads.forEach((function(t){return t.Pages.forEach((function(t){t.Index=e.length,e.push(t)}))})),R.Pages=e},replacePages:function(e,t){var n,i=e[0].Index,r=e.length,o=t.length;if(t.forEach((function(e,t){return e.Index=i+t})),o!=r)for(var a=o-r,s=e[r-1].Index+1;R.Pages[s];)R.Pages[s].Index+=a,s++;return(n=R.Pages).splice.apply(n,[i,r].concat(_toConsumableArray(t))),R.Pages},layOutStage:function(){var e=0;R.Spreads.forEach((function(t){return e+=t.Box["offset"+C.L_SIZE_L]})),"pre-paginated"!=S["book-rendition-layout"]&&"paged"==S["reader-view-mode"]||(e+=S["spread-gap"]*(R.Spreads.length-1)),R.Main.Book.style[C.L_SIZE_l]=e+"px"},layOut:function(e){return new Promise((function(t,n){if(R.LayingOut)return n();if(I.ScrollObserver.History=[],R.LayingOut=!0,O.log("Laying out...","<g:>"),e?O.log("Option: %O",e):e={},e.DoNotCloseUtilities||E.dispatch("bibi:closes-utilities"),E.dispatch("bibi:is-going-to:lay-out",e),O.Busy=!0,O.HTML.classList.add("busy"),O.HTML.classList.add("laying-out"),e.NoNotification||I.note("Laying out..."),!e.Destination){var i=I.PageObserver.Current.List.length?I.PageObserver.Current.List[0].Page:R.Pages[0];e.Destination={Item:i.Item,PageProgressInItem:i.IndexInItem/i.Item.Pages.length}}e.Setting&&S.update(e.Setting);var r={};if(["reader-view-mode","spread-layout-direction","apparent-reading-direction"].forEach((function(e){return r[e]=S[e]})),O.log("Layout: %O",r),"function"==typeof e.before&&e.before(),e.Reset){R.resetStage();var o=[];R.Spreads.forEach((function(e){return o.push(R.layOutSpread(e))})),Promise.all(o).then((function(){R.organizePages(),R.layOutStage(),t()}))}else t()})).then((function(){return R.focusOn({Destination:e.Destination,Duration:0})})).then((function(){O.Busy=!1,O.HTML.classList.remove("busy"),O.HTML.classList.remove("laying-out"),e.NoNotification||I.note(""),R.LayingOut=!1,E.dispatch("bibi:laid-out"),O.log("Laid out.","</g>")}))},updateOrientation:function(){var e=R.Orientation;if(void 0!==window.orientation)R.Orientation=0==window.orientation||180==window.orientation?"portrait":"landscape";else{var t=window.innerWidth-("vertical"==S.ARA?O.Scrollbars.Width:0),n=window.innerHeight-("horizontal"==S.ARA?O.Scrollbars.Height:0);R.Orientation=t/n<S["orientation-border-ratio"]?"portrait":"landscape"}R.Orientation!=e&&(e&&E.dispatch("bibi:changes-orientation",R.Orientation),O.HTML.classList.remove("orientation-"+e),O.HTML.classList.add("orientation-"+R.Orientation),e&&E.dispatch("bibi:changed-orientation",R.Orientation))},changeView:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(S["fix-reader-view-mode"]||!e||"string"!=typeof e.Mode||!/^(paged|horizontal|vertical)$/.test(e.Mode)||S.RVM==e.Mode&&!e.Force)return!1;if(L.Opened){E.dispatch("bibi:changes-view"),O.Busy=!0,O.HTML.classList.add("busy"),O.HTML.classList.add("changing-view");var n=[O.TouchOS?99:3,O.TouchOS?99:33];setTimeout((function(){E.dispatch("bibi:closes-utilities")}),n[0]),setTimeout((function(){R.layOut({Reset:!0,NoNotification:t.NoNotification,Setting:{"reader-view-mode":e.Mode}}).then((function(){O.HTML.classList.remove("changing-view"),O.HTML.classList.remove("busy"),O.Busy=!1,setTimeout((function(){return E.dispatch("bibi:changed-view",e.Mode)}),0)}))}),n[0]+n[1])}else S.update({"reader-view-mode":e.Mode}),L.play();S["keep-settings"]&&O.Biscuits.memorize("Book",{RVM:e.Mode})}};Object.defineProperties(R,{Current:{get:function(){return I.PageObserver.Current}},updateCurrent:{get:function(){return I.PageObserver.updateCurrent}}}),R.focusOn=function(e){return new Promise((function(t,n){if(R.Moving)return n();if(!e)return n();"number"==typeof e&&(e={Destination:e});var i=e.Destination=R.hatchDestination(e.Destination);if(!i)return n();E.dispatch("bibi:is-going-to:focus-on",e),R.Moving=!0,e.FocusPoint=0,"reflowable"==S["book-rendition-layout"]?("number"==typeof i.Point?e.FocusPoint=i.Point:(e.FocusPoint=O.getElementCoord(i.Page)[C.L_AXIS_L],"after"==i.Side&&(e.FocusPoint+=(i.Page["offset"+C.L_SIZE_L]-R.Stage[C.L_SIZE_L])*C.L_AXIS_D),"rtl"==S.SLD&&(e.FocusPoint+=i.Page.offsetWidth)),"rtl"==S.SLD&&(e.FocusPoint-=R.Stage.Width)):(S["allow-placeholders"]&&0!=e.Turn&&R.turnSpreads({Origin:i.Page.Spread}),R.Stage[C.L_SIZE_L]>=i.Page.Spread["offset"+C.L_SIZE_L]?(e.FocusPoint=O.getElementCoord(i.Page.Spread)[C.L_AXIS_L],e.FocusPoint-=Math.floor((R.Stage[C.L_SIZE_L]-i.Page.Spread["offset"+C.L_SIZE_L])/2)):(e.FocusPoint=O.getElementCoord(i.Page)[C.L_AXIS_L],R.Stage[C.L_SIZE_L]>i.Page["offset"+C.L_SIZE_L]?e.FocusPoint-=Math.floor((R.Stage[C.L_SIZE_L]-i.Page["offset"+C.L_SIZE_L])/2):"after"==i.Side&&(e.FocusPoint+=(i.Page["offset"+C.L_SIZE_L]-R.Stage[C.L_SIZE_L])*C.L_AXIS_D))),"number"==typeof i.TextNodeIndex&&R.selectTextLocation(i);var r={Frame:R.Main,X:0,Y:0};return r[C.L_AXIS_L]=e.FocusPoint,S["use-full-height"]||"vertical"!=S.RVM||(r.Y-=I.Menu.Height),sML.scrollTo(r,{ForceScroll:!0,Duration:"number"==typeof e.Duration?e.Duration:S.SLA==S.ARA&&"paged"!=S.RVM?222:0,Easing:function(e){return 1===e?1:-1*Math.pow(2,-10*e)+1}}).then((function(){R.Moving=!1,t(i),E.dispatch("bibi:focused-on",e)}))})).catch((function(){return Promise.resolve()}))},R.hatchDestination=function(e){if(!e)return null;if((e.Element||e.ElementSelector)&&"reflowable"==S.BRL&&("vertical"==S.SLA&&/-tb$/.test(B.WritingMode)||"horizontal"==S.SLA&&/^tb-/.test(B.WritingMode)))return e.Point=R.hatchPoint(e),e;if(delete e.Point,e.Page){if(R.Pages[e.Page.Index]==e.Page)return e;delete e.Page}if("number"==typeof e||"string"==typeof e&&/^\d+$/.test(e))return{Page:R.Items[e].Pages[0]};if("string"==typeof e)"head"==e||"foot"==e?e={Edge:e}:X.EPUBCFI&&(e=X.EPUBCFI.getDestination(e));else if("number"==typeof e.IndexInItem){if(R.Pages[e.Index]==e)return{Page:e}}else{if("number"==typeof e.Index)return{Page:e.Pages[0]};e.tagName&&(e={Element:e})}return e.Page=R.hatchPage(e),e},R.hatchPage=function(e){if(e.Page)return e.Page;if("head"==e.Edge)return R.Pages[0];if("foot"==e.Edge)return R.Pages[R.Pages.length-1];if("number"==typeof e.PageIndex)return R.Pages[e.PageIndex];"string"==typeof e.BibiTo&&e.BibiTo&&Object.assign(e,R.getBibiToDestination(e.BibiTo)),"number"==typeof e.IIPP&&("number"!=typeof e.PageIndexInItem&&"number"!=typeof e.PageProgressInItem||"number"!=typeof e.ItemIndex&&!e.Item)&&(e.ItemIndex=Math.floor(e.IIPP),e.PageProgressInItem=e.IIPP-e.ItemIndex),"number"==typeof e.SIPP&&("number"!=typeof e.PageIndexInSpread&&"number"!=typeof e.PageProgressInSpread||"number"!=typeof e.SpreadIndex&&!e.Spread)&&(e.SpreadIndex=Math.floor(e.SIPP),e.PageProgressInSpread=e.SIPP-e.SpreadIndex);try{return"number"==typeof e.PageIndexInItem?R.hatchItem(e).Pages[e.PageIndexInItem]:"number"==typeof e.PageIndexInSpread?R.hatchSpread(e).Pages[e.PageIndexInSpread]:"number"==typeof e.PageProgressInItem?(n=R.hatchItem(e)).Pages[sML.limitMax(Math.floor(n.Pages.length*e.PageProgressInItem),n.Pages.length-1)]:"number"==typeof e.PageProgressInSpread?(t=R.hatchSpread(e)).Pages[sML.limitMax(Math.floor(t.Pages.length*e.PageProgressInSpread),t.Pages.length-1)]:("string"==typeof e.ElementSelector&&(e.Element=R.hatchItem(e).contentDocument.querySelector(e.ElementSelector),delete e.ElementSelector),e.Element?R.hatchNearestPageOfElement(e.Element):(R.hatchItem(e)||R.hatchSpread(e)).Pages[0])}catch(e){}var t,n;return null},R.hatchItem=function(e){if(e.Item)return e.Item;if("number"==typeof e.ItemIndex)return R.Items[e.ItemIndex];if("number"==typeof e.ItemIndexInSpine)return B.Package.Spine.Items[e.ItemIndexInSpine];if("number"==typeof e.ItemIndexInSpread)try{return R.hatchSpread(e).Items[e.ItemIndexInSpread]}catch(e){return null}return null},R.hatchSpread=function(e){return e.Spread?e.Spread:"number"==typeof e.SpreadIndex?R.Spreads[e.SpreadIndex]:null},R.hatchNearestPageOfElement=function(e){if(!e||!e.tagName)return null;var t,n,i=e.ownerDocument.body.Item;return i&&i.Pages?(i.Columned?(n=O.getElementCoord(e)[C.L_AXIS_B],"rtl"==S.PPD&&"vertical"==S.SLA&&(n=i.Body.offsetWidth-n-e.offsetWidth),t=i.Pages[n<=0?0:Math.floor(n/i.ColumnBreadth)]):(n=O.getElementCoord(e)[C.L_AXIS_L],"rtl"==S.PPD&&"horizontal"==S.SLA&&(n=i.HTML.offsetWidth-n-e.offsetWidth),t=i.Pages[Math.floor(n/R.Stage[C.L_SIZE_L])]),t):null},R.hatchPoint=function(e){try{if("string"==typeof e.ElementSelector&&(e.Element=R.hatchItem(e).contentDocument.querySelector(e.ElementSelector),delete e.ElementSelector),e.Element)return R.hatchPointOfElement(e.Element)}catch(e){}return null},R.hatchPointOfElement=function(e){if(!e||!e.tagName)return null;var t,n=e.ownerDocument.body.Item;return n&&n.Pages?(n.Columned?(t=O.getElementCoord(e)[C.L_AXIS_B],"rtl"==S.PPD&&"vertical"==S.SLA&&(t=n.Body.offsetWidth-t-e.offsetWidth)):(t=O.getElementCoord(e)[C.L_AXIS_L],"rtl"==S.PPD&&"horizontal"==S.SLA&&(t+=e.offsetWidth)),O.getElementCoord(n)[C.L_AXIS_L]+S["item-padding-"+C.L_OOBL_l]+t):null},R.getBibiToDestination=function(e){if("number"==typeof e&&(e=""+e),"string"!=typeof e||!/^[1-9][0-9]*(-[1-9][0-9]*(\.[1-9][0-9]*)*)?$/.test(e))return null;var t="",n=e.split("-"),i=parseInt(n[0])-1,r=n[1]?n[1]:null;return r&&r.split(".").forEach((function(e){return t+=">*:nth-child("+e+")"})),{ItemIndexInSpine:i,ElementSelector:t?"body"+t:void 0}},R.selectTextLocation=function(e){if("number"!=typeof e.TextNodeIndex||!e.Element)return!1;var t=e.Element.childNodes[e.TextNodeIndex];if(t&&t.textContent){var n={Start:{Node:t,Index:0},End:{Node:t,Index:t.textContent.length}};if(e.TermStep)if(e.TermStep.Preceding||e.TermStep.Following){if(n.Start.Index=e.TermStep.Index,n.End.Index=e.TermStep.Index,e.TermStep.Preceding&&(n.Start.Index-=e.TermStep.Preceding.length),e.TermStep.Following&&(n.End.Index+=e.TermStep.Following.length),n.Start.Index<0||t.textContent.length<n.End.Index)return;if(t.textContent.substr(n.Start.Index,n.End.Index-n.Start.Index)!=e.TermStep.Preceding+e.TermStep.Following)return}else if(e.TermStep.Side&&"a"==e.TermStep.Side){for(n.Start.Node=t.parentNode.firstChild;n.Start.Node.childNodes.length;)n.Start.Node=n.Start.Node.firstChild;n.End.Index=e.TermStep.Index-1}else{for(n.Start.Index=e.TermStep.Index,n.End.Node=t.parentNode.lastChild;n.End.Node.childNodes.length;)n.End.Node=n.End.Node.lastChild;n.End.Index=n.End.Node.textContent.length}return sML.Ranges.selectRange(sML.Ranges.getRange(n))}},R.moveBy=function(e){return new Promise((function(t,n){if(R.Moving||!L.Opened)return n();if(!e)return n();if("number"==typeof e&&(e={Distance:e}),!e.Distance||"number"!=typeof e.Distance)return n();if(e.Distance*=1,0==e.Distance||isNaN(e.Distance))return n();E.dispatch("bibi:is-going-to:move-by",e);var i=(e.Distance>0?I.PageObserver.Current.List.slice(-1):I.PageObserver.Current.List)[0],r=i.Page,o=(r.Item,e.Distance>0?"before":"after");i.PageIntersectionStatus.Oversized?e.Distance>0?i.PageIntersectionStatus.Entering?(e.Distance=0,o="before"):i.PageIntersectionStatus.Headed&&(e.Distance=0,o="after"):(i.PageIntersectionStatus.Footed||i.PageIntersectionStatus.Passing)&&(e.Distance=0,o="before"):e.Distance>0?i.PageIntersectionStatus.Entering&&(e.Distance=0,o="before"):i.PageIntersectionStatus.Passing&&(e.Distance=0,o="before");var a=r.Index+e.Distance;a<0?(a=0,o="before"):a>R.Pages.length-1&&(a=R.Pages.length-1,o="after");var s=R.Pages[a];"pre-paginated"==S.BRL&&s.Item.SpreadPair&&"horizontal"==S.SLA&&R.Stage[C.L_SIZE_L]>s.Spread["offset"+C.L_SIZE_L]&&(e.Distance<0&&0==s.IndexInSpread&&(s=s.Spread.Pages[1]),e.Distance>0&&1==s.IndexInSpread&&(s=s.Spread.Pages[0])),e.Destination={Page:s,Side:o},R.focusOn(e).then((function(){return e.Destination})).then((function(n){t(n),E.dispatch("bibi:moved-by",e)}))})).catch((function(){return Promise.resolve()}))},R.scrollBy=function(e){return new Promise((function(t,n){if(!e)return n();if("number"==typeof e&&(e={Distance:e}),!e.Distance||"number"!=typeof e.Distance)return n();E.dispatch("bibi:is-going-to:scroll-by",e),R.Moving=!0;var i={Frame:R.Main,X:0,Y:0};switch(S.SLD){case"ttb":i.Y=R.Main.scrollTop+R.Stage.Height*e.Distance;break;case"ltr":i.X=R.Main.scrollLeft+R.Stage.Width*e.Distance;break;case"rtl":i.X=R.Main.scrollLeft+R.Stage.Width*e.Distance*-1}sML.scrollTo(i,{Duration:"number"==typeof e.Duration?e.Duration:"paged"!=S.RVM&&S.SLA==S.ARA?100:0,ForceScroll:!e.Cancelable,ease:"function"==typeof e.ease?e.ease:null}).catch((function(){return!0})).then((function(){R.Moving=!1,t()}))})).then((function(){return E.dispatch("bibi:scrolled-by",e)}))};var I={initialize:function(){I.Utilities.create(),I.TouchObserver.create(),I.Notifier.create(),I.Veil.create(),E.bind("bibi:readied",(function(){I.ScrollObserver.create(),I.ResizeObserver.create(),I.PageObserver.create(),I.Catcher.create(),I.Menu.create(),I.Panel.create(),I.Help.create(),I.PoweredBy.create(),I.FontSizeChanger.create(),I.Loupe.create()})),E.bind("bibi:initialized-book",(function(){I.BookmarkManager.create()})),E.bind("bibi:prepared",(function(){I.FlickObserver.create(),I.WheelObserver.create(),I.PinchObserver.create(),I.KeyObserver.create(),I.EdgeObserver.create(),I.Nombre.create(),I.Slider.create(),I.Flipper.create(),I.Arrows.create(),I.AxisSwitcher.create(),I.Spinner.create()}))}};I.Utilities={create:function(){var e=I.Utilities=I.setToggleAction({openGracefuly:function(){return!R.Moving&&!R.Breaking&&"active"!=e.UIState&&e.open()},closeGracefuly:function(){return!R.Moving&&!R.Breaking&&"default"!=e.UIState&&e.close()},toggleGracefuly:function(){return!R.Moving&&!R.Breaking&&e.toggle()}},{onopened:function(){return E.dispatch("bibi:opens-utilities")},onclosed:function(){return E.dispatch("bibi:closes-utilities")}});E.add("bibi:commands:open-utilities",(function(){return I.Utilities.open()})),E.add("bibi:commands:close-utilities",(function(){return I.Utilities.close()})),E.add("bibi:commands:toggle-utilities",(function(){return I.Utilities.toggleGracefuly()}))}},I.ScrollObserver={create:function(){var e=I.ScrollObserver={History:[],Count:0,onScroll:function(t){!R.LayingOut&&L.Opened&&(e.Scrolling||(e.Scrolling=!0,O.HTML.classList.add("scrolling")),E.dispatch("bibi:is-scrolling"),e.History.unshift(Math.ceil(R.Main["scroll"+C.L_OOBL_L])),e.History.length>2&&e.History.pop(),8==++e.Count&&(e.Count=0,E.dispatch("bibi:scrolled")),clearTimeout(R.Timer_onScrollEnd),R.Timer_onScrollEnd=setTimeout((function(){e.Scrolling=!1,e.Count=0,O.HTML.classList.remove("scrolling"),E.dispatch("bibi:scrolled")}),123))},observe:function(){R.Main.addEventListener("scroll",e.onScroll)},breakCurrentScrolling:function(){try{R.Breaking=!0,sML.Scroller.Scrolling.cancel(),setTimeout((function(){return R.Breaking=!1}),333)}catch(e){R.Breaking=!1}},forceStopScrolling:function(){e.breakCurrentScrolling(),R.Main.style.overflow="hidden",R.Main.scrollLeft=R.Main.scrollLeft,R.Main.scrollTop=R.Main.scrollTop,R.Main.style.overflow=""}};E.bind("bibi:opened",e.observe),E.dispatch("bibi:created-scroll-observer")}},I.PageObserver={create:function(){var e=I.PageObserver={IntersectingPages:[],PagesToBeObserved:[],observePageIntersection:function(t){return e.PagesToBeObserved.includes(t)?e.PagesToBeObserved.length:e.PagesToBeObserved.push(t)},unobservePageIntersection:function(t){return(e.PagesToBeObserved=e.PagesToBeObserved.filter((function(e){return e!=t}))).length},observeIntersection:function(){var t=new IntersectionObserver((function(t){return t.forEach((function(t){var n=t.target,i=!1;t.isIntersecting?e.IntersectingPages.includes(n)||(i=!0,e.IntersectingPages.push(n)):e.IntersectingPages.includes(n)&&(i=!0,e.IntersectingPages=e.IntersectingPages.filter((function(e){return e!=n}))),i&&(e.IntersectingPages.length&&e.IntersectingPages.sort((function(e,t){return e.Index-t.Index})),E.dispatch("bibi:changes-intersection",e.IntersectingPages),clearTimeout(e.Timer_IntersectionChange),e.Timer_IntersectionChange=setTimeout((function(){E.dispatch("bibi:changed-intersection",e.IntersectingPages)}),9))}))}),{root:R.Main,rootMargin:"0px",threshold:[0,.5,1]});e.observePageIntersection=function(e){return t.observe(e)},e.unobservePageIntersection=function(e){return t.unobserve(e)},e.PagesToBeObserved.forEach((function(e){return t.observe(e)})),delete e.PagesToBeObserved},Current:{List:[],Pages:[],Frame:{}},updateCurrent:function(){var t=e.getFrame();if(t){e.Current.Frame=t;var n=e.getList();n&&(e.Current.List=n,e.Current.Pages=n.map((function(e){return e.Page})),e.classify())}return e.Current},getFrame:function(){var e={};return e.Length=R.Main["offset"+C.L_SIZE_L],e[C.L_OOBL_L]=Math.ceil(R.Main["scroll"+C.L_OOBL_L]),e["Top"==C.L_OOBL_L?"Bottom":"Right"]=e[C.L_OOBL_L]+e.Length,{Before:e[C.L_BASE_B],After:e[C.L_BASE_A],Length:e.Length}},getList:function(){for(var t=[],n=[],i=void 0,r=Math.ceil(R.Stage.Width/4),o=Math.ceil(R.Stage.Height/4),a=[5,6,4,2,8],s=a.length,c=0;c<s;c++){var l=a[c],u=document.elementFromPoint(r*(l%3||3),o*Math.ceil(l/3));if(u&&(u.IndexInItem?i=[u]:u.Pages?i=u.Pages:u.Content&&(i=u.Content.Pages)),i)break}if(!i&&I.PageObserver.IntersectingPages.length&&(i=I.PageObserver.IntersectingPages),!i||!i[0]||"number"!=typeof i[0].Index)return null;for(var d=sML.limitMin(i[0].Index-2,0),p=sML.limitMax(i[i.length-1].Index+2,R.Pages.length-1),f=0,g=d;g<=p;g++){var b=R.Pages[g],h=e.getIntersectionStatus(b,"WithDetail");if(h.Ratio<f){if(t.length)break}else{var m={Page:b,PageIntersectionStatus:h};if(t.length){var v=t[t.length-1];v.Page.Item==b.Item&&(m.ItemIntersectionStatus=v.ItemIntersectionStatus),v.Page.Spread==b.Spread&&(m.SpreadIntersectionStatus=v.SpreadIntersectionStatus)}m.ItemIntersectionStatus||(m.ItemIntersectionStatus=e.getIntersectionStatus(b.Item.Box)),m.SpreadIntersectionStatus||(m.SpreadIntersectionStatus=e.getIntersectionStatus(b.Spread)),1==m.SpreadIntersectionStatus.Ratio&&n.push(m),h.Ratio>f?(t=[m],f=h.Ratio):t.push(m)}}return n.length?n:t.length?t:null},getIntersectionStatus:function(t,n){var i=sML.getCoord(t),r=C.L_AXIS_D,o=Math.min(e.Current.Frame.After*r,i[C.L_BASE_A]*r)-Math.max(e.Current.Frame.Before*r,i[C.L_BASE_B]*r),a=o<=0||!i[C.L_SIZE_L]||isNaN(o)?0:o/i[C.L_SIZE_L],s={Ratio:a};if(a<=0);else if(n)if(a>=1)s.Contained=!0;else{var c=e.Current.Frame.Before*r,l=e.Current.Frame.After*r,u=i[C.L_BASE_B]*r,d=i[C.L_BASE_A]*r;c<u?s.Entering=!0:c==u?s.Headed=!0:d==l?s.Footed=!0:d<l&&(s.Passing=!0),R.Main["offset"+L]<i[C.L_SIZE_L]&&(s.Oversized=!0)}return s},classify:function(){var t=[],n=R.Main.Book.querySelectorAll(".current");e.Current.List.forEach((function(e){var n=e.Page,i=n.Item.Box,r=n.Spread.Box;t.includes(r)||(r.classList.add("current"),t.push(r)),t.includes(i)||(i.classList.add("current"),t.push(i)),n.classList.add("current"),t.push(n)})),sML.forEach(n)((function(e){t.includes(e)||e.classList.remove("current")}))},observeCurrent:function(){E.bind(["bibi:changed-intersection","bibi:scrolled"],e.updateCurrent)},Past:{List:[{Page:null,PageIntersectionStatus:null}]},observePageMove:function(){E.bind("bibi:scrolled",(function(){var t=e.Current.List[0],n=e.Current.List.slice(-1)[0],i=t.Page,r=n.Page,o=t.PageIntersectionStatus,a=n.PageIntersectionStatus,s=e.Past.List[0],c=e.Past.List.slice(-1)[0],l=s.Page,u=c.Page,d=R.Pages.length-1,p=!1,f=!1,g=!1;if(i!=l||r!=u)p=!0,0==i.Index&&(o.Contained||o.Headed)&&(f=!0),r.Index==d&&(a.Contained||a.Footed)&&(g=!0);else{var b=s.PageIntersectionStatus,h=c.PageIntersectionStatus;0!=i.Index||!o.Contained&&!o.Headed||b.Contained||b.Headed||(f=!0),r.Index!=d||!a.Contained&&!a.Footed||h.Contained||h.Footed||(g=!0)}var m={Past:e.Past,Current:e.Current};p&&E.dispatch("bibi:flipped",m),f&&E.dispatch("bibi:got-to-the-beginning",m),g&&E.dispatch("bibi:got-to-the-end",m),Object.assign(e.Past,e.Current)}))}};E.bind("bibi:laid-out-for-the-first-time",(function(t){e.IntersectingPages=[R.Spreads[t.TargetSpreadIndex].Pages[0]],e.observeIntersection()})),E.bind("bibi:opened",(function(){e.updateCurrent(),e.observeCurrent(),e.observePageMove()})),E.dispatch("bibi:created-page-observer")}},I.ResizeObserver={create:function(){var e=I.ResizeObserver={Resizing:!1,TargetPageAfterResizing:null,onResize:function(t){!R.LayingOut&&L.Opened&&(e.Resizing||(e.Resizing=!0,e.TargetPageAfterResizing=I.PageObserver.Current.List[0]?I.PageObserver.Current.List[0].Page:null,O.Busy=!0,O.HTML.classList.add("busy"),O.HTML.classList.add("resizing")),clearTimeout(e.Timer_onResizeEnd),e.Timer_onResizeEnd=setTimeout((function(){R.updateOrientation();var n=e.TargetPageAfterResizing||(I.PageObserver.Current.List[0]?I.PageObserver.Current.List[0].Page:null);R.layOut({Reset:!0,Destination:n?{ItemIndex:n.Item.Index,PageProgressInItem:n.IndexInItem/n.Item.Pages.length}:null}).then((function(){E.dispatch("bibi:resized",t),O.HTML.classList.remove("resizing"),O.HTML.classList.remove("busy"),O.Busy=!1,e.Resizing=!1}))}),sML.UA.Trident?1200:O.TouchOS?600:300))},observe:function(){window.addEventListener(E.resize,e.onResize)}};E.bind("bibi:opened",e.observe),E.dispatch("bibi:created-resize-observer")}},I.TouchObserver={create:function(){var e=I.TouchObserver={observeElementHover:function(e){return e.BibiHoverObserver||(e.BibiHoverObserver={onHover:function(t){return E.dispatch(e,"bibi:hovered",t)},onUnHover:function(t){return E.dispatch(e,"bibi:unhovered",t)}},e.addEventListener(E.pointerover,(function(t){return e.BibiHoverObserver.onHover(t)})),e.addEventListener(E.pointerout,(function(t){return e.BibiHoverObserver.onUnHover(t)}))),e},setElementHoverActions:function(e){return E.add(e,"bibi:hovered",(function(t){return e.Hover||e.isAvailable&&!e.isAvailable(t)||(e.Hover=!0,e.classList.add("hover"),e.showHelp&&e.showHelp()),e})),E.add(e,"bibi:unhovered",(function(t){return e.Hover?(e.Hover=!1,e.classList.remove("hover"),e.hideHelp&&e.hideHelp(),e):e})),e},observeElementTap:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e.BibiTapObserver){var n={D2U:200,U2D:200};e.BibiTapObserver={care:t.PreventDefault?t.StopPropagation?function(e){return e.preventDefault()||e.stopPropagation()}:function(e){return e.preventDefault()}:t.StopPropagation?function(e){return e.stopPropagation()}:function(){},onPointerDown:function(e){this.care(e),clearTimeout(this.Timer_forgetFloating),clearTimeout(this.Timer_fireSingleTap);var t=Date.now();this.Touching={Time:t,Coord:O.getBibiEventCoord(e),Event:e},this.Floating&&(t-this.Floating.Time<n.U2D&&(this.Floating.FirstTouching.Event.preventDefault(),this.Floating.Event.preventDefault(),e.preventDefault(),this.Touching.Doubled=!0),delete this.Floating)},onPointerUp:function(t){var i=this;if(this.care(t),this.Touching){var r=Date.now();if(r-this.Touching.Time<n.D2U){var o=O.getBibiEventCoord(t);Math.abs(o.X-this.Touching.Coord.X)<3&&Math.abs(o.Y-this.Touching.Coord.Y)<3&&(this.Touching.Doubled?e.BibiTapObserver.onDoubleTap(t):(this.Floating={Time:r,Event:t,FirstTouching:this.Touching},this.Timer_forgetFloating=setTimeout((function(){delete i.Floating}),n.U2D),this.Timer_fireSingleTap=setTimeout((function(){return e.BibiTapObserver.onTap(t)}),n.U2D)))}delete this.Touching}},onTap:function(t){return E.dispatch(e,"bibi:tapped",t)},onDoubleTap:function(t){return E.dispatch(e,"bibi:doubletapped",t)}},e.addEventListener(E.pointerdown,(function(t){return e.BibiTapObserver.onPointerDown(t)})),e.addEventListener(E.pointerup,(function(t){return e.BibiTapObserver.onPointerUp(t)}))}return e},setElementTapActions:function(e){var t=function(){switch(e.Type){case"toggle":return function(t){if("disabled"==e.UIState)return!1;I.setUIState(e,"default"==e.UIState?"active":"default")};case"radio":return function(t){if("disabled"==e.UIState)return!1;e.ButtonGroup.Buttons.forEach((function(t){t!=e&&I.setUIState(t,"")})),I.setUIState(e,"active")};default:return function(t){if("disabled"==e.UIState)return!1;I.setUIState(e,"active"),clearTimeout(e.Timer_deactivate),e.Timer_deactivate=setTimeout((function(){return I.setUIState(e,"disabled"==e.UIState?"disabled":"")}),200)}}}();return E.add(e,"bibi:tapped",(function(n){return e.isAvailable&&!e.isAvailable(n)||"disabled"==e.UIState||"active"==e.UIState&&"radio"==e.Type||(t(n),e.hideHelp&&e.hideHelp(),e.note&&setTimeout(e.note,0)),e})),e},PointerEventNames:O.TouchOS?[["touchstart","mousedown"],["touchend","mouseup"],["touchmove","mousemove"]]:void 0!==document.onpointermove?["pointerdown","pointerup","pointermove"]:["mousedown","mouseup","mousemove"],PreviousPointerCoord:{X:0,Y:0},activateHTML:function(t){e.observeElementTap(t);var n=e.PointerEventNames;E.add(t,"bibi:tapped",(function(e){return E.dispatch("bibi:tapped",e)})),E.add(t,"bibi:doubletapped",(function(e){return E.dispatch("bibi:doubletapped",e)})),E.add(t,n[0],(function(e){return E.dispatch("bibi:downed-pointer",e)}),E.Cpt1Psv0),E.add(t,n[1],(function(e){return E.dispatch("bibi:upped-pointer",e)}),E.Cpt1Psv0),E.add(t,n[2],(function(t){var n=O.getBibiEventCoord(t),i=e.PreviousPointerCoord;E.dispatch(i.X!=n.X||i.Y!=n.Y?"bibi:moved-pointer":"bibi:stopped-pointer",t),e.PreviousPointerCoord=n,t.stopPropagation()}),E.Cpt1Psv0)}},t=function(e){switch(S.RVM){case"horizontal":if(e.Coord.Y>window.innerHeight-O.Scrollbars.Height)return!1;break;case"vertical":if(e.Coord.X>window.innerWidth-O.Scrollbars.Width)return!1}if(e.Target.ownerDocument){if(O.isPointableContent(e.Target))return!1;if(I.Slider.ownerDocument&&(e.Target==I.Slider||I.Slider.contains(e.Target)))return!1}return!0};E.bind("bibi:readied",(function(){return e.activateHTML(O.HTML)})),E.bind("bibi:postprocessed-item",(function(t){return e.activateHTML(t.HTML)})),E.add("bibi:tapped",(function(e){if(I.isPointerStealth())return!1;if(I.OpenedSubpanel)return I.OpenedSubpanel.close()&&!1;var n=O.getBibiEvent(e);return!!t(n)&&("center"==n.Division.X&&"middle"==n.Division.Y?E.dispatch("bibi:tapped-center",e):E.dispatch("bibi:tapped-not-center",e))})),E.add("bibi:doubletapped",(function(e){if(I.isPointerStealth()||!L.Opened)return!1;if(I.OpenedSubpanel)return I.OpenedSubpanel.close()&&!1;var n=O.getBibiEvent(e);return!!t(n)&&("center"==n.Division.X&&"middle"==n.Division.Y?E.dispatch("bibi:doubletapped-center",e):E.dispatch("bibi:doubletapped-not-center",e))})),E.add("bibi:tapped-center",(function(){return I.Utilities.toggleGracefuly()})),E.dispatch("bibi:created-touch-observer")}},I.FlickObserver={create:function(){var e=I.FlickObserver={Moving:0,getDegree:function(e){return(t=180*Math.atan2(-1*e.Y,e.X)/Math.PI)<0?t+360:t;var t},onTouchStart:function(t){if(L.Opened){if(e.LastEvent)return e.onTouchEnd();if(!I.Loupe.Transforming){e.LastEvent=t;var n=O.getBibiEventCoord(t);e.StartedOn={X:n.X,Y:n.Y,Item:t.target.ownerDocument.body.Item||null,TimeStamp:t.timeStamp,ScrollLeft:R.Main.scrollLeft,ScrollTop:R.Main.scrollTop,OriginList:I.PageObserver.updateCurrent().List},E.add("bibi:moved-pointer",e.onTouchMove),E.add("bibi:upped-pointer",e.onTouchEnd)}}},cancel:function(){delete e.StartedOn,delete e.LastEvent,E.remove("bibi:moved-pointer",e.onTouchMove),E.remove("bibi:upped-pointer",e.onTouchEnd),e.Moving=0},onTouchMove:function(t){if(I.ScrollObserver.breakCurrentScrolling(),e.StartedOn){if(!e.Moving&&t.timeStamp-e.StartedOn.TimeStamp>333)return e.cancel();var n=O.getBibiEventCoord(t),i={X:n.X-e.StartedOn.X,Y:n.Y-e.StartedOn.Y};if(++e.Moving<=3){var r=e.getDegree(i);e.StartedOn.LaunchingAxis=315<=r||r<=45||135<=r&&r<=225?"X":45<r&&r<135||225<r&&r<315?"Y":""}if(e.StartedOn.LaunchingAxis==C.A_AXIS_B);else{if("paged"!=S.RVM&&"touchmove"==t.type)return e.cancel();S["content-draggable"]["paged"==S.RVM?0:1]&&I.isScrollable()&&(R.Main["scroll"+C.L_OOBL_L]=e.StartedOn["Scroll"+C.L_OOBL_L]+-1*i[C.L_AXIS_L])}if(t.preventDefault(),e.StartedOn.Item&&(e.StartedOn.Item.HTML.classList.add("bibi-flick-hot"),e.StartedOn.Item.contentWindow.getSelection().empty()),e.LastEvent=t,n[C.A_AXIS_L]<=0||n[C.A_AXIS_L]>=R.Stage[C.A_SIZE_L]||n[C.A_AXIS_B]<=0||n[C.A_AXIS_B]>=R.Stage[C.A_SIZE_B])return e.onTouchEnd(t,{Swipe:!0})}},onTouchEnd:function(t,n){t||(t=e.LastEvent),E.remove("bibi:moved-pointer",e.onTouchMove),E.remove("bibi:upped-pointer",e.onTouchEnd),e.Moving=0;var i=void 0,r={};if(e.StartedOn){var o=O.getBibiEventCoord(t),a={X:o.X-e.StartedOn.X,Y:o.Y-e.StartedOn.Y};e.StartedOn.Item&&e.StartedOn.Item.HTML.classList.remove("bibi-flick-hot"),I.Loupe.Transforming||(e.StartedOn.LaunchingAxis==C.A_AXIS_B&&Math.abs(a[C.A_AXIS_B]/100)>=1&&(i=e.getOrthogonalTouchMoveFunction()),!i&&(Math.abs(a.X)>=3||Math.abs(a.Y)>=3)&&(t.preventDefault(),r.Speed=Math.sqrt(Math.pow(a.X,2)+Math.pow(a.Y,2))/(t.timeStamp-e.StartedOn.TimeStamp),r.Deg=e.getDegree(a),O.getViewportZooming()<=1&&t.timeStamp-e.StartedOn.TimeStamp<=300?(r.OriginList=e.StartedOn.OriginList,i=n&&n.Swipe?e.onSwipe:e.onFlick):I.isScrollable()&&(i=e.onPanRelease))),delete e.StartedOn}return delete e.LastEvent,i?i(t,r):Promise.resolve()},onFlick:function(t,n){if("paged"!=S.RVM&&!S["content-draggable"]["paged"==S.RVM?0:1])return Promise.resolve();if("number"!=typeof n.Deg)return Promise.resolve();var i=n.Deg,r=330<=i||i<=30?"left":60<=i&&i<=120?"bottom":150<=i&&i<=210?"right":240<=i&&i<=300?"top":"",o=C.d2d(r,"move"==I.orthogonal("touch-moves"));if(o){if("paged"==S.RVM||S.RVM!=(/^[lr]/.test(r)?"horizontal":/^[tb]/.test(r)?"vertical":"")){var a=o>0?n.OriginList.slice(-1)[0].Page.Index:n.OriginList[0].Page.Index;return R.focusOn({Destination:{Page:R.Pages[a+o]?R.Pages[a+o]:R.Pages[a]},Duration:I.isScrollable()&&("paged"!=S.RVM||S["content-draggable"][0])?123:0})}return R.scrollBy({Distance:o*(n.Speed?333*sML.limitMinMax(.08*Math.round(100*n.Speed),.33,10)/("ttb"==S.SLD?R.Stage.Height:R.Stage.Width):1),Duration:1234,Cancelable:!0,ease:function(e){return-1*(Math.pow(e-1,4)-1)}})}return new Promise((function(t){e.getOrthogonalTouchMoveFunction()(),t()}))},onSwipe:function(t,n){return e.onFlick(t,n)},onPanRelease:function(e,t){if("paged"!=S.RVM||!S["content-draggable"][0])return Promise.resolve();var n=t.Deg,i=270<n||n<90?"left":90<n&&n<270?"right":"",r=C.d2d(i),o=I.PageObserver.updateCurrent().List;return R.focusOn({Destination:{Page:r>=0?o.slice(-1)[0].Page:o[0].Page},Duration:I.isScrollable()&&S["content-draggable"][0]?123:0})},getOrthogonalTouchMoveFunction:function(){switch(I.orthogonal("touch-moves")){case"switch":if(I.AxisSwitcher)return I.AxisSwitcher.switchAxis;break;case"utilities":return I.Utilities.toggleGracefuly}},getCNPf:function(e){return e.ownerDocument==document?"":"bibi-"},activateElement:function(t){if(!t)return!1;t.addEventListener(E.pointerdown,e.onTouchStart,E.Cpt1Psv0);var n=e.getCNPf(t);t.ownerDocument.documentElement.classList.add(n+"flick-active"),I.isScrollable()&&t.ownerDocument.documentElement.classList.add(n+"flick-scrollable")},deactivateElement:function(t){if(!t)return!1;t.removeEventListener(E.pointerdown,e.onTouchStart,E.Cpt1Psv0);var n=e.getCNPf(t);t.ownerDocument.documentElement.classList.remove(n+"flick-active"),t.ownerDocument.documentElement.classList.remove(n+"flick-scrollable")}};e.activateElement(R.Main),E.add("bibi:loaded-item",(function(t){return e.activateElement(t.HTML)})),E.dispatch("bibi:created-flick-observer")}},I.WheelObserver={create:function(){var e=I.WheelObserver={TotalDelta:0,Turned:!1,Wheels:[],reset:function(){e.TotalDelta=0,e.Progress=0,e.Turned=!1,e.Wheels=[]},reserveResetWith:function(t){clearTimeout(e.Timer_resetWheeling);try{t()}catch(e){}e.Timer_resetWheeling=setTimeout(e.reset,234)},careTurned:function(){e.reserveResetWith((function(){return e.Turned=!0}))},heat:function(){clearTimeout(e.Timer_coolDown),e.Hot=!0,e.Timer_coolDown=setTimeout((function(){return e.Hot=!1}),234)},onWheel:function(t){var n=Math.abs(t.deltaX)>Math.abs(t.deltaY)?"X":"Y",i={},r=e.Wheels,o=r.length;if(i.Axis=n,i.Direction="X"==n?t.deltaX<0?"left":"right":t.deltaY<0?"top":"bottom",i.Distance=C.d2d(i.Direction,"Allow Orthogonal Direction"),i.Delta=Math.abs(t["delta"+n]),r[o-1]){if(i.Axis!=r[o-1].Axis)return e.careTurned();i.Distance!=r[o-1].Distance?(i.Accel=1,i.Wheeled=o>=3&&r[o-2].Distance!=i.Distance&&r[o-3].Distance!=i.Distance?"reverse":""):i.Delta>r[o-1].Delta?(i.Accel=1,i.Wheeled=o>=3&&-1==r[o-1].Accel&&-1==r[o-2].Accel&&-1==r[o-3].Accel?"serial":""):i.Delta<r[o-1].Delta?(i.Accel=-1,i.Wheeled=""):(i.Accel=r[o-1].Accel,i.Wheeled="")}else i.Accel=1,i.Wheeled="start";e.reserveResetWith((function(){r.push(i),o>3&&r.shift(),e.Progress=(e.TotalDelta+=t["delta"+n])/3/100}));var a=n!=C.A_AXIS_L?I.orthogonal("wheelings"):"paged"==S.RVM?"move":e.OverlaidUIs.filter((function(e){return e.contains(t.target)})).length?"simulate":"";if(a&&!e.Hot)switch(a){case"simulate":return e.scrollNatural(t,n);case"across":return e.scrollAcross(t,n);case"move":return e.move(i);case"utilities":return e.toggleUtilities(i);case"switch":return e.switchAxis(i)}},scrollNatural:function(e,t){switch(t){case"X":R.Main.scrollLeft+=e.deltaX;break;case"Y":R.Main.scrollTop+=e.deltaY}},scrollAcross:function(e,t){switch(t){case"X":R.Main.scrollTop+=e.deltaX;break;case"Y":R.Main.scrollLeft+=e.deltaY*("rtl"==S.ARD?-1:1)}},move:function(t){t.Wheeled&&(e.heat(),R.moveBy({Distance:t.Distance,Duration:I.isScrollable()&&S["content-draggable"][0]?123:0}))},toggleUtilities:function(t){t.Wheeled&&(e.heat(),I.Utilities.toggleGracefuly())},switchAxis:function(){!I.AxisSwitcher||Math.abs(e.Progress)<1||(e.heat(),I.AxisSwitcher.switchAxis())},OverlaidUIs:[]};document.addEventListener("wheel",(function(e){return E.dispatch("bibi:is-wheeling",e)}),E.Cpt1Psv0),E.add("bibi:loaded-item",(function(e){return e.contentDocument.addEventListener("wheel",(function(e){return E.dispatch("bibi:is-wheeling",e)}),E.Cpt1Psv0)})),E.add("bibi:opened",(function(){[I.Menu,I.Slider].forEach((function(t){t.ownerDocument&&(t.addEventListener("wheel",(function(e){e.preventDefault(),e.stopPropagation()}),E.Cpt1Psv0),e.OverlaidUIs.push(t))})),E.add("bibi:is-wheeling",e.onWheel),O.HTML.classList.add("wheel-active")})),E.dispatch("bibi:created-wheel-observer")}},I.PinchObserver={create:function(){var e=I.PinchObserver={Pinching:0,getEventCoords:function(e){var t=e.touches[0],n=e.touches[1],i=(e.target.ownerDocument,t.screenX),r=t.screenY;return{Center:{X:(i+n.screenX)/2,Y:(r+n.screenY)/2},Distance:Math.sqrt(Math.pow(n.screenX-t.screenX,2)+Math.pow(n.screenY-t.screenY,2))}},onTouchStart:function(t){L.Opened&&2==t.touches.length&&(O.HTML.classList.add("pinching"),e.Hot=!0,t.preventDefault(),t.stopPropagation(),e.PinchStart={Scale:I.Loupe.CurrentTransformation.Scale,Coords:e.getEventCoords(t)})},onTouchMove:function(t){if(2==t.touches.length&&e.PinchStart){t.preventDefault(),t.stopPropagation();var n=e.getEventCoords(t).Distance/e.PinchStart.Coords.Distance;clearTimeout(e.Timer_TransitionRestore),sML.style(R.Main,{transition:"none"}),I.Loupe.scale(e.PinchStart.Scale*n,{Center:e.PinchStart.Coords.Center,Stepless:!0}),e.Timer_TransitionRestore=setTimeout((function(){return sML.style(R.Main,{transition:""})}),234)}},onTouchEnd:function(t,n){e.Pinching=0,delete e.LastScale,delete e.PinchStart,delete e.Hot,O.HTML.classList.remove("pinching")},getCNPf:function(e){return e==document?"":"bibi-"},activateElement:function(t){if(!t)return!1;t.addEventListener("touchstart",e.onTouchStart,E.Cpt1Psv0),t.addEventListener("touchmove",e.onTouchMove,E.Cpt1Psv0),t.addEventListener("touchend",e.onTouchEnd,E.Cpt1Psv0),t.ownerDocument.documentElement.classList.add(e.getCNPf(t)+"pinch-active")},deactivateElement:function(t){if(!t)return!1;t.removeEventListener("touchstart",e.onTouchStart,E.Cpt1Psv0),t.removeEventListener("touchmove",e.onTouchMove,E.Cpt1Psv0),t.removeEventListener("touchend",e.onTouchEnd,E.Cpt1Psv0),t.ownerDocument.documentElement.classList.remove(e.getCNPf(t)+"pinch-active")}};e.activateElement(R.Main),E.add("bibi:loaded-item",(function(t){return e.activateElement(t.HTML)})),E.dispatch("bibi:created-pinch-observer")}},I.KeyObserver={create:function(){if(S["use-keys"]){var e=I.KeyObserver={ActiveKeys:{},KeyCodes:{keydown:{},keyup:{},keypress:{}},updateKeyCodes:function(t,n){"function"!=typeof t.join&&(t=[t]),"function"==typeof n&&(n=n()),t.forEach((function(t){return e.KeyCodes[t]=sML.edit(e.KeyCodes[t],n)}))},KeyParameters:{},initializeKeyParameters:function(){var t={End:"foot",Home:"head"};for(var n in t)t[n.toUpperCase()]="head"==t[n]?"foot":"foot"==t[n]?"head":t[n];e.KeyParameters=t},updateKeyParameters:function(){var t=I.orthogonal("arrow-keys"),n=function(){switch(S.ARA){case"horizontal":return Object.assign({"Left Arrow":C.d2d("left"),"Right Arrow":C.d2d("right")},"move"==t?{"Up Arrow":C.d2d("top",9),"Down Arrow":C.d2d("bottom",9)}:{"Up Arrow":t,"Down Arrow":t});case"vertical":return Object.assign({"Up Arrow":C.d2d("top"),"Down Arrow":C.d2d("bottom")},"move"==t?{"Left Arrow":C.d2d("left",9),"Right Arrow":C.d2d("right",9)}:{"Left Arrow":t,"Right Arrow":t})}}();for(var i in n)n[i.toUpperCase()]=-1==n[i]?"head":1==n[i]?"foot":n[i];Object.assign(e.KeyParameters,n)},getBibiKeyName:function(t){var n=e.KeyCodes[t.type][t.keyCode];return n||""},onEvent:function(t){return!!L.Opened&&(t.BibiKeyName=e.getBibiKeyName(t),t.BibiModifierKeys=[],t.shiftKey&&t.BibiModifierKeys.push("Shift"),t.ctrlKey&&t.BibiModifierKeys.push("Control"),t.altKey&&t.BibiModifierKeys.push("Alt"),t.metaKey&&t.BibiModifierKeys.push("Meta"),t.BibiKeyName&&t.preventDefault(),!0)},onKeyDown:function(t){if(!e.onEvent(t))return!1;t.BibiKeyName&&(e.ActiveKeys[t.BibiKeyName]?E.dispatch("bibi:is-holding-key",t):e.ActiveKeys[t.BibiKeyName]=Date.now()),E.dispatch("bibi:downed-key",t)},onKeyUp:function(t){if(!e.onEvent(t))return!1;e.ActiveKeys[t.BibiKeyName]&&Date.now()-e.ActiveKeys[t.BibiKeyName]<300&&E.dispatch("bibi:touched-key",t),t.BibiKeyName&&e.ActiveKeys[t.BibiKeyName]&&delete e.ActiveKeys[t.BibiKeyName],E.dispatch("bibi:upped-key",t)},onKeyPress:function(t){if(!e.onEvent(t))return!1;E.dispatch("bibi:pressed-key",t)},observe:function(t){["keydown","keyup","keypress"].forEach((function(n){return t.addEventListener(n,e["onKey"+sML.capitalise(n.replace("key",""))],!1)}))},onKeyTouch:function(t){if(!t.BibiKeyName)return!1;var n=e.KeyParameters[t.shiftKey?t.BibiKeyName.toUpperCase():t.BibiKeyName];if(!n)return!1;switch(t.preventDefault(),_typeof(n)){case"number":if(I.Flipper.isAbleToFlip(n)){var i=n,r=I.Flipper[i].Arrow;E.dispatch(r,"bibi:tapped",t),I.Flipper.flip(i)}break;case"string":switch(n){case"head":case"foot":return R.focusOn({Destination:n,Duration:0});case"utilities":return I.Utilities.toggleGracefuly();case"switch":return!!I.AxisSwitcher&&I.AxisSwitcher.switchAxis()}}}};e.updateKeyCodes(["keydown","keyup","keypress"],{32:"Space"}),e.updateKeyCodes(["keydown","keyup"],{33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left Arrow",38:"Up Arrow",39:"Right Arrow",40:"Down Arrow"}),E.add("bibi:postprocessed-item",(function(t){return!t.IsPlaceholder&&e.observe(t.contentDocument)})),E.add("bibi:opened",(function(){e.initializeKeyParameters(),e.updateKeyParameters(),E.add("bibi:changed-view",(function(){return e.updateKeyParameters()})),e.observe(document),E.add(["bibi:touched-key","bibi:is-holding-key"],(function(t){return e.onKeyTouch(t)}))})),E.dispatch("bibi:created-key-observer")}}},I.EdgeObserver={create:function(){var e=I.EdgeObserver={};E.add("bibi:opened",(function(){E.add(["bibi:tapped-not-center","bibi:doubletapped-not-center"],(function(e){if(I.isPointerStealth())return!1;var t=O.getBibiEvent(e),n=I.Flipper.getDirection(t.Division),i=I.orthogonal("edges"),r=C.d2d(n,"move"==i);if(r)I.Arrows&&I.Arrows.areAvailable(t)&&E.dispatch(I.Arrows[r],"bibi:tapped",e),I.Flipper.isAbleToFlip(r)&&I.Flipper.flip(r);else if("string"==typeof C.DDD[n])switch(i){case"utilities":I.Utilities.toggleGracefuly();break;case"switch":I.AxisSwitcher&&I.AxisSwitcher.switchAxis()}})),O.TouchOS||(E.add("bibi:moved-pointer",(function(t){if(I.isPointerStealth())return!1;var n=O.getBibiEvent(t);if(I.Arrows.areAvailable(n)){var i=I.Flipper.getDirection(n.Division),r=I.orthogonal("edges"),o=C.d2d(i,"move"==r);if(o&&I.Flipper.isAbleToFlip(o)){if(e.Hovering=!0,I.Arrows){var a=I.Arrows[o];E.dispatch(a,"bibi:hovered",t),E.dispatch(a.Pair,"bibi:unhovered",t)}var s=n.Target.ownerDocument.documentElement;return void(e.HoveringHTML!=s&&(e.HoveringHTML&&e.HoveringHTML.removeAttribute("data-bibi-cursor"),(e.HoveringHTML=s).setAttribute("data-bibi-cursor",i)))}}e.Hovering&&(e.Hovering=!1,I.Arrows&&E.dispatch([I.Arrows.Back,I.Arrows.Forward],"bibi:unhovered",t),e.HoveringHTML&&(e.HoveringHTML.removeAttribute("data-bibi-cursor"),e.HoveringHTML=null))})),sML.forEach(O.Body.querySelectorAll("img"))((function(e){return e.addEventListener(E.pointerdown,O.preventDefault)})))})),O.TouchOS||E.add("bibi:loaded-item",(function(e){return sML.forEach(e.Body.querySelectorAll("img"))((function(e){return e.addEventListener(E.pointerdown,O.preventDefault)}))})),E.dispatch("bibi:created-edge-observer")}},I.Notifier={create:function(){var e=I.Notifier=O.Body.appendChild(sML.create("div",{id:"bibi-notifier",show:function(t,n){clearTimeout(e.Timer_hide),e.P.className=n?"error":"",e.P.innerHTML=t,O.HTML.classList.add("notifier-shown"),L.Opened&&!n&&e.addEventListener(O.TouchOS?E.pointerdown:E.pointerover,e.hide)},hide:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;clearTimeout(e.Timer_hide),e.Timer_hide=setTimeout((function(){L.Opened&&e.removeEventListener(O.TouchOS?E.pointerdown:E.pointerover,e.hide),O.HTML.classList.remove("notifier-shown")}),t)},note:function(t,n,i){if(!t)return e.hide();e.show(t,i),void 0===n&&(n=O.Busy&&!L.Opened?8888:2222),"number"==typeof n&&e.hide(n)}}));e.P=e.appendChild(document.createElement("p")),I.note=e.note,E.dispatch("bibi:created-notifier")}},I.note=function(){return!1},I.Veil={create:function(){var e=I.Veil=I.setToggleAction(O.Body.appendChild(sML.create("div",{id:"bibi-veil"})),{onopened:function(){return O.HTML.classList.add("veil-opened"),e.classList.remove("closed")},onclosed:function(){return e.classList.add("closed"),O.HTML.classList.remove("veil-opened")}});["touchstart","pointerdown","mousedown","click"].forEach((function(t){return e.addEventListener(t,(function(e){return e.stopPropagation()}),E.Cpt0Psv0)})),e.open();var t=(O.TouchOS?"Tap":"Click")+" to Open",n=e.PlayButton=e.appendChild(sML.create("p",{id:"bibi-veil-play",title:t,innerHTML:'<span class="non-visual">'.concat(t,"</span>"),play:function(e){return e.stopPropagation(),L.play(),E.dispatch("bibi:played:by-button")},hide:function(){return sML.style(n,{opacity:0,cursor:"default"}).then((function(t){return e.removeChild(n)}))},on:{click:function(e){return n.play(e)}}}));E.add("bibi:played",(function(){return n.hide()})),e.byebye=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.innerHTML="",e.ByeBye=e.appendChild(sML.create("p",{id:"bibi-veil-byebye"})),["en","ja"].forEach((function(n){return e.ByeBye.innerHTML+='<span lang="'.concat(n,'">').concat(t[n],"</span>")})),O.HTML.classList.remove("welcome"),e.open(),t.en?t.en.replace(/<[^>]*>/g,""):""},e.Cover=e.appendChild(sML.create("div",{id:"bibi-veil-cover"})),e.Cover.Info=e.Cover.appendChild(sML.create("p",{id:"bibi-veil-cover-info"})),E.dispatch("bibi:created-veil")}},I.Catcher={create:function(){if(!B.Data&&!S.book&&S["accept-local-file"]){var e=I.Catcher=O.Body.appendChild(sML.create("div",{id:"bibi-catcher"}));if(e.insertAdjacentHTML("afterbegin",I.distillLabels.distillLanguage({default:['<div class="pgroup" lang="en">',"<p><strong>Pass Me Your EPUB File!</strong></p>","<p><em>You Can Open Your Own EPUB.</em></p>","<p><span>Please ".concat(O.TouchOS?"Tap Screen":"Drag & Drop It Here. <br />Or Click Screen"," and Choose It.</span></p>"),"<p><small>(Open in Your Device without Uploading)</small></p>","</div>"].join(""),ja:['<div class="pgroup" lang="ja">',"<p><strong>EPUBファイルをここにください！</strong></p>","<p><em>お持ちの EPUB ファイルを<br />開くことができます。</em></p>","<p><span>".concat(O.TouchOS?"画面をタップ":"ここにドラッグ＆ドロップするか、<br />画面をクリック","して選択してください。</span></p>"),"<p><small>（外部に送信されず、この端末の中で開きます）</small></p>","</div>"].join("")})[O.Language]),e.title=e.querySelector("span").innerHTML.replace(/<br( ?\/)?>/g,"\n").replace(/<[^>]+>/g,"").trim(),e.Input=e.appendChild(sML.create("input",{type:"file"})),!S["extract-if-necessary"].includes("*")&&S["extract-if-necessary"].length){var t=[];S["extract-if-necessary"].includes(".epub")&&t.push("application/epub+zip"),S["extract-if-necessary"].includes(".zip")&&(t.push("application/zip"),t.push("application/x-zip"),t.push("application/x-zip-compressed")),t.length&&e.Input.setAttribute("accept",t.join(","))}e.Input.addEventListener("change",(function(e){var t={};try{t=e.target.files[0]}catch(e){}Bibi.getBookData.resolve({BookData:t})})),e.addEventListener("click",(function(t){return e.Input.click(t)})),O.TouchOS||(e.addEventListener("dragenter",(function(e){e.preventDefault(),O.HTML.classList.add("dragenter")}),1),e.addEventListener("dragover",(function(e){e.preventDefault()}),1),e.addEventListener("dragleave",(function(e){e.preventDefault(),O.HTML.classList.remove("dragenter")}),1),e.addEventListener("drop",(function(e){e.preventDefault();var t={};try{t=e.dataTransfer.files[0]}catch(e){}Bibi.getBookData.resolve({BookData:t})}),1)),e.appendChild(I.getBookIcon()),E.dispatch("bibi:created-catcher")}}},I.Menu={create:function(){S["use-menubar"]||O.HTML.classList.add("without-menubar");var e=I.Menu=O.Body.appendChild(sML.create("div",{id:"bibi-menu"},I.Menu));delete e.create,I.TouchObserver.setElementHoverActions(e),I.setToggleAction(e,{onopened:function(){O.HTML.classList.add("menu-opened"),E.dispatch("bibi:opened-menu")},onclosed:function(){O.HTML.classList.remove("menu-opened"),E.dispatch("bibi:closed-menu")}}),E.add("bibi:commands:open-menu",e.open),E.add("bibi:commands:close-menu",e.close),E.add("bibi:commands:toggle-menu",e.toggle),E.add("bibi:opens-utilities",(function(e){return E.dispatch("bibi:commands:open-menu",e)})),E.add("bibi:closes-utilities",(function(e){return E.dispatch("bibi:commands:close-menu",e)})),E.add("bibi:opened",e.close),O.TouchOS||E.add("bibi:opened",(function(){E.add("bibi:moved-pointer",(function(t){if(I.isPointerStealth())return!1;var n=O.getBibiEvent(t);clearTimeout(e.Timer_close),"top"==n.Division.Y?E.dispatch(e,"bibi:hovered",t):e.Hover&&(e.Timer_close=setTimeout((function(){return E.dispatch(e,"bibi:unhovered",t)}),123))}))})),e.L=e.appendChild(sML.create("div",{id:"bibi-menu-l"})),e.R=e.appendChild(sML.create("div",{id:"bibi-menu-r"})),[e.L,e.R].forEach((function(e){e.ButtonGroups=[],e.addButtonGroup=function(e){var t=I.createButtonGroup(e);return t?(this.ButtonGroups.push(t),this.appendChild(t)):null}}));var t="html.appearance-vertical:not(.veil-opened):not(.slider-opened)",n=" div#bibi-menu";sML.appendCSSRule(t+n,"width: calc(100% - "+O.Scrollbars.Width+"px);"),sML.appendCSSRule([t+".panel-opened"+n,t+".subpanel-opened"+n].join(", "),"padding-right: "+O.Scrollbars.Width+"px;"),I.OpenedSubpanel=null,I.Subpanels=[],e.Config.create(),E.dispatch("bibi:created-menu")}},I.Menu.Config={create:function(){var e=I.Menu,t=[];if(S["fix-reader-view-mode"]||t.push("ViewModeSection"),O.Embedded&&t.push("NewWindowButton"),O.FullscreenTarget&&!O.TouchOS&&t.push("FullscreenButton"),S["website-href"]&&/^https?:\/\/[^\/]+/.test(S["website-href"])&&S["website-name-in-menu"]&&t.push("WebsiteLink"),S["remove-bibi-website-link"]||t.push("BibiWebsiteLink"),t.length){var n=e.Config=sML.applyRtL(I.createSubpanel({id:"bibi-subpanel_config"}),e.Config);delete n.create;n.bindOpener(e.R.addButtonGroup({Sticky:!0}).addButton({Type:"toggle",Labels:{default:{default:"Configure Setting",ja:"設定を変更"},active:{default:"Close Setting-Menu",ja:"設定メニューを閉じる"}},Help:!0,Icon:'<span class="bibi-icon bibi-icon-config"></span>'}));t.includes("ViewModeSection")?n.ViewModeSection.create():delete n.ViewModeSection,t.includes("NewWindowButton")||t.includes("FullscreenButton")?n.WindowSection.create(t):delete n.WindowSection,t.includes("WebsiteLink")||t.includes("BibiWebsiteLink")?n.LinkageSection.create(t):delete n.LinkageSection,E.dispatch("bibi:created-config")}else delete I.Menu.Config}},I.Menu.Config.ViewModeSection={create:function(){var e,t,n=I.Menu.Config,i=(e='<span class="bibi-shape bibi-shape-spread">'.concat((t='<span class="bibi-shape bibi-shape-item"></span>')+t,"</span>"))+e+e,r=n.ViewModeSection=n.addSection({Labels:{default:{default:"View Mode",ja:"閲覧モード"}},ButtonGroups:[{ButtonType:"radio",Buttons:[{Mode:"paged",Labels:{default:{default:"Spread / Page",ja:"見開き／ページ"}},Icon:'<span class="bibi-icon bibi-icon-view bibi-icon-view-paged"><span class="bibi-shape bibi-shape-spreads bibi-shape-spreads-paged">'.concat(i,"</span></span>")},{Mode:"horizontal",Labels:{default:{default:'<span class="non-visual-in-label">⇄ </span>Horizontal Scroll',ja:'<span class="non-visual-in-label">⇄ </span>横スクロール'}},Icon:'<span class="bibi-icon bibi-icon-view bibi-icon-view-horizontal"><span class="bibi-shape bibi-shape-spreads bibi-shape-spreads-horizontal">'.concat(i,"</span></span>")},{Mode:"vertical",Labels:{default:{default:'<span class="non-visual-in-label">⇅ </span>Vertical Scroll',ja:'<span class="non-visual-in-label">⇅ </span>縦スクロール'}},Icon:'<span class="bibi-icon bibi-icon-view bibi-icon-view-vertical"><span class="bibi-shape bibi-shape-spreads bibi-shape-spreads-vertical">'.concat(i,"</span></span>")}].map((function(e){return sML.edit(e,{Notes:!0,action:function(){return R.changeView(e,{NoNotification:!0})}})}))},{Buttons:[{Name:"full-breadth-layout-in-scroll",Type:"toggle",Notes:!1,Labels:{default:{default:"Full Width for Each Page <small>(in Scrolling Mode)</small>",ja:"スクロール表示で各ページを幅一杯に</small>"}},Icon:'<span class="bibi-icon bibi-icon-full-breadth-layout"></span>',action:function(){var e="active"==this.UIState;S.update({"full-breadth-layout-in-scroll":e}),e?O.HTML.classList.add("book-full-breadth"):O.HTML.classList.remove("book-full-breadth"),"horizontal"!=S.RVM&&"vertical"!=S.RVM||R.changeView({Mode:S.RVM,Force:!0}),S["keep-settings"]&&O.Biscuits.memorize("Book",{FBL:S["full-breadth-layout-in-scroll"]})}}]}]});E.add("bibi:updated-settings",(function(){r.ButtonGroups[0].Buttons.forEach((function(e){return I.setUIState(e,e.Mode==S.RVM?"active":"default")}))})),E.add("bibi:updated-settings",(function(){var e=r.ButtonGroups[r.ButtonGroups.length-1];e.style.display="pre-paginated"==S.BRL?"":"none",e.Buttons.forEach((function(e){return I.setUIState(e,S[e.Name]?"active":"default")}))}))}},I.Menu.Config.WindowSection={create:function(e){var t=I.Menu.Config,n=[];(e.includes("NewWindowButton")&&n.push({Type:"link",Labels:{default:{default:"Open in New Window",ja:"あたらしいウィンドウで開く"}},Icon:'<span class="bibi-icon bibi-icon-open-newwindow"></span>',id:"bibi-button-open-newwindow",href:O.RequestedURL,target:"_blank"}),e.includes("FullscreenButton")&&(n.push({Type:"toggle",Labels:{default:{default:"Enter Fullscreen",ja:"フルスクリーンモード"},active:{default:"Exit Fullscreen",ja:"フルスクリーンモード解除"}},Icon:'<span class="bibi-icon bibi-icon-toggle-fullscreen"></span>',id:"bibi-button-toggle-fullscreen",action:function(){O.Fullscreen?O.FullscreenTarget.ownerDocument.exitFullscreen():O.FullscreenTarget.requestFullscreen(),t.close()}}),O.FullscreenTarget.ownerDocument.addEventListener("fullscreenchange",(function(){O.FullscreenButton||(O.FullscreenButton=document.getElementById("bibi-button-toggle-fullscreen")),this.fullscreenElement==O.FullscreenTarget?(O.Fullscreen=!0,O.HTML.classList.add("fullscreen"),I.setUIState(O.FullscreenButton,"active")):O.Fullscreen&&(O.Fullscreen=!1,O.HTML.classList.remove("fullscreen"),I.setUIState(O.FullscreenButton,"default"))}))),n.length)&&(t.WindowSection=t.addSection({Labels:{default:{default:"Window Control",ja:"ウィンドウ制御"}}})).addButtonGroup({Buttons:n})}},I.Menu.Config.LinkageSection={create:function(e){var t=I.Menu.Config,n=[];(e.includes("WebsiteLink")&&n.push({Type:"link",Labels:{default:{default:S["website-name-in-menu"].replace(/&/gi,"&amp;").replace(/</gi,"&lt;").replace(/>/gi,"&gt;")}},Icon:'<span class="bibi-icon bibi-icon-open-newwindow"></span>',href:S["website-href"],target:"_blank"}),e.includes("BibiWebsiteLink")&&n.push({Type:"link",Labels:{default:{default:"Bibi | Official Website"}},Icon:'<span class="bibi-icon bibi-icon-open-newwindow"></span>',href:Bibi.href,target:"_blank"}),n.length)&&(t.LinkageSection=t.addSection({Labels:{default:{default:"Link".concat(n.length>1?"s":""),ja:"リンク"}}})).addButtonGroup({Buttons:n})}},I.Panel={create:function(){var e=I.Panel=O.Body.appendChild(sML.create("div",{id:"bibi-panel"}));I.setToggleAction(e,{onopened:function(){O.HTML.classList.add("panel-opened"),E.dispatch("bibi:opened-panel")},onclosed:function(){O.HTML.classList.remove("panel-opened"),E.dispatch("bibi:closed-panel")}}),E.add("bibi:commands:open-panel",e.open),E.add("bibi:commands:close-panel",e.close),E.add("bibi:commands:toggle-panel",e.toggle),E.add("bibi:closes-utilities",e.close),I.setFeedback(e,{StopPropagation:!0}),E.add(e,"bibi:tapped",(function(){return E.dispatch("bibi:commands:toggle-panel")})),e.BookInfo=e.appendChild(sML.create("div",{id:"bibi-panel-bookinfo"})),e.BookInfo.Cover=e.BookInfo.appendChild(sML.create("div",{id:"bibi-panel-bookinfo-cover"})),e.BookInfo.Cover.Info=e.BookInfo.Cover.appendChild(sML.create("p",{id:"bibi-panel-bookinfo-cover-info"}));var t=e.Opener=I.Menu.L.addButtonGroup({Sticky:!0}).addButton({Type:"toggle",Labels:{default:{default:"Open Index",ja:"目次を開く"},active:{default:"Close Index",ja:"目次を閉じる"}},Help:!0,Icon:'<span class="bibi-icon bibi-icon-toggle-panel">'.concat(function(e){for(var t=1;t<=6;t++)e+="<span></span>";return e}(""),"</span>"),action:function(){return e.toggle()}});E.add("bibi:opened-panel",(function(){return I.setUIState(t,"active")})),E.add("bibi:closed-panel",(function(){return I.setUIState(t,"")})),E.add("bibi:started",(function(){return sML.style(t,{display:"block"})})),E.dispatch("bibi:created-panel")}},I.Help={create:function(){var e=I.Help=O.Body.appendChild(sML.create("div",{id:"bibi-help"}));e.Message=e.appendChild(sML.create("p",{className:"hidden",id:"bibi-help-message"})),e.show=function(t){clearTimeout(e.Timer_deactivate1),clearTimeout(e.Timer_deactivate2),e.classList.add("active"),e.Message.innerHTML=t,setTimeout((function(){return e.classList.add("shown")}),0)},e.hide=function(){e.Timer_deactivate1=setTimeout((function(){e.classList.remove("shown"),e.Timer_deactivate2=setTimeout((function(){return e.classList.remove("active")}),200)}),100)}}},I.PoweredBy={create:function(){I.PoweredBy=O.Body.appendChild(sML.create("div",{id:"bibi-poweredby",innerHTML:'<p><a href="'.concat(Bibi.href,'" target="_blank" title="Bibi | Official Website">Bibi</a></p>')}))}},I.FontSizeChanger={create:function(){var e=I.FontSizeChanger={};if(("number"!=typeof S["font-size-scale-per-step"]||S["font-size-scale-per-step"]<=1)&&(S["font-size-scale-per-step"]=1.25),S["use-font-size-changer"]&&S["keep-settings"]){var t=O.Biscuits.remember("Bibi");t&&t.FontSize&&null!=t.FontSize.Step&&(e.Step=1*t.FontSize.Step)}if(("number"!=typeof e.Step||e.Step<-2||2<e.Step)&&(e.Step=0),E.bind("bibi:postprocessed-item",(function(t){if("pre-paginated"==t.Ref["rendition:layout"])return!1;if(t.changeFontSize=function(e){t.FontSizeStyleRule&&sML.deleteCSSRule(t.contentDocument,t.FontSizeStyleRule),t.FontSizeStyleRule=sML.appendCSSRule(t.contentDocument,"html","font-size: "+e+"px !important;")},t.changeFontSizeStep=function(e){return t.changeFontSize(t.FontSize.Base*Math.pow(S["font-size-scale-per-step"],e))},t.FontSize={Default:1*getComputedStyle(t.HTML).fontSize.replace(/[^\d]*$/,"")},t.FontSize.Base=t.FontSize.Default,t.Preprocessed&&(sML.UA.Chrome||sML.UA.Trident)?sML.forEach(t.HTML.querySelectorAll("body, body *"))((function(e){return e.style.fontSize=parseInt(getComputedStyle(e).fontSize)/t.FontSize.Base+"rem"})):O.editCSSRules(t.contentDocument,(function(e){if(e&&e.selectorText&&!/^@/.test(e.selectorText)){try{if(t.contentDocument.querySelector(e.selectorText)==t.HTML)return}catch(e){}var n={pt:/ font-size: (\d[\d\.]*)pt; /,px:/ font-size: (\d[\d\.]*)px; /};n.pt.test(e.cssText)&&(e.style.fontSize=e.cssText.match(n.pt)[1]*(96/72)/t.FontSize.Base+"rem"),n.px.test(e.cssText)&&(e.style.fontSize=e.cssText.match(n.px)[1]/t.FontSize.Base+"rem")}})),"number"==typeof S["base-font-size"]&&S["base-font-size"]>0){var n=0,i={};sML.forEach(t.Body.querySelectorAll("p, p *"))((function(e){if(e.innerText.replace(/\s/g,"")){var t=Math.round(100*getComputedStyle(e).fontSize.replace(/[^\d]*$/,""))/100;i[t]||(i[t]=[]),i[t].push(e)}}));var r=0;for(var o in i)i[o].length>r&&(r=i[o].length,n=o);n&&(t.FontSize.Base=t.FontSize.Base*(S["base-font-size"]/n)),t.changeFontSizeStep(e.Step)}else 0!=e.Step&&t.changeFontSizeStep(e.Step)})),e.changeFontSizeStep=function(t,n){"pre-paginated"!=S.BRL&&t!=e.Step&&(n||(n={}),E.dispatch("bibi:changes-font-size"),"function"==typeof n.before&&n.before(),e.Step=t,S["use-font-size-changer"]&&S["keep-settings"]&&O.Biscuits.memorize("Book",{FontSize:{Step:t}}),setTimeout((function(){R.layOut({before:function(){return R.Items.forEach((function(e){e.changeFontSizeStep&&e.changeFontSizeStep(t)}))},Reset:!0,DoNotCloseUtilities:!0,NoNotification:!0}).then((function(){E.dispatch("bibi:changed-font-size",{Step:t}),"function"==typeof n.after&&n.after()}))}),88))},S["use-font-size-changer"]){var n=function(){var t=this;e.changeFontSizeStep(t.Step,{before:function(){return t.ButtonGroup.Busy=!0},after:function(){return t.ButtonGroup.Busy=!1}})};I.createSubpanel({Opener:I.Menu.R.addButtonGroup({Sticky:!0,id:"bibi-buttongroup_font-size"}).addButton({Type:"toggle",Labels:{default:{default:"Change Font Size",ja:"文字サイズを変更"},active:{default:"Close Font Size Menu",ja:"文字サイズメニューを閉じる"}},Icon:'<span class="bibi-icon bibi-icon-change-fontsize"></span>',Help:!0}),id:"bibi-subpanel_font-size",open:function(){}}).addSection({Labels:{default:{default:"Choose Font Size",ja:"文字サイズを選択"}}}).addButtonGroup({ButtonType:"radio",Buttons:[{Labels:{default:{default:'<span class="non-visual-in-label">Font Size:</span> Ex-Large',ja:'<span class="non-visual-in-label">文字サイズ：</span>最大'}},Icon:'<span class="bibi-icon bibi-icon-fontsize bibi-icon-fontsize-exlarge"></span>',action:n,Step:2},{Labels:{default:{default:'<span class="non-visual-in-label">Font Size:</span> Large',ja:'<span class="non-visual-in-label">文字サイズ：</span>大'}},Icon:'<span class="bibi-icon bibi-icon-fontsize bibi-icon-fontsize-large"></span>',action:n,Step:1},{Labels:{default:{default:'<span class="non-visual-in-label">Font Size:</span> Medium <small>(default)</small>',ja:'<span class="non-visual-in-label">文字サイズ：</span>中<small>（初期値）</small>'}},Icon:'<span class="bibi-icon bibi-icon-fontsize bibi-icon-fontsize-medium"></span>',action:n,Step:0},{Labels:{default:{default:'<span class="non-visual-in-label">Font Size:</span> Small',ja:'<span class="non-visual-in-label">文字サイズ：</span>小'}},Icon:'<span class="bibi-icon bibi-icon-fontsize bibi-icon-fontsize-small"></span>',action:n,Step:-1},{Labels:{default:{default:'<span class="non-visual-in-label">Font Size:</span> Ex-Small',ja:'<span class="non-visual-in-label">文字サイズ：</span>最小'}},Icon:'<span class="bibi-icon bibi-icon-fontsize bibi-icon-fontsize-exsmall"></span>',action:n,Step:-2}]}).Buttons.forEach((function(t){t.Step==e.Step&&I.setUIState(t,"active")}))}E.dispatch("bibi:created-font-size-changer")}},I.Loupe={create:function(){S["loupe-max-scale"]<=1&&(S["loupe-max-scale"]=4),S["loupe-scale-per-step"]<=1&&(S["loupe-scale-per-step"]=1.6),S["loupe-scale-per-step"]>S["loupe-max-scale"]&&(S["loupe-scale-per-step"]=S["loupe-max-scale"]);var e=I.Loupe={CurrentTransformation:{Scale:1,TranslateX:0,TranslateY:0},defineZoomOutPropertiesForUtilities:function(){var t=S["use-menubar"]&&S["use-full-height"]?I.Menu.Height:0,n="vertical"==S.ARA?I.Slider.Size:0,i="horizontal"==S.ARA?I.Slider.Size:0,r={};"horizontal"==S.ARA?(r.Scale=(R.Main.offsetHeight-(t+i))/(R.Main.offsetHeight-(S.ARA!=S.SLA||"paged"==S.RVM&&!I.Slider.ownerDocument?0:O.Scrollbars.Height)),r.TranslateX=0):(r.Scale=Math.min((R.Main.offsetWidth-n)/(R.Main.offsetWidth-O.Scrollbars.Width),(R.Main.offsetHeight-t)/R.Main.offsetHeight),r.TranslateX=R.Main.offsetWidth*(1-r.Scale)/-2),r.TranslateY=t-R.Main.offsetHeight*(1-r.Scale)/2;var o=O.Body["offset"+C.A_SIZE_L]/r.Scale-R.Main["offset"+C.A_SIZE_L],a={};a[C.A_BASE_B]=o/2+(S["use-full-height"]||"vertical"!=S.ARA?0:I.Menu.Height),a[C.A_BASE_A]=o/2;var s={};S.ARA==S.SLA&&(s["horizontal"==S.ARA?"Right":"Bottom"]=o/2),e.ZoomOutPropertiesForUtilities={Transformation:r,Stretch:o,OuterPadding:a,InnerPadding:s}},getNormalizedTransformation:function(t){var n=Object.assign({},e.CurrentTransformation);return t&&("number"==typeof t.Scale&&(n.Scale=t.Scale),"number"==typeof t.TranslateX&&(n.TranslateX=t.TranslateX),"number"==typeof t.TranslateY&&(n.TranslateY=t.TranslateY)),n},getActualTransformation:function(t){var n=e.getNormalizedTransformation(t);if(1==n.Scale&&e.IsZoomedOutForUtilities){var i=e.ZoomOutPropertiesForUtilities.Transformation;n.Scale*=i.Scale,n.TranslateX+=i.TranslateX,n.TranslateY+=i.TranslateY}return n},transform:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(i,r){t=e.getNormalizedTransformation(t);e.CurrentTransformation;if(e.Transforming=!0,clearTimeout(e.Timer_onTransformEnd),O.HTML.classList.add("transforming"),t.Scale>1){var o=window.innerWidth*(.5*(t.Scale-1)),a=window.innerHeight*(.5*(t.Scale-1));t.TranslateX=sML.limitMinMax(t.TranslateX,-1*o-("vertical"!=S.RVM?0:"active"==I.Slider.UIState?I.Slider.Size-O.Scrollbars.Width:0)+O.Scrollbars.Width,o),t.TranslateY=sML.limitMinMax(t.TranslateY,-1*a-("vertical"==S.RVM?0:"active"==I.Slider.UIState?I.Slider.Size-O.Scrollbars.Height:0)+O.Scrollbars.Height,a+("active"==I.Menu.UIState?I.Menu.Height:0))}e.CurrentTransformation=t;var s,c=e.getActualTransformation(t);sML.style(R.Main,{transform:(s=[],c.TranslateX&&c.TranslateY?s.push("translate("+c.TranslateX+"px, "+c.TranslateY+"px)"):c.TranslateX?s.push("translateX("+c.TranslateX+"px)"):c.TranslateY&&s.push("translateY("+c.TranslateY+"px)"),1!=c.Scale&&s.push("scale("+c.Scale+")"),s.length?s.join(" "):"")}),e.Timer_onTransformEnd=setTimeout((function(){1==e.CurrentTransformation.Scale?(O.HTML.classList.remove("zoomed-in"),O.HTML.classList.remove("zoomed-out")):e.CurrentTransformation.Scale<1?(O.HTML.classList.remove("zoomed-in"),O.HTML.classList.add("zoomed-out")):(O.HTML.classList.add("zoomed-in"),O.HTML.classList.remove("zoomed-out")),O.HTML.classList.remove("transforming"),e.Transforming=!1,i(),E.dispatch("bibi:transformed-book",{Transformation:t,ActualTransformation:c,Temporary:n.Temporary})}),345)}))},scale:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t="number"==typeof t?sML.limitMinMax(t,1,S["loupe-max-scale"]):1,n.Stepless||(t=Math.round(100*t)/100);var i=e.CurrentTransformation;if(t==i.Scale)return Promise.resolve();E.dispatch("bibi:changes-scale",t);var r=0,o=0;if(t<1)r=R.Main.offsetWidth*(1-t)/2,o=R.Main.offsetHeight*(1-t)/2;else if(t>1){if("active"!=e.UIState)return Promise.resolve();n.Center||(n.Center={X:window.innerWidth/2,Y:window.innerHeight/2}),r=i.TranslateX+(n.Center.X-window.innerWidth/2-i.TranslateX)*(1-t/i.Scale),o=i.TranslateY+(n.Center.Y-window.innerHeight/2-i.TranslateY)*(1-t/i.Scale)}return e.transform({Scale:t,TranslateX:r,TranslateY:o})},BookStretchingEach:0,transformToDefault:function(){return e.transform({Scale:1,TranslateX:0,TranslateY:0})},transformForUtilities:function(t){if(!e.isAvailable())return Promise.resolve();var n=function(){};if(t){if(e.IsZoomedOutForUtilities)return Promise.resolve();e.IsZoomedOutForUtilities=!0;var i=e.ZoomOutPropertiesForUtilities.OuterPadding,r=e.ZoomOutPropertiesForUtilities.InnerPadding;for(var o in i)R.Main.style["padding"+o]=i[o]+"px";for(var a in r)R.Main.Book.style["padding"+a]=r[a]+"px";e.BookStretchingEach=e.ZoomOutPropertiesForUtilities.Stretch/2}else{if(!e.IsZoomedOutForUtilities)return Promise.resolve();e.IsZoomedOutForUtilities=!1,n=function(){R.Main.style.padding=R.Main.Book.style.padding="",e.BookStretchingEach=0}}return e.transform(null,{Temporary:!0}).then(n).then((function(){return I.Slider.ownerDocument?I.Slider.progress():void 0}))},isAvailable:function(){return!!L.Opened&&"active"==e.UIState},checkAndGetBibiEventForTaps:function(t){if(!t||!e.isAvailable())return null;var n=O.getBibiEvent(t);if(n.Target.tagName){if(/bibi-menu|bibi-slider/.test(n.Target.id))return null;if(O.isPointableContent(n.Target))return null;if("horizontal"==S.RVM&&n.Coord.Y>window.innerHeight-O.Scrollbars.Height)return null}return n},onTap:function(t){if(!I.KeyObserver.ActiveKeys||!I.KeyObserver.ActiveKeys.Space)return Promise.resolve();var n=e.checkAndGetBibiEventForTaps(t);return n?e.scale(e.CurrentTransformation.Scale*(t.shiftKey?1/S["loupe-scale-per-step"]:S["loupe-scale-per-step"]),{Center:n.Coord}):Promise.resolve()},onDoubleTap:function(t){var n=e.checkAndGetBibiEventForTaps(t);if(!n)return Promise.resolve();if("center"!=n.Division.X||"middle"!=n.Division.Y)return Promise.resolve();t.preventDefault();try{t.target.ownerDocument.body.Item.contentWindow.getSelection().empty()}catch(e){}return e.CurrentTransformation.Scale>=S["loupe-max-scale"]?e.scale(1):e.scale(e.CurrentTransformation.Scale*S["loupe-scale-per-step"],{Center:n.Coord})},onPointerDown:function(t){e.PointerDownCoord=O.getBibiEvent(t).Coord,e.PointerDownTransformation={Scale:e.CurrentTransformation.Scale,TranslateX:e.CurrentTransformation.TranslateX,TranslateY:e.CurrentTransformation.TranslateY}},onPointerUp:function(t){O.HTML.classList.remove("dragging"),e.Dragging=!1,delete e.PointerDownCoord,delete e.PointerDownTransformation},onPointerMove:function(t){if(I.PinchObserver.Hot)return!1;if(!e.isAvailable())return!1;if(1==e.CurrentTransformation.Scale||!e.PointerDownCoord)return!1;t.preventDefault(),e.Dragging=!0,O.HTML.classList.add("dragging");var n=O.getBibiEvent(t);clearTimeout(e.Timer_TransitionRestore),sML.style(R.Main,{transition:"none"},{cursor:"move"}),e.transform({Scale:e.CurrentTransformation.Scale,TranslateX:e.PointerDownTransformation.TranslateX+(n.Coord.X-e.PointerDownCoord.X),TranslateY:e.PointerDownTransformation.TranslateY+(n.Coord.Y-e.PointerDownCoord.Y)}),e.Timer_TransitionRestore=setTimeout((function(){return sML.style(R.Main,{transition:""},{cursor:""})}),234)}};if(I.isPointerStealth.addChecker((function(){return!!e.Dragging||!(!I.KeyObserver.ActiveKeys||!I.KeyObserver.ActiveKeys.Space)})),I.setToggleAction(e,{onopened:function(){O.HTML.classList.add("loupe-active")},onclosed:function(){e.transformToDefault(),O.HTML.classList.remove("loupe-active")}}),E.add("bibi:commands:activate-loupe",(function(){return e.open()})),E.add("bibi:commands:deactivate-loupe",(function(){return e.close()})),E.add("bibi:commands:toggle-loupe",(function(){return e.toggle()})),E.add("bibi:commands:scale",(function(t){return e.scale(t)})),E.add("bibi:tapped",(function(t){return e.onTap(t)})),E.add("bibi:doubletapped",(function(t){return e.onDoubleTap(t)})),E.add("bibi:downed-pointer",(function(t){return e.onPointerDown(t)})),E.add("bibi:upped-pointer",(function(t){return e.onPointerUp(t)})),E.add("bibi:moved-pointer",(function(t){return e.onPointerMove(t)})),S["zoom-out-for-utilities"]&&(E.add("bibi:opens-utilities",(function(){return e.transformForUtilities(!0)})),E.add("bibi:closes-utilities",(function(){return e.transformForUtilities(!1)}))),E.add("bibi:opened",(function(){return e.open()})),E.add("bibi:laid-out",(function(){return e.defineZoomOutPropertiesForUtilities()})),E.add("bibi:changed-view",(function(){return e.transformToDefault()})),S["use-loupe"]){var t=I.Menu.R.addButtonGroup({Sticky:!0,Tiled:!0,id:"bibi-buttongroup_loupe",Buttons:[{Labels:{default:{default:"Zoom-in",ja:"拡大する"}},Icon:'<span class="bibi-icon bibi-icon-loupe bibi-icon-loupe-zoomin"></span>',Help:!0,action:function(){return e.scale(e.CurrentTransformation.Scale*S["loupe-scale-per-step"])},updateState:function(t){I.setUIState(this,"string"==typeof t?t:e.CurrentTransformation.Scale>=S["loupe-max-scale"]?"disabled":"default")}},{Labels:{default:{default:"Reset Zoom-in/out",ja:"元のサイズに戻す"}},Icon:'<span class="bibi-icon bibi-icon-loupe bibi-icon-loupe-reset"></span>',Help:!0,action:function(){return e.scale(1)},updateState:function(t){I.setUIState(this,"string"==typeof t?t:1==e.CurrentTransformation.Scale?"disabled":"default")}},{Labels:{default:{default:"Zoom-out",ja:"縮小する"}},Icon:'<span class="bibi-icon bibi-icon-loupe bibi-icon-loupe-zoomout"></span>',Help:!0,action:function(){return e.scale(e.CurrentTransformation.Scale/S["loupe-scale-per-step"])},updateState:function(t){I.setUIState(this,"string"==typeof t?t:e.CurrentTransformation.Scale<=1?"disabled":"default")}}]});e.updateButtonState=function(e){return t.Buttons.forEach((function(t){return t.updateState(e)}))},E.add("bibi:opened",(function(){return e.updateButtonState()})),E.add("bibi:transformed-book",(function(){return e.updateButtonState()}))}E.dispatch("bibi:created-loupe")}},I.Nombre={create:function(){if(S["use-nombre"]){var e=I.Nombre=O.Body.appendChild(sML.create("div",{id:"bibi-nombre",clearTimers:function(){clearTimeout(e.Timer_hot),clearTimeout(e.Timer_vanish),clearTimeout(e.Timer_autohide)},show:function(){e.clearTimers(),e.classList.add("active"),e.Timer_hot=setTimeout((function(){return e.classList.add("hot")}),10)},hide:function(){e.clearTimers(),e.classList.remove("hot"),e.Timer_vanish=setTimeout((function(){return e.classList.remove("active")}),255)},progress:function(t){if(e.clearTimers(),t||(t=I.PageObserver.Current),t.List.length){var n,i=t.List[0].Page.Index+1,r=t.List.slice(-1)[0].Page.Index+1,o=Math.floor(r/R.Pages.length*100);e.Current.innerHTML=(n=i,i!=r&&(n+='<span class="delimiter">-</span>'+r),n),e.Delimiter.innerHTML="/",e.Total.innerHTML=R.Pages.length,e.Percent.innerHTML="(".concat(o,'<span class="unit">%</span>)'),e.show(),"active"!=I.Slider.UIState&&(e.Timer_autohide=setTimeout(e.hide,1234))}}}));e.Current=e.appendChild(sML.create("span",{className:"bibi-nombre-current"})),e.Delimiter=e.appendChild(sML.create("span",{className:"bibi-nombre-delimiter"})),e.Total=e.appendChild(sML.create("span",{className:"bibi-nombre-total"})),e.Percent=e.appendChild(sML.create("span",{className:"bibi-nombre-percent"})),E.add("bibi:opened",(function(){return setTimeout((function(){e.progress(),E.add(["bibi:is-scrolling","bibi:scrolled","bibi:opened-slider"],(function(){return e.progress()})),E.add("bibi:closed-slider",e.hide)}),321)})),sML.appendCSSRule("html.view-paged div#bibi-nombre","bottom: "+(O.Scrollbars.Height+2)+"px;"),sML.appendCSSRule("html.view-horizontal div#bibi-nombre","bottom: "+(O.Scrollbars.Height+2)+"px;"),sML.appendCSSRule("html.view-vertical div#bibi-nombre","right: "+(O.Scrollbars.Height+2)+"px;"),E.dispatch("bibi:created-nombre")}}},I.History={List:[],Updaters:[],update:function(){return I.History.Updaters.forEach((function(e){return e()}))},add:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.UI||(e.UI=Bibi);var t=e.Destination?R.hatchPage(e.Destination):(I.PageObserver.updateCurrent(),I.PageObserver.Current.List[0].Page),n=R.hatchPage(I.History.List[I.History.List.length-1]);if(t!=n&&(e.SumUp&&I.History.List[I.History.List.length-1].UI==e.UI&&I.History.List.pop(),I.History.List.push({UI:e.UI,Item:t.Item,PageProgressInItem:t.IndexInItem/t.Item.Pages.length}),I.History.List.length-1>S["max-history"])){var i=I.History.List.shift();I.History.List.shift(),I.History.List.unshift(i)}I.History.update()},back:function(){if(I.History.List.length<=1)return Promise.reject();R.hatchPage(I.History.List.pop());var e=R.hatchPage(I.History.List[I.History.List.length-1]);return I.History.update(),R.focusOn({Destination:e,Duration:0})}},I.Slider={create:function(){if(!S["use-slider"])return!1;var e=I.Slider=O.Body.appendChild(sML.create("div",{id:"bibi-slider",RailProgressMode:"end",Size:I.Slider.Size,initialize:function(){var t=e.appendChild(sML.create("div",{id:"bibi-slider-edgebar-box"}));e.Edgebar=t.appendChild(sML.create("div",{id:"bibi-slider-edgebar"})),e.Rail=t.appendChild(sML.create("div",{id:"bibi-slider-rail"})),e.RailGroove=e.Rail.appendChild(sML.create("div",{id:"bibi-slider-rail-groove"})),e.RailProgress=e.RailGroove.appendChild(sML.create("div",{id:"bibi-slider-rail-progress"})),e.Thumb=t.appendChild(sML.create("div",{id:"bibi-slider-thumb",Labels:{default:{default:"Slider Thumb",ja:"スライダー上の好きな位置からドラッグを始められます"}}})),I.setFeedback(e.Thumb),S["use-history"]&&(e.classList.add("bibi-slider-with-history"),e.History=e.appendChild(sML.create("div",{id:"bibi-slider-history"})),e.History.add=function(t){return I.History.add({UI:e,SumUp:!1,Destination:t})},e.History.Button=e.History.appendChild(I.createButtonGroup()).addButton({id:"bibi-slider-history-button",Type:"normal",Labels:{default:{default:"History Back",ja:"移動履歴を戻る"}},Help:!1,Icon:'<span class="bibi-icon bibi-icon-history"></span>',action:function(){return I.History.back()},update:function(){this.Icon.style.transform="rotate(".concat(360*(I.History.List.length-1),"deg)"),I.History.List.length<=1?I.setUIState(this,"disabled"):"disabled"==this.UIState&&I.setUIState(this,"default")}}),I.History.Updaters.push((function(){return e.History.Button.update()}))),S["use-nombre"]&&(E.add(e.Edgebar,["mouseover","mousemove"],(function(t){e.Touching||I.Nombre.progress({List:[{Page:e.getPointedPage(O.getBibiEventCoord(t)[C.A_AXIS_L])}]})})),E.add(e.Edgebar,"mouseout",(function(t){e.Touching||I.Nombre.progress()}))),S["flip-pages-during-sliding"]||(e.flipPagesDuringSliding=function(){return!1})},resetUISize:function(){e.MainLength=R.Main["scroll"+C.L_SIZE_L];var t=R.Main["offset"+C.L_SIZE_L]/e.MainLength*100;e.RailGroove.style[C.A_SIZE_b]=e.Thumb.style[C.A_SIZE_b]="",e.RailGroove.style[C.A_SIZE_l]=100-("center"==e.RailProgressMode?t:0)+"%",e.Thumb.style[C.A_SIZE_l]=t+"%",setTimeout((function(){return e.Thumb.classList.toggle("min",(t=getComputedStyle(e.Thumb,"::after")).width==t.height);var t}),0),e.Edgebar.Before=O.getElementCoord(e.Edgebar)[C.A_AXIS_L],e.Edgebar.Length=e.Edgebar["offset"+C.A_SIZE_L],e.Edgebar.After=e.Edgebar.Before+e.Edgebar.Length,e.RailGroove.Before=O.getElementCoord(e.RailGroove)[C.A_AXIS_L],e.RailGroove.Length=e.RailGroove["offset"+C.A_SIZE_L],e.RailGroove.After=e.RailGroove.Before+e.RailGroove.Length,e.Thumb.Length=e.Thumb["offset"+C.A_SIZE_L]},onTouchStart:function(t){I.ScrollObserver.forceStopScrolling(),t.preventDefault(),e.History&&e.History.add({Page:I.PageObserver.Current.List[0].Page}),e.Touching=!0,e.StartedOn={ThumbBefore:O.getElementCoord(e.Thumb)[C.A_AXIS_L],RailProgressLength:e.RailProgress["offset"+C.A_SIZE_L],MainScrollBefore:Math.ceil(R.Main["scroll"+C.L_OOBL_L])},e.StartedOn.Coord=t.target==e.Thumb?O.getBibiEventCoord(t)[C.A_AXIS_L]:e.StartedOn.ThumbBefore+e.Thumb.Length/2,clearTimeout(e.Timer_onTouchEnd),O.HTML.classList.add("slider-sliding"),E.add("bibi:moved-pointer",e.onTouchMove)},onTouchMove:function(t){clearTimeout(e.Timer_move);var n=O.getBibiEventCoord(t)[C.A_AXIS_L],i=sML.limitMinMax(n-e.StartedOn.Coord,e.Edgebar.Before-e.StartedOn.ThumbBefore,e.Edgebar.After-(e.StartedOn.ThumbBefore+e.Thumb.Length));sML.style(e.Thumb,{transform:"translate"+C.A_AXIS_L+"("+i+"px)"}),sML.style(e.RailProgress,_defineProperty({},C.A_SIZE_l,e.StartedOn.RailProgressLength+i*("rtl"==S.ARD?-1:1)+"px")),e.flipPagesDuringSliding(n)},flipPagesDuringSliding:function(t){R.DoNotTurn=!0,e.flip(t),e.Timer_move=setTimeout((function(){R.DoNotTurn=!1,e.flip(t)}),123)},onTouchEnd:function(t){if(e.Touching){clearTimeout(e.Timer_move),e.Touching=!1,E.remove("bibi:moved-pointer",e.onTouchMove);var n=O.getBibiEventCoord(t)[C.A_AXIS_L];n==e.StartedOn.Coord&&(e.StartedOn.Coord=e.StartedOn.ThumbBefore+e.Thumb.Length/2),R.DoNotTurn=!1,e.flip(n).then((function(t){sML.style(e.Thumb,{transform:""}),sML.style(e.RailProgress,_defineProperty({},C.A_SIZE_l,"")),e.progress(),e.History&&e.History.add(t)})),delete e.StartedOn,e.Timer_onTouchEnd=setTimeout((function(){return O.HTML.classList.remove("slider-sliding")}),123)}},flip:function(t){return new Promise((function(n){switch(S.RVM){case"paged":var i=e.getPointedPage(t);return I.PageObserver.Current.Pages.includes(i)?n():R.focusOn({Destination:i,Duration:0});default:return R.Main["scroll"+C.L_OOBL_L]=e.StartedOn.MainScrollBefore+(t-e.StartedOn.Coord)*(e.MainLength/e.Edgebar.Length),n()}}))},progress:function(){if(!e.Touching){e.Thumb.style.top=e.Thumb.style.right=e.Thumb.style.bottom=e.Thumb.style.left="";var t=Math.ceil(R.Main["scroll"+C.L_OOBL_L]);S.ARA!=S.SLA&&"rtl"==S.ARD&&(t=e.MainLength-t-R.Main.offsetHeight),e.Thumb.style[C.A_OOBL_l]=t/e.MainLength*100+"%",e.RailProgress.style.width=e.RailProgress.style.height="";var n=O.getElementCoord(e.Thumb)[C.A_AXIS_L]-e.RailGroove.Before;e.RailProgress.style[C.A_SIZE_l]=("center"==e.RailProgressMode?"rtl"!=S.ARD?n+e.Thumb.Length/2:e.RailGroove.Length-(n+e.Thumb.Length/2):"rtl"!=S.ARD?n+e.Thumb.Length:e.RailGroove.Length-n)/e.RailGroove.Length*100+"%"}},getPointedPage:function(t){var n=(t-e.Edgebar.Before)/e.Edgebar["offset"+C.A_SIZE_L],i=sML.limitMinMax(Math.round(R.Pages.length*("rtl"==S.ARD?1-n:n)),0,R.Pages.length-1),r=R.Main["scroll"+C.L_SIZE_L]*("rtl"==S.ARD&&"ttb"==S.SLD?1-n:n),o=R.Pages[i],a=e.getPageDistanceFromPoint(o,r);return[-1,1].forEach((function(t){for(var n=i+t;R.Pages[n];n+=t){var s=R.Pages[n],c=e.getPageDistanceFromPoint(s,r);if(!(c<a))break;o=s,a=c}})),o},getPageDistanceFromPoint:function(e,t){return Math.abs(t-(O.getElementCoord(e,R.Main)[C.L_AXIS_L]+.5*e["offset"+C.L_SIZE_L]))}}));e.initialize(),I.setToggleAction(e,{onopened:function(){O.HTML.classList.add("slider-opened"),setTimeout(e.resetUISize,0),E.dispatch("bibi:opened-slider")},onclosed:function(){new Promise((function(e){return setTimeout(e,S["zoom-out-for-utilities"]?111:0)})),O.HTML.classList.remove("slider-opened"),setTimeout(e.resetUISize,0),E.dispatch("bibi:closed-slider")}}),E.add("bibi:commands:open-slider",e.open),E.add("bibi:commands:close-slider",e.close),E.add("bibi:commands:toggle-slider",e.toggle),E.add("bibi:opens-utilities",(function(e){return E.dispatch("bibi:commands:open-slider",e)})),E.add("bibi:closes-utilities",(function(e){return E.dispatch("bibi:commands:close-slider",e)})),E.add("bibi:loaded-item",(function(t){return t.HTML.addEventListener(E.pointerup,e.onTouchEnd)})),E.add("bibi:opened",(function(){e.Edgebar.addEventListener(E.pointerdown,e.onTouchStart),e.Thumb.addEventListener(E.pointerdown,e.onTouchStart),O.HTML.addEventListener(E.pointerup,e.onTouchEnd),e.History&&e.History.Button.addEventListener(E.pointerup,e.onTouchEnd),E.add("bibi:is-scrolling",e.progress),e.progress()})),E.add(["bibi:opened-slider","bibi:closed-slider","bibi:laid-out"],(function(){e.resetUISize(),e.progress()}));var t="div#bibi-slider",n="html.appearance-horizontal "+t,i=O.Scrollbars.Height,r=Math.ceil(i/2),o="html.appearance-vertical "+t,a=O.Scrollbars.Width,s=Math.ceil(a/2),c=function(e){return["top","right","bottom","left"].reduce((function(t,n){return t+n+": "+-1*e+"px; "}),"").trim()};sML.appendCSSRule(n,"height: "+i+"px;"),sML.appendCSSRule("html.appearance-horizontal div#bibi-slider-thumb:before",c(r)+" border-radius: "+r/2+"px; min-width: "+r+"px;"),sML.appendCSSRule(o,"width: "+a+"px;"),sML.appendCSSRule("html.appearance-vertical div#bibi-slider-thumb:before",c(s)+" border-radius: "+s/2+"px; min-height: "+s+"px;"),E.dispatch("bibi:created-slider")}},I.BookmarkManager={create:function(){if(S["use-bookmarks"]){var e=I.BookmarkManager={Bookmarks:[],initialize:function(){e.Subpanel=I.createSubpanel({Opener:I.Menu.L.addButtonGroup({Sticky:!0,id:"bibi-buttongroup_bookmarks"}).addButton({Type:"toggle",Labels:{default:{default:"Manage Bookmarks",ja:"しおりメニューを開く"},active:{default:"Close Bookmarks Menu",ja:"しおりメニューを閉じる"}},Icon:'<span class="bibi-icon bibi-icon-manage-bookmarks"></span>',Help:!0}),Position:"left",id:"bibi-subpanel_bookmarks",updateBookmarks:function(){return e.update()},onopened:function(){E.add("bibi:scrolled",e.Subpanel.updateBookmarks),e.Subpanel.updateBookmarks()},onclosed:function(){E.remove("bibi:scrolled",e.Subpanel.updateBookmarks)}}),e.ButtonGroup=e.Subpanel.addSection({id:"bibi-subpanel-section_bookmarks",Labels:{default:{default:"Bookmarks",ja:"しおり"}}}).addButtonGroup();var t=O.Biscuits.remember("Book","Bookmarks");Array.isArray(t)&&t.length&&(e.Bookmarks=t),delete e.initialize},exists:function(t){for(var n=e.Bookmarks.length,i=0;i<n;i++)if(e.Bookmarks[i].IIPP==t.IIPP)return e.Bookmarks[i];return null},add:function(t){if(e.exists(t))return e.update();t.IsHot=!0,e.Bookmarks.push(t),e.update({Added:t})},remove:function(t){e.Bookmarks=e.Bookmarks.filter((function(e){return e.IIPP!=t.IIPP})),e.update({Removed:t})},update:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.Subpanel.Opener.ButtonGroup.style.display="",e.ButtonGroup.Buttons&&(e.ButtonGroup.Buttons=[],e.ButtonGroup.innerHTML="");var n=[],i=[];if(Array.isArray(t.Bookmarks)&&(e.Bookmarks=t.Bookmarks),t.Added?n=[t.Added]:L.Opened&&(I.PageObserver.updateCurrent(),n=I.PageObserver.Current.Pages.map((function(e){return{IIPP:e.Item.Index+e.IndexInItem/e.Item.Pages.length,"%":Math.floor((e.Index+1)/R.Pages.length*100)}}))),e.Bookmarks.length){for(var r=[],o=function(t,o){var a=e.Bookmarks[o];if("number"==typeof a)a={IIPP:a};else{if(!a)return"continue";"number"!=typeof a.IIPP&&(a.ItemIndex?a.IIPP=a.ItemIndex+(a.PageProgressInItem?a.PageProgressInItem:0):"pre-paginated"==B.Package.Metadata["rendition:layout"]&&("number"==typeof a.PageNumber&&(a.PageIndex=a.PageNumber-1),"number"==typeof a.PageIndex&&(a.IIPP=a.PageIndex)))}if("number"!=typeof a.IIPP)return"continue";/^\d+(\.\d+)?$/.test(a["%"])?a["%"]*=1:delete a["%"];var s="",c="",l="bibi-bookmark",u=R.hatchPage(a),d=0;if(u&&"number"==typeof u.Index?d=u.Index+1:"pre-paginated"==B.Package.Metadata["rendition:layout"]&&(d=Math.floor(a.IIPP)+1),d&&(s+='<span class="'.concat(l,'-page"><span class="').concat(l,'-unit">P.</span><span class="').concat(l,'-number">').concat(d,"</span></span>"),R.Pages.length)){if(d>R.Pages.length)return"continue";s+='<span class="'.concat(l,'-total-pages">/<span class="').concat(l,'-number">').concat(R.Pages.length,"</span></span>"),a["%"]=Math.floor(d/R.Pages.length*100)}"number"==typeof a["%"]&&(s+=s?' <span class="'.concat(l,'-percent"><span class="').concat(l,'-parenthesis">(</span><span class="').concat(l,'-number">').concat(a["%"],'</span><span class="').concat(l,'-unit">%</span><span class="').concat(l,'-parenthesis">)</span></span>'):'<span class="'.concat(l,'-percent">')+'<span class="'.concat(l,'-number">').concat(a["%"],'</span><span class="').concat(l,'-unit">%</span>')+"</span>");var p=s?{default:{default:s,ja:s}}:{default:{default:"Bookmark #".concat(r.length+1),ja:"しおり #".concat(r.length+1)}};n.reduce((function(e,t){return a.IIPP==t.IIPP||e}),!1)&&(i.push(a),c="bibi-button-bookmark-is-current",p.default.default+=' <span class="'.concat(l,'-is-current"></span>'),p.default.ja+=' <span class="'.concat(l,"-is-current ").concat(l,'-is-current-ja"></span>'));var f=e.ButtonGroup.addButton({className:c,Type:"normal",Labels:p,Icon:'<span class="bibi-icon bibi-icon-bookmark bibi-icon-a-bookmark"></span>',Bookmark:a,action:function(){return L.Opened?R.focusOn({Destination:a}).then((function(t){return I.History.add({UI:e,SumUp:!1,Destination:t})})):!!L.Waiting&&(S["start-in-new-window"]?L.openNewWindow(location.href+(location.hash?",":"#")+"jo(iipp:"+a.IIPP+")"):(R.StartOn={IIPP:a.IIPP},void L.play()))},remove:function(){return e.remove(a)}}),g=f.appendChild(sML.create("span",{className:"bibi-remove-bookmark",title:"しおりを削除"}));I.setFeedback(g,{StopPropagation:!0}),E.add(g,"bibi:tapped",(function(){return f.remove()})),g.addEventListener(E["pointer-over"],(function(e){return e.stopPropagation()})),a.IsHot?(delete a.IsHot,I.setUIState(f,"active"),setTimeout((function(){return I.setUIState(f,i.includes(a)?"disabled":"default")}),234)):i.includes(a)?I.setUIState(f,"disabled"):I.setUIState(f,"default");var b={IIPP:a.IIPP};a["%"]&&(b["%"]=a["%"]),r.push(b)},a=e.Bookmarks.length,s=0;s<a;s++)o(a,s);e.Bookmarks=r}else L.Opened||(e.Subpanel.Opener.ButtonGroup.style.display="none");e.Bookmarks.length<S["max-bookmarks"]&&(e.AddButton=e.ButtonGroup.addButton({id:"bibi-button-add-a-bookmark",Type:"normal",Labels:{default:{default:"Add a Bookmark to Current Page",ja:"現在のページにしおりを挟む"}},Icon:'<span class="bibi-icon bibi-icon-bookmark bibi-icon-add-a-bookmark"></span>',action:function(){return!!n.length&&e.add(n[0])}}),n.length&&!i.length||I.setUIState(e.AddButton,"disabled")),O.Biscuits.memorize("Book",{Bookmarks:e.Bookmarks}),E.dispatch("bibi:updated-bookmarks",e.Bookmarks),t.Added&&E.dispatch("bibi:added-bookmark",e.Bookmarks),t.Removed&&E.dispatch("bibi:removed-bookmark",e.Bookmarks)}};e.initialize(),E.dispatch("bibi:created-bookmark-manager")}}},I.Flipper={create:function(){var e=I.Flipper={Back:{Distance:-1},Forward:{Distance:1},getDirection:function(e){switch(S.ARA){case"horizontal":return"center"!=e.X?e.X:e.Y;case"vertical":return"middle"!=e.Y?e.Y:e.X}},isAbleToFlip:function(e){if(L.Opened&&!I.OpenedSubpanel&&"number"==typeof e&&e&&(I.PageObserver.Current.List.length||I.PageObserver.updateCurrent(),I.PageObserver.Current.List.length)){var t,n,i;switch(e){case-1:t=I.PageObserver.Current.List[0],n=R.Pages[0],i="Headed";break;case 1:t=I.PageObserver.Current.List.slice(-1)[0],n=R.Pages.slice(-1)[0],i="Footed"}if(t.Page!=n)return!0;if(!t.PageIntersectionStatus.Contained&&!t.PageIntersectionStatus[i])return!0}return!1},flip:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};I.ScrollObserver.forceStopScrolling();var i=t==e.PreviousDistance;if(e.PreviousDistance=t,"pre-paginated"==S["book-rendition-layout"]){var r=[I.PageObserver.Current.List[0].Page.Index,I.PageObserver.Current.List.slice(-1)[0].Page.Index],o=r[t<0?0:1]+t;r.forEach((function(e){try{R.Pages[e].Spread.Box.classList.remove("current")}catch(e){}}));try{R.Pages[o].Spread.Box.classList.add("current")}catch(e){}}return R.moveBy({Distance:t,Duration:n.Duration}).then((function(t){return I.History.add({UI:e,SumUp:i,Destination:t})}))}};e[-1]=e.Back,e[1]=e.Forward}},I.Arrows={create:function(){if(!S["use-arrows"])return I.Arrows=null;var e,t=I.Arrows={navigate:function(){setTimeout((function(){[t.Back,t.Forward].forEach((function(e){return!!I.Flipper.isAbleToFlip(e.Distance)&&e.classList.add("glowing")})),setTimeout((function(){return[t.Back,t.Forward].forEach((function(e){return e.classList.remove("glowing")}))}),1234)}),400)},check:function(){[t.Back,t.Forward].forEach((function(e){return I.Flipper.isAbleToFlip(e.Distance)?sML.replaceClass(e,"unavailable","available"):sML.replaceClass(e,"available","unavailable")}))},areAvailable:function(e){if(!L.Opened)return!1;if(I.OpenedSubpanel)return!1;if(I.Panel&&"active"==I.Panel.UIState)return!1;if(e.Coord.X<=3||e.Coord.Y<=3)return!1;if("horizontal"==S.ARA){if(e.Coord.X>=window.innerWidth-3||e.Coord.Y>=window.innerHeight-O.Scrollbars.Height-3)return!1}else if("vertical"==S.ARA&&(e.Coord.Y>=window.innerHeight-3||e.Coord.X>=window.innerWidth-O.Scrollbars.Width-3))return!1;return e.Target.ownerDocument.documentElement!=O.HTML?!O.isPointableContent(e.Target):e.Target==O.HTML||e.Target==O.Body||e.Target==I.Menu||(!!/^(bibi-main|bibi-arrow|bibi-help|bibi-poweredby)/.test(e.Target.id)||!!/^(spread|item|page)( |-|$)/.test(e.Target.className))}};O.HTML.classList.add("arrows-active"),t.Back=O.Body.appendChild(sML.create("div",{className:"bibi-arrow",id:"bibi-arrow-back",Labels:{default:{default:"Back",ja:"戻る"}},Distance:-1})),t.Forward=O.Body.appendChild(sML.create("div",{className:"bibi-arrow",id:"bibi-arrow-forward",Labels:{default:{default:"Forward",ja:"進む"}},Distance:1})),t[-1]=t.Forward.Pair=I.Flipper.Back.Arrow=t.Back,t[1]=t.Back.Pair=I.Flipper.Forward.Arrow=t.Forward,[t.Back,t.Forward].forEach((function(e){I.setFeedback(e);var t=[e.showHelp,e.hideHelp,e.BibiTapObserver.onTap,e.BibiTapObserver.onDoubleTap];O.TouchOS||t.push(e.BibiHoverObserver.onHover,e.BibiHoverObserver.onUnHover),t.forEach((function(e){return function(){}}))})),E.add("bibi:commands:move-by",(function(e){if(!L.Opened||!e||"number"!=typeof e.Distance)return!1;var n=Math.round(e.Distance);return!!n&&E.dispatch(n<0?t.Back:t.Forward,"bibi:tapped",null)})),E.add("bibi:loaded-item",(function(e){sML.appendCSSRule(e.contentDocument,"html[data-bibi-cursor]","cursor: pointer;")})),E.add("bibi:opened",(function(){return setTimeout((function(){t.check(),t.navigate()}),123)})),E.add("bibi:changed-view",(function(){return t.navigate()})),E.add("bibi:scrolled",(function(){return t.check()})),E.dispatch("bibi:created-arrows"),(e=function(e,t,n){return sML.appendCSSRule("".concat(e," div#bibi-arrow-back, ").concat(e," div#bibi-arrow-forward"),"".concat(t,": calc(100% - ").concat(n,"px); ").concat(t,": calc(100v").concat(t.charAt(0)," - ").concat(n,"px);"))})("html.appearance-horizontal.book-full-height:not(.slider-opened)","height",O.Scrollbars.Width),e("html.appearance-horizontal:not(.book-full-height):not(.slider-opened)","height",O.Scrollbars.Width+I.Menu.Height),e("html.appearance-vertical:not(.slider-opened)","width",O.Scrollbars.Width)}},I.AxisSwitcher={create:function(){if(S["fix-reader-view-mode"])return I.AxisSwitcher=null;I.AxisSwitcher={switchAxis:function(){return new Promise((function(e){if("paged"==S.RVM)return e();var t="horizontal"==S.RVM?"vertical":"horizontal";I.Menu.Config.ViewModeSection.ButtonGroups[0].Buttons.filter((function(e){return e.Mode==t}))[0].BibiTapObserver.onTap(),e()}))}};E.dispatch("bibi:created-axis-switcher")}},I.Spinner={create:function(){for(var e=I.Spinner=O.Body.appendChild(sML.create("div",{id:"bibi-spinner"})),t=1;t<=12;t++)e.appendChild(document.createElement("span"));E.dispatch("bibi:created-spinner")}},I.createButtonGroup=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e.Area&&e.Area.tagName){var t=e.Area;return delete e.Area,t.addButtonGroup(e)}"string"==typeof e.className&&e.className||delete e.className,"string"==typeof e.id&&e.id||delete e.id;var n=["bibi-buttongroup"];e.Tiled&&n.push("bibi-buttongroup-tiled"),e.Sticky&&n.push("sticky"),e.className&&n.push(e.className),e.className=n.join(" ");var i=Array.isArray(e.Buttons)?e.Buttons:e.Button?[e.Button]:[];delete e.Buttons,delete e.Button;var r=sML.create("ul",e);return r.Buttons=[],r.addButton=function(e){var t=I.createButton(e);return t?(t.ButtonGroup=this,t.ButtonBox=t.ButtonGroup.appendChild(sML.create("li",{className:"bibi-buttonbox bibi-buttonbox-"+t.Type})),O.TouchOS||(I.TouchObserver.observeElementHover(t.ButtonBox),I.TouchObserver.setElementHoverActions(t.ButtonBox)),t.ButtonBox.appendChild(t),t.ButtonGroup.Buttons.push(t),t):null},i.forEach((function(t){!t.Type&&e.ButtonType&&(t.Type=e.ButtonType),r.addButton(t)})),r.Busy=!1,r},I.createButton=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"string"==typeof e.className&&e.className||delete e.className,"string"==typeof e.id&&e.id||delete e.id,e.Type="string"==typeof e.Type&&/^(normal|toggle|radio|link)$/.test(e.Type)?e.Type:"normal";var t=["bibi-button","bibi-button-"+e.Type];e.className&&t.push(e.className),e.className=t.join(" "),void 0===e.Icon||e.Icon.tagName||("string"==typeof e.Icon&&e.Icon?e.Icon=sML.hatch(e.Icon):delete e.Icon);var n=sML.create("string"==typeof e.href?"a":"span",e);return n.Icon&&(n.IconBox=n.appendChild(sML.create("span",{className:"bibi-button-iconbox"})),n.IconBox.appendChild(n.Icon),n.Icon=n.IconBox.firstChild,n.IconBox.Button=n.Icon.Button=n),n.Label=n.appendChild(sML.create("span",{className:"bibi-button-label"})),I.setFeedback(n,{Help:e.Help,Checked:e.Checked,StopPropagation:!0,PreventDefault:!n.href}),n.isAvailable=function(){return!n.Busy&&((!n.ButtonGroup||!n.ButtonGroup.Busy)&&"disabled"!=n.UIState)},"function"==typeof n.action&&E.add(n,"bibi:tapped",(function(){return n.isAvailable()?n.action.apply(n,_arguments):null})),n.Busy=!1,n},I.createSubpanel=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"string"==typeof e.className&&e.className||delete e.className,"string"==typeof e.id&&e.id||delete e.id;var t=["bibi-subpanel","bibi-subpanel-"+("left"==e.Position?"left":"right")];e.className&&t.push(e.className),e.className=t.join(" ");var n=Array.isArray(e.Sections)?e.Sections:e.Section?[e.Section]:[];delete e.Sections,delete e.Section;var i=O.Body.appendChild(sML.create("div",e));return i.Sections=[],i.addEventListener(E.pointerdown,(function(e){return e.stopPropagation()})),i.addEventListener(E.pointerup,(function(e){return e.stopPropagation()})),I.setToggleAction(i,{onopened:function(t){I.Subpanels.forEach((function(e){return e==i||e.close({ForAnotherSubpanel:!0})})),I.OpenedSubpanel=this,this.classList.add("opened"),O.HTML.classList.add("subpanel-opened"),i.Opener&&I.setUIState(i.Opener,"active"),e.onopened&&e.onopened.apply(i,arguments)},onclosed:function(t){this.classList.remove("opened"),I.OpenedSubpanel==this&&setTimeout((function(){return I.OpenedSubpanel=null}),222),t&&t.ForAnotherSubpanel||O.HTML.classList.remove("subpanel-opened"),i.Opener&&I.setUIState(i.Opener,"default"),e.onclosed&&e.onclosed.apply(i,arguments)}}),i.bindOpener=function(e){return E.add(e,"bibi:tapped",(function(){return i.toggle()})),i.Opener=e,i.Opener},i.Opener&&i.bindOpener(i.Opener),E.add("bibi:opened-panel",i.close),E.add("bibi:closes-utilities",i.close),I.Subpanels.push(i),i.addSection=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=I.createSubpanelSection(e);return t?(t.Subpanel=this,this.appendChild(t),this.Sections.push(t),t):null},n.forEach((function(e){return i.addSection(e)})),i},I.createSubpanelSection=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"string"==typeof e.className&&e.className||delete e.className,"string"==typeof e.id&&e.id||delete e.id;var t=["bibi-subpanel-section"];e.className&&t.push(e.className),e.className=t.join(" ");Array.isArray(e.PGroups)?e.PGroups:e.PGroup&&e.PGroup;delete e.PGroups,delete e.PGroup;var n=Array.isArray(e.ButtonGroups)?e.ButtonGroups:e.ButtonGroup?[e.ButtonGroup]:[];delete e.ButtonGroups,delete e.ButtonGroup;var i=sML.create("div",e);return i.Labels&&(i.Labels=I.distillLabels(i.Labels),i.appendChild(sML.create("div",{className:"bibi-hgroup"})).appendChild(sML.create("p",{className:"bibi-h"})).appendChild(sML.create("span",{className:"bibi-h-label",innerHTML:i.Labels.default[O.Language]}))),i.ButtonGroups=[],i.addButtonGroup=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=I.createButtonGroup(e);return this.appendChild(t),this.ButtonGroups.push(t),t},n.forEach((function(e){e&&i.addButtonGroup(e)})),i},I.setToggleAction=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return sML.edit(e,{UIState:"default",open:function(n){return new Promise((function(i){"default"==e.UIState&&(I.setUIState(e,"active"),t.onopened&&t.onopened.call(e,n)),i(n)}))},close:function(n){return new Promise((function(i){"active"==e.UIState&&(I.setUIState(e,"default"),t.onclosed&&t.onclosed.call(e,n)),i(n)}))},toggle:function(t){return"default"==e.UIState?e.open(t):e.close(t)}})},I.setFeedback=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.Labels=I.distillLabels(e.Labels),e.Labels&&(t.Help&&(e.showHelp=function(){return I.Help&&e.Labels[e.UIState]&&I.Help.show(e.Labels[e.UIState][O.Language]),e},e.hideHelp=function(){return I.Help&&I.Help.hide(),e}),e.Notes&&(e.note=function(){return e.Labels[e.UIState]&&setTimeout((function(){return I.note(e.Labels[e.UIState][O.Language])}),0),e})),O.TouchOS||(I.TouchObserver.observeElementHover(e),I.TouchObserver.setElementHoverActions(e)),I.TouchObserver.observeElementTap(e,t),I.TouchObserver.setElementTapActions(e),I.setUIState(e,t.Checked?"active":"default"),e},I.setUIState=function(e,t){if(t||(t="default"),e.PreviousUIState=e.UIState,t!=e.UIState)return e.UIState=t,e.tagName&&(e.Labels&&e.Labels[e.UIState]&&e.Labels[e.UIState][O.Language]&&(e.title=e.Labels[e.UIState][O.Language].replace(/<[^>]+>/g,""),e.Label&&(e.Label.innerHTML=e.Labels[e.UIState][O.Language])),sML.replaceClass(e,e.PreviousUIState,e.UIState)),e.UIState},I.isPointerStealth=function(){var e=!1;return I.isPointerStealth.Checkers.forEach((function(t){return e=!!t()||e})),e},I.isPointerStealth.Checkers=[],I.isPointerStealth.addChecker=function(e){return"function"!=typeof e||I.isPointerStealth.Checkers.includes(e)?I.isPointerStealth.Checkers.length:I.isPointerStealth.Checkers.push(e)},I.distillLabels=function(e){for(var t in"object"==_typeof(e)&&e||(e={}),e)e[t]=I.distillLabels.distillLanguage(e[t]);return e.default||(e.default=I.distillLabels.distillLanguage()),!e.active&&e.default&&(e.active=e.default),!e.disabled&&e.default&&(e.disabled=e.default),e},I.distillLabels.distillLanguage=function(e){return"object"==_typeof(e)&&e||(e={default:e}),"string"!=typeof e.default&&("string"==typeof e.en?e.default=e.en:"string"==typeof e[O.Language]?e.default=e[O.Language]:e.default=""),"string"!=typeof e[O.Language]&&("string"==typeof e.default?e[O.Language]=e.default:"string"==typeof e.en?e[O.Language]=e.en:e[O.Language]=""),e},I.orthogonal=function(e){return S["orthogonal-"+e]["paged"==S.RVM?0:1]},I.isScrollable=function(){return S.ARA==S.SLA&&1==I.Loupe.CurrentTransformation.Scale},I.getBookIcon=function(){return sML.create("div",{className:"book-icon",innerHTML:"<span></span>"})};var P={};Bibi.preset=function(e){return Bibi.at1st.List.push((function(){Bibi.applyFilteredSettingsTo(P,e,[Bibi.SettingTypes,Bibi.SettingTypes_PresetOnly],"Fill"),delete P.book,P.Script=document.getElementById("bibi-preset")}))},P.initialize=function(){var e,t,n=location.href.split("?")[0];P.bookshelf=((e=document.getElementById("bibi-preset").getAttribute("data-bibi-bookshelf"))?new URL(e,n):new URL(P.bookshelf||"../../bibi-bookshelf",P.Script.src)).href.replace(/\/$/,""),P.book=function(){if(!B.Data){var e=O.Body.getAttribute("data-bibi-book");if(e)return delete U.book,e}return""}(),P.extensions=((t=document.getElementById("bibi-preset").getAttribute("data-bibi-extensions"))&&(t=t.trim().replace(/\s+/," ").split(" ").map((function(e){return{src:new URL(e,n).href}}))).length&&(P.extensions=t),Array.isArray(P.extensions)?P.extensions.filter((function(e){if(e.hasOwnProperty("-spell-of-activation-")){var t=e["-spell-of-activation-"];if(!t||!/^[a-zA-Z0-9_\-]+$/.test(t)||!U.hasOwnProperty(t))return!1}return!(!e||!e.src||"string"!=typeof e.src)&&(e.src=new URL(e.src,P.Script.src).href)})):[]),delete P.initialize};var U={translateData:function(e){var t=_slicedToArray(e,2),n=t[0],i=t[1];switch(n){case"bbd":n="bibidi";break;case"paged":case"horizontal":case"vertical":i=n,n="reader-view-mode";break;case"view":case"rvm":n="reader-view-mode";break;case"dppd":case"default-ppd":n="default-page-progression-direction";break;case"pagination":n="pagination-method"}return[n,i]}};Bibi.at1st.List.unshift((function(){var e=location.search;"string"==typeof e&&(Object.assign(U,Bibi.applyFilteredSettingsTo({},e.replace(/^\?/,"").split("&").reduce((function(e,t){var n=_slicedToArray(t.split("="),2),i=n[0],r=n[1];switch(r||(r=void 0),i){case"log":r||(r="1");break;case"book":if(!r)return e;break;case"zine":case"wait":case"debug":r||(r="true");break;default:var o=_slicedToArray(U.translateData([i,r]),2);i=o[0],r=o[1]}return e[i]=r,e}),{}),[Bibi.SettingTypes,Bibi.SettingTypes_UserOnly])),U.book||delete U.zine,U.debug&&(Bibi.Debug=!0,U.log=9))})),U.initialize=function(){var e=Bibi.applyFilteredSettingsTo({},U,[Bibi.SettingTypes,Bibi.SettingTypes_UserOnly]),t=function(){var e=location.hash,t={};if("string"!=typeof e)return t;var n=e.match(new RegExp("([a-z_]+)\\(([^\\(\\)]+)\\)","g"));return n&&n.length?(n.forEach((function(e){var n=e.match(new RegExp("([a-z_]+)\\(([^\\(\\)]+)\\)"));t[n[1]]=n[2]})),t):t}();for(var n in t.bibi&&(t.bibi=U.initialize.parseDataString(t.bibi),delete t.bibi.book,e.Bibi=Bibi.applyFilteredSettingsTo({},t.bibi,[Bibi.SettingTypes,Bibi.SettingTypes_UserOnly]),Object.assign(e,e.Bibi)),t.jo&&(t.jo=U.initialize.parseDataString(t.jo),delete t.jo.book,e.Jo=Bibi.applyFilteredSettingsTo({},t.jo,[Bibi.SettingTypes,Bibi.SettingTypes_UserOnly]),Object.assign(e,e.Jo),history.replaceState&&history.replaceState(null,null,location.href.replace(/[\,#]jo\([^\)]*\)$/g,""))),t.epubcfi&&(U.epubcfi=t.epubcfi,E.add("bibi:readied",(function(){X.EPUBCFI&&(R.StartOn=X.EPUBCFI.getDestination(H.epubcfi))}))),e.Query={},U)"function"!=typeof U[n]&&(e.Query[n]=U[n]),U[n]=void 0,delete U[n];Object.assign(U,e),"number"==typeof U.nav?U.nav<1?delete U.nav:R.StartOn={Nav:U.nav}:"number"==typeof U.iipp&&(R.StartOn={IIPP:U.iipp})},U.initialize.parseDataString=function(e){var t={};return"string"==typeof e&&(e.replace(" ","").split(",").forEach((function(e){var n=U.translateData(e.split(":"));n&&void 0!==n[1]&&(t[n[0]]=n[1])})),t)};var S={initialize:function(){for(var e in S)"function"!=typeof S[e]&&delete S[e];sML.applyRtL(S,P,"ExceptFunctions"),sML.applyRtL(S,U,"ExceptFunctions"),Bibi.SettingTypes["yes-no"].concat(Bibi.SettingTypes_PresetOnly["yes-no"]).concat(Bibi.SettingTypes_UserOnly["yes-no"]).forEach((function(e){return S[e]="yes"==S[e]||"mobile"==S[e]&&O.TouchOS||"desktop"==S[e]&&!O.TouchOS})),S["trustworthy-origins"].includes(O.Origin)||S["trustworthy-origins"].unshift(O.Origin),S.book=!B.Data&&"string"==typeof S.book&&S.book?new URL(S.book,S.bookshelf+"/").href:"",B.Data||!S.book||S["trustworthy-origins"].includes(new URL(S.book).origin)||O.error("The Origin of the Path of the Book Is Not Allowed."),"number"!=typeof S["parent-bibi-index"]&&delete S["parent-bibi-index"],S.book||!window.File?(S["accept-local-file"]=!1,S["accept-blob-converted-data"]=!1,S["accept-base64-encoded-data"]=!1):S["accept-local-file"]=!(!S["accept-local-file"]||!(S["extract-if-necessary"].includes("*")||S["extract-if-necessary"].includes(".epub")||S["extract-if-necessary"].includes(".zip"))),S.autostart=!S.wait&&(!S.book||(window.parent!=window?S["autostart-embedded"]:S.autostart)),S["start-in-new-window"]=window.parent!=window&&!S.autostart&&S["start-embedded-in-new-window"],S["default-page-progression-direction"]="rtl"==S["default-page-progression-direction"]?"rtl":"ltr",["history","bookmarks"].forEach((function(e){0==S["max-"+e]&&(S["use-"+e]=!1),S["use-"+e]||(S["max-"+e]=0)})),S["use-menubar"]||(S["use-full-height"]=!0),(sML.UA.Trident||sML.UA.EdgeHTML)&&(S["pagination-method"]="auto"),S["reader-view-mode"]||(S["reader-view-mode"]="paged"),E.bind("bibi:initialized-book",(function(){var e=O.Biscuits.remember("Book");S["keep-settings"]&&(!U["reader-view-mode"]&&e.RVM&&(S["reader-view-mode"]=e.RVM),!U["full-breadth-layout-in-scroll"]&&e.FBL&&(S["full-breadth-layout-in-scroll"]=e.FBL)),S["resume-from-last-position"]&&!R.StartOn&&e.Position&&e.Position.IIPP&&(R.StartOn=sML.clone(e.Position))})),S.Modes={"book-rendition-layout":{SH:"BRL",CNP:"book"},"reader-view-mode":{SH:"RVM",CNP:"view"},"page-progression-direction":{SH:"PPD",CNP:"page"},"spread-layout-axis":{SH:"SLA",CNP:"spread"},"spread-layout-direction":{SH:"SLD",CNP:"spread"},"apparent-reading-axis":{SH:"ARA",CNP:"appearance"},"apparent-reading-direction":{SH:"ARD",CNP:"appearance"},"navigation-layout-direction":{SH:"NLD",CNP:"nav"}};var t=function(e){var t=S.Modes[e];Object.defineProperty(S,t.SH,{get:function(){return S[e]},set:function(t){return S[e]=t}}),delete t.SH};for(var n in S.Modes)t(n);E.dispatch("bibi:initialized-settings")},update:function(e){var t={};for(var n in S.Modes)t[n]=S[n];if("object"==_typeof(e))for(var i in e)"function"!=typeof S[i]&&(S[i]=e[i]);for(var r in S["book-rendition-layout"]=B.Package.Metadata["rendition:layout"],S["allow-placeholders"]=S["allow-placeholders"]&&B.AllowPlaceholderItems,S.FontFamilyStyleIndex&&sML.deleteCSSRule(S.FontFamilyStyleIndex),S["ui-font-family"]&&(S.FontFamilyStyleIndex=sML.appendCSSRule("html","font-family: "+S["ui-font-family"]+" !important;")),S["page-progression-direction"]=B.PPD,"x"==S["pagination-method"]?S["spread-layout-axis"]="vertical"==S["reader-view-mode"]?"vertical":"horizontal":S["spread-layout-axis"]=function(){if("paged"!=S["reader-view-mode"])return S["reader-view-mode"];if("reflowable"==S["book-rendition-layout"])switch(B.WritingMode){case"tb-rl":case"tb-lr":return"vertical"}return"horizontal"}(),S["apparent-reading-axis"]="paged"==S["reader-view-mode"]?"horizontal":S["reader-view-mode"],S["apparent-reading-direction"]="vertical"==S["reader-view-mode"]?"ttb":S["page-progression-direction"],S["spread-layout-direction"]="vertical"==S["spread-layout-axis"]?"ttb":S["page-progression-direction"],S["navigation-layout-direction"]=S["fix-nav-ttb"]||"rtl"!=S["page-progression-direction"]?"ttb":"rtl",S.Modes){var o=S.Modes[r].CNP+"-",a=o+t[r],s=o+S[r];a!=s&&O.HTML.classList.remove(a),O.HTML.classList.add(s)}C.update(),E.dispatch("bibi:updated-settings",S)}},C={update:function(){C.probe("L",S["spread-layout-axis"]),C.probe("A",S["apparent-reading-axis"]),C.DDD=function(){switch(S.PPD){case"ltr":return"ttb"!=S.ARD?{left:-1,right:1,top:"-1",bottom:"1"}:{left:"-1",right:"1",top:-1,bottom:1};case"rtl":return"ttb"!=S.ARD?{left:1,right:-1,top:"-1",bottom:"1"}:{left:"1",right:"-1",top:-1,bottom:1}}}()},probe:function(e,t){var n=["left","right"];"ltr"!=S.PPD&&n.reverse(),"horizontal"==t?(C._app(e,"BASE",{b:n[0],a:n[1],s:"top",e:"bottom"}),C._app(e,"SIZE",{b:"height",l:"width"}),C._app(e,"OOBL",{b:"top",l:"left"}),C._app(e,"AXIS",{b:"y",l:"x"}),C[e+"_AXIS_D"]="ltr"==S.PPD?1:-1):(C._app(e,"BASE",{b:"top",a:"bottom",s:n[0],e:n[1]}),C._app(e,"SIZE",{b:"width",l:"height"}),C._app(e,"OOBL",{b:"left",l:"top"}),C._app(e,"AXIS",{b:"x",l:"y"}),C[e+"_AXIS_D"]=1)},_app:function(e,t,n){for(var i in n)C[[e,t,i].join("_")]=n[i],C[[e,t,sML.capitalise(i)].join("_")]=sML.capitalise(n[i])},d2d:function(e,t){var n=C.DDD[e];return t?1*n:"number"==typeof n?n:0}},O={log:function(e,t,n){var i="",r="";switch(n?(i=t,r=n):/^<..>$/.test(t)?r=t:t&&(i=t),r){case"<e/>":throw"\n"+e;case"</g>":O.log.Depth--}if((e||i)&&(O.log.Depth<=O.log.Limit||"<b:>"==r||"</b>"==r||"<*/>"==r)){var o=O.log.Depth<=1?O.stamp(e):0,a=[],s=[];if(e)switch(r){case"<b:>":a.unshift("📕"),a.push("%c"+e),s.push(O.log.BStyle),a.push("%c(v".concat(Bibi.version,")")+(Bibi.Dev?":%cDEV":"")),s.push(O.log.NStyle),Bibi.Dev&&s.push(O.log.BStyle);break;case"</b>":a.unshift("📖"),a.push("%c"+e),s.push(O.log.BStyle),O.log.Limit&&(a.push("%c(".concat(Math.floor(o/1e3)+"."+(o%1e3+"").padStart(3,0),"sec)")),s.push(O.log.NStyle));break;case"<g:>":a.unshift("┌"),a.push(e);break;case"</g>":a.unshift("└"),a.push(e);break;default:a.unshift("-"),a.push(e)}for(var c=O.log.Depth;c>1;c--)a.unshift("│");a.unshift("%cBibi:"),s.unshift(O.log.NStyle),O.log.log("log",a,s,i)}switch(r){case"<g:>":O.log.Depth++}}};O.log.initialize=function(){if(parent&&parent!=window)return O.log=function(){return!0};O.log.Limit=U.hasOwnProperty("log")&&"number"==typeof(U.log*=1)?U.log:0,O.log.Depth=1,O.log.NStyle="font: normal normal 10px/1 Menlo, Consolas, monospace;",O.log.BStyle="font: normal bold   10px/1 Menlo, Consolas, monospace;",O.log.distill=sML.UA.Trident||sML.UA.EdgeHTML?function(e,t){return[e.join(" ").replace(/%c/g,"")]}:function(e,t){return[e.join(" ")].concat(t)},O.log.log=function(e,t,n,i){var r=O.log.distill(t,n);i&&r.push(i),console[e].apply(console,r)}},O.logSets=function(){var Repeats=[],Sets=[];Sets.length=1;for(var _len2=arguments.length,Args=new Array(_len2),_key2=0;_key2<_len2;_key2++)Args[_key2]=arguments[_key2];Args.reverse();for(var i=0;i<Args.length;i++)Array.isArray(Args[i])||(Args[i]=[Args[i]]),Repeats[i]=Sets.length,Sets.length=Sets.length*Args[i].length;Args.reverse(),Repeats.reverse();for(var _i6=0;_i6<Sets.length;_i6++)Sets[_i6]="";Args.forEach((function(e,t){for(var n=0;n<Sets.length;)e.forEach((function(e){for(var i=Repeats[t];i--;)Sets[n++]+=e}))})),Sets.forEach((function(Set){return console.log("- "+Set+": "+eval(Set))}))},O.error=function(e){return O.Busy=!1,O.HTML.classList.remove("busy"),O.HTML.classList.remove("loading"),O.HTML.classList.remove("waiting"),E.dispatch("bibi:x_x",e),O.log(e,"<e/>"),e},O.TimeCard={},O.getTimeLabel=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now()-Bibi.TimeOrigin;return[e/1e3/60/60,e/1e3/60%60,e/1e3%60].map((function(e){return(Math.floor(e)+"").padStart(2,0)})).join(":")+"."+(e%1e3+"").padStart(3,0)},O.stamp=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O.TimeCard,n=Date.now()-Bibi.TimeOrigin,i=O.getTimeLabel(n);return t[i]||(t[i]=[]),t[i].push(e),n},O.isToBeExtractedIfNecessary=function(e){if(!e||!S["extract-if-necessary"].length)return!1;if(S["extract-if-necessary"].includes("*"))return!0;if(S["extract-if-necessary"].includes(""))return!/(\.[\w\d]+)+$/.test(e);for(var t=S["extract-if-necessary"].length,n=0;n<t;n++)if(new RegExp(S["extract-if-necessary"][n].replace(/\./g,"\\.")+"$","i").test(e))return!0;return!1},O.item=function(e){if(!e.Path)throw"Item.Path Is Not Defined";return B.Package.Manifest.Items[e.Path]||(B.Package.Manifest.Items[e.Path]=e),B.Package.Manifest.Items[e.Path]},O.RangeLoader=null,O.cancelExtraction=function(e){try{return O.RangeLoader.abort(e.Path)}catch(e){}return!1},O.extract=function(e){return e=O.item(e),O.RangeLoader.getBuffer(e.Path).then((function(t){return O.isBin(e)?(e.DataType="Blob",e.Content=new Blob([t],{type:e["media-type"]})):(e.DataType="Text",e.Content=new TextDecoder("utf-8").decode(new Uint8Array(t))),e})).catch((function(){return Promise.reject()}))},O.download=function(e){return new Promise((function(t,n){if((e=O.item(e)).Content)return t(e);var i=O.isBin(e),r=new XMLHttpRequest,o=(/^([a-z]+:\/\/|\/)/.test(e.Path)?"":B.Path+"/")+e.Path;r.open("GET",o,!0),r.responseType=i?"blob":"text",r.onerror=function(){return n("".concat(404===r.status?"File Not Found":"Could Not Download File",': "').concat(o,'"'))},r.onloadend=function(){if(200!==r.status)return r.onerror();e.Content=r.response,e.DataType=i?"Blob":"Text",t(e)},r.send(null)}))},O.tryRangeRequest=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Bibi.Script.src,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0-0";return new Promise((function(n,i){var r=new XMLHttpRequest;r.onloadend=function(){return 206!=r.status?i():n()},r.open("GET",e,!0),r.setRequestHeader("Range","bytes="+t),r.send(null)}))},O.file=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(n,i){if(e=O.item(e),t.URI&&e.URI)return n(e);(function(){if(e.Content)return Promise.resolve(e);switch(B.ExtractionPolicy){case"at-once":return Promise.reject('File Not Included: "'.concat(e.Path,'"'));case"on-the-fly":return O.extract(e)}return O.download(e)})().then((function(e){return"function"==typeof t.initialize&&t.initialize(),t.Preprocess&&!e.Preprocessed?O.preprocess(e):e})).then((function(e){t.URI?O.getBlobURL(e).then((function(e){e.Content="",n(e)})):n(e)})).catch(i)}))},O.isBin=function(e){return/\.(aac|gif|jpe?g|m4[av]|mp[g34]|ogg|[ot]tf|pdf|png|web[mp]|woff2?)$/i.test(e.Path)},O.getBlobURL=function(e){return new Promise((function(t){(e=O.item(e)).URI||(e["media-type"]||(e["media-type"]=O.getContentType(e.Path)),e.URI=URL.createObjectURL("Blob"==e.DataType?e.Content:new Blob([e.Content],{type:e["media-type"]}))),t(e)}))},O.getDataURI=function(e){return new Promise((function(t){if((e=O.item(e)).URI)t(e);else if("Text"==e.DataType)e.URI="data:"+e["media-type"]+";base64,"+btoa(unescape(encodeURIComponent(e.Content))),t(e);else{var n=new FileReader;n.onload=function(){e.URI=n.result,t(e)},n.readAsDataURL(e.Content)}}))},O.ContentTypes={pdf:"application/pdf","xht(ml)?":"application/xhtml+xml",xml:"application/xml",aac:"audio/aac",mp3:"audio/mpeg",otf:"font/opentype",ttf:"font/truetype",woff:"font/woff",woff2:"font/woff2",gif:"image/gif","jpe?g":"image/jpeg",png:"image/png",svg:"image/svg+xml",webp:"image/webp",css:"text/css",js:"text/javascript","html?":"text/html",mp4:"video/mp4",webm:"video/webm"},O.getContentType=function(e){for(var t in O.ContentTypes)if(new RegExp("\\."+t+"$").test(e))return O.ContentTypes[t];return null},O.preprocess=function(e){e=O.item(e);var t=[],n=O.preprocess.getSetting(e.Path);if(!n)return Promise.resolve(e);var i=[];if(n.ReplaceRules&&(e.Content=n.ReplaceRules.reduce((function(e,t){return e.replace(t[0],t[1])}),e.Content)),n.ResolveRules){var r=e.Path.replace(/\/?[^\/]+$/,"");n.ResolveRules.forEach((function(n){return n.Patterns.forEach((function(o){var a=n.getRE(o.Attribute),s=e.Content.match(a);if(s){var c=new RegExp("\\.("+o.Extensions+")$","i");s.forEach((function(o){var s=o.replace(a,n.PathRef),l=O.getPath(r,(/^(\.*\/+|#)/.test(s)?"":"./")+s).split("#");if(c.test(l[0])){t.push(O.item({Path:l[0]}));var u=O.file({Path:l[0]},{Preprocess:!0,URI:!0});i.push(u.then((function(t){l[0]=t.URI,e.Content=e.Content.replace(o,o.replace(s,l.join("#")))})))}}))}}))}))}return Promise.all(i).then((function(){return e.Preprocessed=!0,e.ResItems=t,e}))},O.preprocess.getSetting=function(e){var t=O.preprocess.Settings;for(var n in t)if(new RegExp("\\.("+n+")$","i").test(e))return"function"==typeof t[n].init?t[n].init():t[n];return null},O.preprocess.Settings={css:{ReplaceRules:[[/\/\*[.\s\S]*?\*\/|[^\{\}]+\{\s*\}/gm,""]],ResolveRules:[{getRE:function(){return/@import\s+["'](?!(?:https?|data):)(.+?)['"]/g},PathRef:"$1",Patterns:[{Extensions:"css",ForceURI:!0}]},{getRE:function(){return/url\(["']?(?!(?:https?|data):)(.+?)['"]?\)/g},PathRef:"$1",Patterns:[{Extensions:"gif|png|jpe?g|svg|ttf|otf|woff"}]}],init:function(){var e=this.ReplaceRules;return e.push([/(-(epub|webkit)-)?column-count\s*:\s*1\s*([;\}])/gm,"column-count: auto$3"]),e.push([/(-(epub|webkit)-)?text-underline-position\s*:/gm,"text-underline-position:"]),sML.UA.Chromium||sML.UA.WebKit?this:(e.push([/-(epub|webkit)-/gm,""]),sML.UA.Gecko?(e.push([/text-combine-horizontal\s*:\s*([^;\}]+)\s*([;\}])/gm,"text-combine-upright: $1$2"]),e.push([/text-combine\s*:\s*horizontal\s*([;\}])/gm,"text-combine-upright: all$1"]),this):(sML.UA.EdgeHTML&&(e.push([/text-combine-(upright|horizontal)\s*:\s*([^;\}\s]+)\s*([;\}])/gm,"text-combine-horizontal: $2; text-combine-upright: $2$3"]),e.push([/text-combine\s*:\s*horizontal\s*([;\}])/gm,"text-combine-horizontal: all; text-combine-upright: all$1"])),sML.UA.Trident&&(e.push([/writing-mode\s*:\s*vertical-rl\s*([;\}])/gm,"writing-mode: tb-rl$1"]),e.push([/writing-mode\s*:\s*vertical-lr\s*([;\}])/gm,"writing-mode: tb-lr$1"]),e.push([/writing-mode\s*:\s*horizontal-tb\s*([;\}])/gm,"writing-mode: lr-tb$1"]),e.push([/text-combine-(upright|horizontal)\s*:\s*([^;\}\s]+)\s*([;\}])/gm,"-ms-text-combine-horizontal: $2$3"]),e.push([/text-combine\s*:\s*horizontal\s*([;\}])/gm,"-ms-text-combine-horizontal: all$1"])),/^(zho?|chi|kor?|ja|jpn)$/.test(B.Language)&&e.push([/text-align\s*:\s*justify\s*([;\}])/gm,"text-align: justify; text-justify: inter-ideograph$1"]),this))}},svg:{ReplaceRules:[[/<!--\s+[.\s\S]*?\s+-->/gm,""]],ResolveRules:[{getRE:function(e){return new RegExp("<\\??[a-zA-Z:\\-]+[^>]*? ("+e+")\\s*=\\s*[\"'](?!(?:https?|data):)(.+?)['\"]","g")},PathRef:"$2",Patterns:[{Attribute:"href",Extensions:"css",ForceURI:!0},{Attribute:"src",Extensions:"svg",ForceURI:!0},{Attribute:"src|xlink:href",Extensions:"gif|png|jpe?g"}]}]},"html?|xht(ml)?|xml":{ReplaceRules:[[/<!--\s+[.\s\S]*?\s+-->/gm,""]],ResolveRules:[{getRE:function(e){return new RegExp("<\\??[a-zA-Z:\\-]+[^>]*? ("+e+")\\s*=\\s*[\"'](?!(?:https?|data):)(.+?)['\"]","g")},PathRef:"$2",Patterns:[{Attribute:"href",Extensions:"css",ForceURI:!0},{Attribute:"src",Extensions:"js|svg",ForceURI:!0},{Attribute:"src|xlink:href",Extensions:"gif|png|jpe?g|mp([34]|e?g)|m4[av]"},{Attribute:"poster",Extensions:"gif|png|jpe?g"}]}]}},O.parseDocument=function(e){return(new DOMParser).parseFromString(e.Content,/\.(xml|opf|ncx)$/i.test(e.Path)?"text/xml":"text/html")},O.openDocument=function(e){return O.file(e).then(O.parseDocument).catch(O.error)},O.editCSSRules=function(){var e,t;"function"==typeof arguments[0]?(e=arguments[1],t=arguments[0]):"function"==typeof arguments[1]&&(e=arguments[0],t=arguments[1]),e||(e=document),e.styleSheets&&"function"==typeof t&&sML.forEach(e.styleSheets)((function(e){return O.editCSSRulesOfStyleSheet(e,t)}))},O.editCSSRulesOfStyleSheet=function(e,t){try{if(!e.cssRules)return}catch(e){return}for(var n=e.cssRules.length,i=0;i<n;i++){var r=e.cssRules[i];r.cssRules?O.editCSSRulesOfStyleSheet(r,t):r.styleSheet?O.editCSSRulesOfStyleSheet(r.styleSheet,t):t(r)}},O.getWritingMode=function(e){var t=getComputedStyle(e);return O.WritingModeProperty?/^vertical-/.test(t[O.WritingModeProperty])?("rtl"==t.direction?"bt":"tb")+"-"+(/-lr$/.test(t[O.WritingModeProperty])?"lr":"rl"):/^horizontal-/.test(t[O.WritingModeProperty])?("rtl"==t.direction?"rl":"lr")+"-"+(/-bt$/.test(t[O.WritingModeProperty])?"bt":"tb"):/^(lr|rl|tb|bt)-/.test(t[O.WritingModeProperty])?t[O.WritingModeProperty]:void 0:"rtl"==t.direction?"rl-tb":"lr-tb"},O.getElementInnerText=function(e){var t="InnerText",n=document.createElement("div");return n.innerHTML=e.innerHTML.replace(/ (src(set)?|source|(xlink:)?href)=/g," data-$1="),sML.forEach(n.querySelectorAll("svg"))((function(e){return e.parentNode.removeChild(e)})),sML.forEach(n.querySelectorAll("video"))((function(e){return e.parentNode.removeChild(e)})),sML.forEach(n.querySelectorAll("audio"))((function(e){return e.parentNode.removeChild(e)})),sML.forEach(n.querySelectorAll("img"))((function(e){return e.parentNode.removeChild(e)})),sML.forEach(n.querySelectorAll("script"))((function(e){return e.parentNode.removeChild(e)})),sML.forEach(n.querySelectorAll("style"))((function(e){return e.parentNode.removeChild(e)})),void 0!==n.textContent?t=n.textContent:void 0!==n.innerText&&(t=n.innerText),t.replace(/[\r\n\s\t ]/g,"")},O.getElementCoord=function(e,t){var n={X:e.offsetLeft,Y:e.offsetTop};for(t=t&&t.tagName?t:null;e.offsetParent!=t;)e=e.offsetParent,n.X+=e.offsetLeft,n.Y+=e.offsetTop;return n},O.getViewportZooming=function(){return document.body.clientWidth/window.innerWidth},O.getPath=function(){var e="",t=arguments[0];if(2==arguments.length&&/^[\w\d]+:\/\//.test(arguments[1]))t=arguments[1];else for(var n=arguments.length,i=1;i<n;i++)t+="/"+arguments[i];for(t.replace(/^([a-zA-Z]+:\/\/[^\/]+)?\/*(.*)$/,(function(n,i,r){e=i,t=r}));/([^:\/])\/{2,}/.test(t);)t=t.replace(/([^:\/])\/{2,}/g,"$1/");for(;/\/\.\//.test(t);)t=t.replace(/\/\.\//g,"/");for(;/[^\/]+\/\.\.\//.test(t);)t=t.replace(/[^\/]+\/\.\.\//g,"");return t=t.replace(/^(\.\/)+/g,""),e&&(t=e+"/"+t),t},O.fullPath=function(e){return B.Path+B.PathDelimiter+e},O.getViewportByMetaContent=function(e){if("string"==typeof e&&/width/.test(e)&&/height/.test(e)){var t=1*(e=e.replace(/\s+/g,"")).replace(/^.*?width=(\d+).*$/,"$1"),n=1*e.replace(/^.*?height=(\d+).*$/,"$1");if(!isNaN(t)&&!isNaN(n))return{Width:t,Height:n}}return null},O.getViewportByViewBox=function(e){if("string"==typeof e){var t=e.replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/);if(4==t.length){var n=1*t[2],i=1*t[3];if(!isNaN(n)&&!isNaN(i))return{Width:n,Height:i}}}return null},O.getViewportByImage=function(e){if(e&&/^img$/i.test(e.tagName)){var t=getComputedStyle(e);return{Width:parseInt(t.width),Height:parseInt(t.height)}}return null},O.getViewportByOriginalResolution=function(e){if("string"==typeof e){var t=e.replace(/\s+/,"").split("x");if(2==t.length){var n=1*t[0],i=1*t[1];if(!isNaN(n)&&!isNaN(i))return{Width:n,Height:i}}}return null},O.isPointableContent=function(e){for(;e;){if(/^(a|audio|video)$/i.test(e.tagName))return!0;e=e.parentElement}return!1},O.stopPropagation=function(e){return e.stopPropagation(),!1},O.preventDefault=function(e){return e.preventDefault(),!1},O.getBibiEvent=function(e){if(!e)return{};var t,n,i,r,o=O.getBibiEventCoord(e),a=S["flipper-width"],s={X:o.X/window.innerWidth,Y:o.Y/window.innerHeight};a<1?(r=t=a,n=i=1-a):(n=1-(r=a/window.innerWidth),i=1-(t=a/window.innerHeight));var c={};return c.X=s.X<r?"left":n<s.X?"right":"center",c.Y=s.Y<t?"top":i<s.Y?"bottom":"middle",{Target:e.target,Coord:o,Ratio:s,Division:c}},O.getBibiEventCoord=function(e){var t={X:0,Y:0};return/^touch/.test(e.type)?(t.X=e.changedTouches[0].pageX,t.Y=e.changedTouches[0].pageY):(t.X=e.pageX,t.Y=e.pageY),t=O.getCoordInViewport(t,e.target.ownerDocument)},O.getCoordInViewport=function(e,t){if(t==document)e.X-=O.Body.scrollLeft,e.Y-=O.Body.scrollTop;else{var n=R.Main,i=I.Loupe.CurrentTransformation||{Scale:1,TranslateX:0,TranslateY:0},r=i.Scale,o=n.offsetWidth/2,a=n.offsetHeight/2,s=i.TranslateX,c=i.TranslateY,l=t.documentElement.Item,u=l.Scale,d=O.getElementCoord(l,n);"pre-paginated"==l.Ref["rendition:layout"]||l.Outsourcing||(d.X+=S["item-padding-left"],d.Y+=S["item-padding-top"]),e.X=Math.floor(n.offsetLeft+(o+s+(d.X+e.X*u-n.scrollLeft-o)*r)),e.Y=Math.floor(n.offsetTop+(a+c+(d.Y+e.Y*u-n.scrollTop-a)*r))}return e},O.Cookies={Label:"bibi",remember:function(e){var t=JSON.parse(sML.Cookies.read(O.Cookies.Label)||"{}");return console.log("Cookies:",t),"string"==typeof e&&e?t[e]:t},eat:function(e,t,n){if("string"!=typeof e||!e)return!1;if("object"!=_typeof(t))return!1;var i=O.Cookies.remember();for(var r in"object"!=_typeof(i[e])&&(i[e]={}),t){var o=t[r];"function"!=typeof o&&(i[e][r]=o)}n||(n={}),n.Path=location.pathname.replace(/[^\/]+$/,""),n.Expires||(n.Expires=S["cookie-expires"]),sML.Cookies.write(O.Cookies.Label,JSON.stringify(i),n)}},O.Biscuits={Memories:{},Labels:{},initialize:function(e){if("string"!=typeof e)return O.Biscuits.__forget_about_cookies(),O.Biscuits.LabelBase="BibiBiscuits:"+P.Script.src.replace(new RegExp("^"+O.Origin.replace(/([\/\.])/g,"\\$1")),""),E.bind("bibi:initialized",(function(){return O.Biscuits.initialize("Bibi")})),E.bind("bibi:initialized-book",(function(){return O.Biscuits.initialize("Book")})),null;if("Bibi"!=e&&"Book"!=e)return null;var t=O.Biscuits.Labels[e]=O.Biscuits.LabelBase+("Book"==e?"#"+B.ID.replace(/^urn:uuid:/,""):""),n=localStorage.getItem(t);return O.Biscuits.Memories[t]=n?JSON.parse(n):{},O.Biscuits.Memories[t]},remember:function(e,t){if(!e||"string"!=typeof e||!O.Biscuits.Labels[e])return O.Biscuits.Memories;var n=O.Biscuits.Labels[e];return t&&"string"==typeof t?O.Biscuits.Memories[n][t]:O.Biscuits.Memories[n]},memorize:function(e,t){if(!e||"string"!=typeof e||!O.Biscuits.Labels[e])return!1;var n=O.Biscuits.Labels[e];if(t&&"object"==_typeof(t))for(var i in t){var r=t[i];try{if(!r||"function"==typeof r||void 0===JSON.parse(JSON.stringify(_defineProperty({},i,r)))[i])throw"";O.Biscuits.Memories[n][i]=r}catch(e){delete O.Biscuits.Memories[n][i]}}return localStorage.setItem(n,JSON.stringify(O.Biscuits.Memories[n]))},forget:function(e,t){if(e)if("string"==typeof e&&O.Biscuits.Labels[e]){var n=O.Biscuits.Labels[e];t?("string"==typeof t&&(t=[t]),Array.isArray(t)&&t.forEach((function(e){return!("string"!=typeof e||!e)&&delete O.Biscuits.Memories[n][e]})),localStorage.setItem(n,JSON.stringify(O.Biscuits.Memories[n]))):(localStorage.removeItem(n),delete O.Biscuits.Memories[n])}else;else localStorage.removeItem(O.Biscuits.Labels.Bibi),localStorage.removeItem(O.Biscuits.Labels.Book),O.Biscuits.Memories={};return O.Biscuits.Memories},__forget_about_cookies:function(){return setTimeout((function(){try{sML.Cookies.write(O.Cookies.Label,"",{Expires:0})}catch(e){}}),999)}};var E={initialize:function(){void 0!==document.onpointerdown?(E.pointerdown="pointerdown",E.pointermove="pointermove",E.pointerup="pointerup",E.pointerover="pointerover",E.pointerout="pointerout"):O.TouchOS&&void 0!==document.ontouchstart?(E.pointerdown="touchstart",E.pointermove="touchmove",E.pointerup="touchend"):(E.pointerdown="mousedown",E.pointermove="mousemove",E.pointerup="mouseup",E.pointerover="mouseover",E.pointerout="mouseout"),E.resize=O.TouchOS?"orientationchange":"resize",E.Cpt0Psv0={capture:!1,passive:!1},E.Cpt1Psv0={capture:!0,passive:!1},E.CustomEvents=new sML.CustomEvents("bibi"),E.add=function(e,t,n){var i=arguments;if(Array.isArray(arguments[0]))return arguments[0].forEach((function(e){return E.add(e,i[1],i[2],i[3])}));if(Array.isArray(arguments[1]))return arguments[1].forEach((function(e){return E.add(i[0],e,i[2],i[3])}));if(Array.isArray(arguments[2])&&"function"==typeof arguments[2][0])return arguments[2].forEach((function(e){return E.add(i[0],i[1],e,i[3])}));var r=document;return"function"!=typeof t&&(r=arguments[0],e=arguments[1],t=arguments[2],n=arguments[3]),/^bibi:/.test(e)?E.CustomEvents.add(r,e,t):r.addEventListener(e,t,n)},E.remove=function(e,t,n){var i=arguments;if(Array.isArray(arguments[0]))return arguments[0].forEach((function(e){return E.remove(e,i[1],i[2],i[3])}));if(Array.isArray(arguments[1]))return arguments[1].forEach((function(e){return E.remove(i[0],e,i[2],i[3])}));if(Array.isArray(arguments[2])&&"function"==typeof arguments[2][0])return arguments[2].forEach((function(e){return E.remove(i[0],i[1],e,i[3])}));var r=document;return"function"!=typeof t&&(r=arguments[0],e=arguments[1],t=arguments[2],n=arguments[3]),/^bibi:/.test(e)?E.CustomEvents.remove(r,e,t):r.removeEventListener(e,t,n)},E.bind=function(){return E.CustomEvents.bind.apply(E.CustomEvents,arguments)},E.unbind=function(){return E.CustomEvents.unbind.apply(E.CustomEvents,arguments)},E.dispatch=function(){return E.CustomEvents.dispatch.apply(E.CustomEvents,arguments)},delete E.initialize}},M={judge:function(e,t){return O.ParentBibi&&e&&"string"==typeof e&&t&&"string"==typeof t&&S["trustworthy-origins"].includes(t)},post:function(e){return!!M.judge(e,O.ParentOrigin)&&window.parent.postMessage(e,window.parent.location.origin)},receive:function(e){if(!e||!M.judge(e.data,e.origin))return!1;try{var t=JSON.parse(e.data);if(!t||"object"!=_typeof(t))return!1;for(var n in t)/^bibi:commands:/.test(n)&&E.dispatch(n,t[n]);return!0}catch(e){}return!1}},X={Extensions:[],Bibi:{},load:function(e){return new Promise((function(t,n){if(!e.src||"string"!=typeof e.src)return n('"path" of the Extension Seems to Be Invalid. ("'.concat(e.src,'")'));var i=new URL(e.src).origin;if(!S["trustworthy-origins"].includes(i))return n('The Origin Is Not Allowed. ("'.concat(e.src,'")'));e.Script=document.head.appendChild(sML.create("script",{className:"bibi-extension-script",src:e.src,Extension:e,resolve:t,reject:function(){n(),document.head.removeChild(this)}}))}))},add:function(e){var t=document.currentScript;if(void 0===e.id)return t.reject('"id" of the extension is undefined.');if("string"!=typeof e.id)return t.reject('"id" of the extension is invalid.');if(!e.id)return t.reject('"id" of the extension is blank.');if(X[e.id])return t.reject('"id" of the extension is reserved or already used by another. ("'.concat(e.id,'")'));t.setAttribute("data-bibi-extension-id",e.id),X[e.id]=t.Extension=sML.applyRtL(e,t.Extension),X[e.id].Index=X.Extensions.length,X.Extensions.push(X[e.id]),t.resolve(X[e.id]);var n=X[e.id];return function(e){return n&&"function"==typeof e&&E.bind("bibi:readied",(function(){return e.call(n,n)})),function(e){return n&&"function"==typeof e&&E.bind("bibi:prepared",(function(){return e.call(n,n)})),function(e){n&&"function"==typeof e&&E.bind("bibi:opened",(function(){return e.call(n,n)}))}}}}};Bibi.x=X.add}});