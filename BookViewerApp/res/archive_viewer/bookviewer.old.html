<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
</head>
<body>
    <div class="top">
        <canvas id="mainCanvas" />
    </div>

    <script type="application/json" id="info" style="display:none;">{info.json}</script>

    <script>
        class Page {
            constructor(image) {
                this.Path = image.folder + "/" + image.name;
                this.Data = image;
                this.IsLoading = false;
                this.IsLoaded = false;
                this.Image = null;
                this.Height = -1;
                this.Width = -1;
            }

            Load(callback) {
                if (this.IsLoaded) {
                    callback();
                    return;
                }
                const img = new Image();
                img.src = this.Path;
                this.IsLoading = true;
                cimage.onload = () => {
                    this.Image = img;
                    this.IsLoaded = true;
                    this.IsLoading = false;
                    this.Width = img.width;
                    this.Height = img.height;
                    callback();
                };
            }

            Free() {
                this.Image = null;
                this.IsLoaded = false;
                this.IsLoading = false;
            }
        }

        //class ZoomState {
        //    #isZoomed;

        //    constructor() {
        //        this.#Reset();
        //    }

        //    get IsZoomed() {
        //        return this.#isZoomed;
        //    }

        //    #Reset() {
        //        this.#isZoomed = false;
        //    }
        //}

        const topDiv = document.getElementsByClassName("top")[0];
        /*const zoomInfo = new ZoomState();*/

        const canvas = document.getElementById("mainCanvas");
        const ctx = canvas.getContext("2d");
        const info = JSON.parse(document.getElementById("info").innerText);
        const images = info.entries.filter(a => IsImage(a.name));

        const pageStaeteEnum = Object.freeze({
            "Full": 1,
            "Double": 2,
            "LeftHalf": 3,
            "RightHalf": 4,
        });
        const pageModeEnum = Object.freeze({
            "Simple": 1,
            "AutoDetect": 2,
            "Spread": 3,
            "Half": 4,
        });

        let pageCurrent = images.findIndex(x => (x.folder + "/" + x.name) == info.previewFile);
        let pageCurrentState = 0;
        window.addEventListener('resize', Draw, false);
        canvas.addEventListener("pointerdown", PointerDown, false)
        canvas.addEventListener("pointermove", PointerMove, false)
        canvas.addEventListener("pointerup", PointerUp, false)
        //canvas.addEventListener("click", Click, false)

        let startPoint;
        let shiftPoint = { "x": 0, "y": 0 };
        let currentImage = null;
        let lastClickTime = null;

        Draw();

        function PointerDown(event) {
            if (event.button != 0) return;
            startPoint = { "x": event.screenX, "y": event.screenY };
        }

        function PointerMove(event) {
            if (startPoint == null) return;
            shiftPoint = { "x": event.screenX - startPoint.x, "y": event.screenY - startPoint.y };
            Draw();
        }

        function PointerUp(event) {
            if (event.button != 0) return;
            const w = window.innerWidth;
            const x = event.screenX;
            const y = event.screenY;
            const spx = startPoint.x;
            const spy = startPoint.y;
            if (lastClickTime != null && (Date.now() - lastClickTime) < 300) {
                // Double click!
                return;
            }
            lastClickTime = Date.now();
            if (((x - spx) ** 2 + (y - spy) ** 2) < 100) {
                startPoint = null;
                if (x < w / 4) {
                    ShiftPage(+1);
                } else if (x >= w * 3 / 4) {
                    ShiftPage(-1);
                }
            } else {
                if ((x - spx) * 4 > w) {
                    ShiftPage(1);
                } else if ((x - spx) * 4 < -w) {
                    ShiftPage(-1);
                }
            }
            startPoint = null;
            shiftPoint = { "x": 0, "y": 0 };
            Draw();
        }

        function ShiftPage(shift) {
            const shifted = pageCurrent + shift;
            if (shifted >= 0 && shifted < images.length) {
                pageCurrent = shifted;
                currentImage = null;
                Draw();
            }
        }

        function OnResize() {
            startPoint = null;
            shiftPoint = { "x": 0, "y": 0 };
            Draw();
        }

        function Draw() {
            const w = window.innerWidth;
            const h = window.innerHeight;

            canvas.width = w;
            canvas.height = h;

            if (currentImage == null) {
                const image = images[pageCurrent];
                let cimage = new Image();
                cimage.src = image.folder + "/" + image.name;
                cimage.onload = () => {
                    currentImage = cimage;
                    Draw();
                };
            } else {
                const z = Math.min(w / currentImage.width, h / currentImage.height);
                const iw = currentImage.width * z;
                const ih = currentImage.height * z;
                ctx.drawImage(currentImage, (w - iw) / 2.0 + shiftPoint.x, Math.min(Math.max(0, (h - ih) / 2.0 + shiftPoint.y), h - ih), iw, ih);
            }
        }

        function IsImage(f) {
            const li = f.lastIndexOf(".");
            const ext = li < 0 ? "" : f.substring(li);

            switch (ext.toUpperCase()) {
                case ".JPEG":
                case ".JPG":
                case ".JFIF":
                case ".PJPEG":
                case ".PJP":
                case ".SVG":
                case ".GIF":
                case ".WEBP":
                case ".PNG":
                case ".APNG":
                case ".AVIF":
                case ".BMP":
                case ".ICO":
                case ".CUR":
                case ".TIF":
                case ".TIFF":
                    return true;
                    break;
                default:
                    return false;
            }
        }
    </script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
        }

        .top {
            display: grid;
            width: 100%;
            height: 100%;
            grid-template: auto 1fr auto;
        }

            .top > #mainCanvas {
                width: 100%;
                height: 100%;
                grid-row: 1/4;
            }
    </style>
</body>
</html>